<!DOCTYPE html><html><head><meta charset="utf-8"><meta name="X-UA-Compatible" content="IE=edge"><title> Running Mapreduce over Openstack Swift · Liqun's Homepage</title><meta name="description" content="Running Mapreduce over Openstack Swift - Liqun Li"><meta name="viewport" content="width=device-width, initial-scale=1"><link rel="icon" href="/blog/favicon2.jpeg"><link rel="stylesheet" href="/blog/css/apollo.css"><link rel="search" type="application/opensearchdescription+xml" href="liqul.github.io/blog/atom.xml" title="Liqun's Homepage"></head><body><div class="wrap"><header><a href="/blog/" class="logo-link"><img src="/blog/favicon2.jpeg" alt="logo"></a><ul class="nav nav-list"><li class="nav-list-item"><a href="/blog/" target="_self" class="nav-list-link">BLOG</a></li><li class="nav-list-item"><a href="/blog/archives" target="_self" class="nav-list-link">TAGS/ARCHIVE</a></li><li class="nav-list-item"><a href="/blog/about" target="_self" class="nav-list-link">ABOUT</a></li><li class="nav-list-item"><a href="/blog/atom.xml" target="_self" class="nav-list-link">RSS</a></li></ul></header><main class="container"><div class="post"><article class="post-block"><h1 class="post-title">Running Mapreduce over Openstack Swift</h1><div class="post-info">Feb 13, 2017</div><div class="post-content"><p>I recently got a chance of experimenting mapreduce over several opensource object storages. Openstack swift is definitely one well known object storage service. However, I found it non-trivial to set it up for evaluation. Therefore, I put some notes below. </p>
<p>This article is only for os=Ubuntu 14.04 and swift=liberty. I noticed that the newer versions of swift is with much better documentation, which is much easier to follow. The appendix contains my early trials of installing swift from source.  </p>
<h2><span id="read-the-followings">Read the followings</span></h2><ul>
<li><a href="http://stackoverflow.com/questions/19004503/the-relationship-between-endpoints-regions-etc-in-keystone-openstack" target="_blank" rel="noopener">http://stackoverflow.com/questions/19004503/the-relationship-between-endpoints-regions-etc-in-keystone-openstack</a></li>
<li>Part 1. Fundamentals and Architecture in “Openstack Swift - Using, Administering, and Developing for Swift Object Storage”</li>
</ul>
<p>Make sure you have some sense for concepts including user, role, tenant, project, endpoint, proxy server, account server, object server, rings, and etc.</p>
<p>To my understanding, they are:</p>
<ul>
<li>user: a real user, or a service</li>
<li>role: role of users, corresponding to a set of permissions</li>
<li>tenant = project: a set of users</li>
<li>endpoint: the entry point urls of openstack services</li>
<li>proxy server: handling user requests in swift</li>
<li>account server: handling user account in swift, also used as domain or primary namespace </li>
<li>object server: handling object storage in swift</li>
<li>rings: the consistent hashing algorithm used by swift</li>
<li>keystone: the authentication service in openstack. Key concepts on keystone can be found <a href="http://docs.openstack.org/admin-guide/identity-concepts.html" target="_blank" rel="noopener">here</a></li>
</ul>
<h2><span id="setup-keynote-and-swift">Setup keynote and swift</span></h2><h3><span id="install-dependencies">Install dependencies</span></h3><ul>
<li><p>Install MariaDB (or MySQL) and memcache following <a href="https://www.server-world.info/en/note?os=Ubuntu_14.04&amp;p=openstack_liberty&amp;f=2" target="_blank" rel="noopener">page</a></p>
</li>
<li><p>Install keystone following <a href="https://www.server-world.info/en/note?os=Ubuntu_14.04&amp;p=openstack_liberty&amp;f=3" target="_blank" rel="noopener">page1</a> and <a href="https://www.server-world.info/en/note?os=Ubuntu_14.04&amp;p=openstack_liberty&amp;f=4" target="_blank" rel="noopener">page2</a>. Note that if you want to run mapreduce over swift, you can <em>not</em> use the TempAuth approach. Read this <a href="https://issues.apache.org/jira/browse/HADOOP-10420" target="_blank" rel="noopener">page</a> for more details. </p>
</li>
<li><p>Install swift following <a href="https://www.server-world.info/en/note?os=Ubuntu_14.04&amp;p=openstack_liberty2&amp;f=3" target="_blank" rel="noopener">page1</a>, <a href="https://www.server-world.info/en/note?os=Ubuntu_14.04&amp;p=openstack_liberty2&amp;f=4" target="_blank" rel="noopener">page2</a>, and <a href="https://www.server-world.info/en/note?os=Ubuntu_14.04&amp;p=openstack_liberty2&amp;f=5" target="_blank" rel="noopener">page3</a>. You can start the swift service with </p>
</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">swift-init all start</span><br></pre></td></tr></table></figure>
<h3><span id="setup-hadoop">Setup Hadoop</span></h3><ul>
<li>Setup Hadoop with version &gt;= 2.3 and configure it following <a href="http://spark.apache.org/docs/latest/storage-openstack-swift.html" target="_blank" rel="noopener">page1</a> and <a href="https://github.com/zioproto/hadoop-swift-tutorial" target="_blank" rel="noopener">page2</a>.</li>
<li>Make sure SwiftNativeFileSystem is in the classpath, read this <a href="https://github.com/zioproto/hadoop-swift-tutorial" target="_blank" rel="noopener">page</a> for any problem you find.</li>
<li>Configure etc/hadoop/core-site.xml，add following contents:</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line">&lt;configuration&gt;</span><br><span class="line">  &lt;property&gt;</span><br><span class="line">    &lt;name&gt;fs.swift.impl&lt;/name&gt;</span><br><span class="line">    &lt;value&gt;org.apache.hadoop.fs.swift.snative.SwiftNativeFileSystem&lt;/value&gt;</span><br><span class="line">  &lt;/property&gt;</span><br><span class="line">  &lt;property&gt;</span><br><span class="line">    &lt;name&gt;fs.swift.service.SwiftTest.auth.url&lt;/name&gt; &lt;---SwiftTest is the name of the service</span><br><span class="line">    &lt;value&gt;http://127.0.0.1:5000/v2.0/tokens&lt;/value&gt; &lt;---the ip:port should point to keystone. Make sure having &quot;/tokens&quot; there.</span><br><span class="line">  &lt;/property&gt;</span><br><span class="line">  &lt;property&gt;</span><br><span class="line">    &lt;name&gt;fs.swift.service.SwiftTest.auth.endpoint.prefix&lt;/name&gt;</span><br><span class="line">    &lt;value&gt;/AUTH_&lt;/value&gt;</span><br><span class="line">  &lt;/property&gt;</span><br><span class="line">  &lt;property&gt;</span><br><span class="line">    &lt;name&gt;fs.swift.service.SwiftTest.http.port&lt;/name&gt;</span><br><span class="line">    &lt;value&gt;8080&lt;/value&gt; &lt;--- the same with that in proxy-server.conf</span><br><span class="line">  &lt;/property&gt;</span><br><span class="line">  &lt;property&gt;</span><br><span class="line">    &lt;name&gt;fs.swift.service.SwiftTest.region&lt;/name&gt;</span><br><span class="line">    &lt;value&gt;RegionOne&lt;/value&gt;</span><br><span class="line">  &lt;/property&gt;</span><br><span class="line">  &lt;property&gt;</span><br><span class="line">    &lt;name&gt;fs.swift.service.SwiftTest.public&lt;/name&gt;</span><br><span class="line">    &lt;value&gt;true&lt;/value&gt;</span><br><span class="line">  &lt;/property&gt;</span><br><span class="line">  &lt;property&gt;</span><br><span class="line">    &lt;name&gt;fs.swift.service.SwiftTest.tenant&lt;/name&gt;</span><br><span class="line">    &lt;value&gt;admin&lt;/value&gt; &lt;--- name of the project, not the role!</span><br><span class="line">  &lt;/property&gt;</span><br><span class="line">  &lt;property&gt;</span><br><span class="line">    &lt;name&gt;fs.swift.service.SwiftTest.username&lt;/name&gt;</span><br><span class="line">    &lt;value&gt;admin&lt;/value&gt; &lt;--- user name</span><br><span class="line">  &lt;/property&gt;</span><br><span class="line">  &lt;property&gt;</span><br><span class="line">    &lt;name&gt;fs.swift.service.SwiftTest.password&lt;/name&gt;</span><br><span class="line">    &lt;value&gt;adminpassword&lt;/value&gt; &lt;--- password</span><br><span class="line">  &lt;/property&gt;</span><br><span class="line">&lt;/configuration&gt;</span><br></pre></td></tr></table></figure>
<h3><span id="verify-all-setup">Verify all setup</span></h3><ul>
<li>create a container (swift post nameofcontainer). Important! the name should be only consist of letters. No ‘_’ is allowed.</li>
<li>upload a file (swift upload nameofcontainer nameoffile).</li>
<li>hdfs dfs -ls swift://nameofcontainer.SwiftTest/. This should show you files you uploaded previously.</li>
<li>hadoop distcp nameoffile swift://mycontainer.SwiftTest/nameoffile</li>
</ul>
<h2><span id="appendix-install-swift-from-source">Appendix: Install swift from source</span></h2><h3><span id="dependencies">Dependencies</span></h3><h4><span id="from-the-swift-book">From the swift book</span></h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">apt-get install git curl gcc memcached rsync sqlite3 xfsprogs \</span><br><span class="line">git-core libffi-dev python-setuptools</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">apt-get install python-coverage python-dev python-nose \</span><br><span class="line">python-simplejson python-xattr python-eventlet \</span><br><span class="line">python-greenlet python-pastedeploy python-netifaces \</span><br><span class="line">python-pip python-dnspython python-mock</span><br></pre></td></tr></table></figure>
<h4><span id="install-the-latest-liberasurecode-as-per-some-post-may-not-be-necessary">Install the latest liberasurecode (as per some post, may not be necessary)</span></h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">sudo apt-get install build-essential autoconf automake libtool</span><br><span class="line">cd /opt/</span><br><span class="line">git clone https://github.com/openstack/liberasurecode.git</span><br><span class="line">cd liberasurecode</span><br><span class="line">./autogen.sh</span><br><span class="line">./configure</span><br><span class="line">make</span><br><span class="line">make test</span><br><span class="line">sudo make install</span><br></pre></td></tr></table></figure>
<h3><span id="install-the-swift-cli">Install the Swift CLI</span></h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">cd /opt</span><br><span class="line">git clone https://github.com/openstack/python-swiftclient.git</span><br><span class="line">cd /opt/python-swiftclient; sudo pip install -r requirements.txt;</span><br><span class="line">python setup.py install; cd ..</span><br></pre></td></tr></table></figure>
<p>I run into a problem of invalid format of the requirement.txt. You may need to do some editing in that case.</p>
<h3><span id="install-the-swift">Install the Swift</span></h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">cd /opt</span><br><span class="line">git clone https://github.com/openstack/swift.git</span><br><span class="line">cd /opt/swift ; sudo python setup.py install; cd ..</span><br></pre></td></tr></table></figure>
<p>The above is from the swift book. But I realized I still need to run “sudo pip install -r requirements.txt” before the setup*</p>
<p>Another issue I found is that it takes forever to pip install cryptography in the requirements.txt. I searched in Google where some guy said it took 20 min for building. For me, after 20 min, it still hanged there. </p>
<p>I tried to install all dependencies manually, as follows without the <em>cryptography</em>. After that, it was installed successfully:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">Requirement already satisfied (use --upgrade to upgrade): cryptography in /usr/local/lib/python2.7/dist-packages</span><br><span class="line">Requirement already satisfied (use --upgrade to upgrade): idna&gt;=2.0 in /usr/local/lib/python2.7/dist-packages (from cryptography)</span><br><span class="line">Requirement already satisfied (use --upgrade to upgrade): pyasn1&gt;=0.1.8 in /usr/local/lib/python2.7/dist-packages (from cryptography)</span><br><span class="line">Requirement already satisfied (use --upgrade to upgrade): six&gt;=1.4.1 in /usr/local/lib/python2.7/dist-packages (from cryptography)</span><br><span class="line">Requirement already satisfied (use --upgrade to upgrade): setuptools&gt;=11.3 in /usr/local/lib/python2.7/dist-packages (from cryptography)</span><br><span class="line">Requirement already satisfied (use --upgrade to upgrade): enum34 in /usr/local/lib/python2.7/dist-packages (from cryptography)</span><br><span class="line">Requirement already satisfied (use --upgrade to upgrade): ipaddress in /usr/local/lib/python2.7/dist-packages (from cryptography)</span><br><span class="line">Requirement already satisfied (use --upgrade to upgrade): cffi&gt;=1.4.1 in /usr/local/lib/python2.7/dist-packages (from cryptography)</span><br><span class="line">Requirement already satisfied (use --upgrade to upgrade): pycparser in /usr/local/lib/python2.7/dist-packages (from cffi&gt;=1.4.1-&gt;cryptography)</span><br></pre></td></tr></table></figure>
<h3><span id="copy-in-swift-configuration-files">Copy in Swift configuration files</span></h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">mkdir -p /etc/swift</span><br><span class="line">cd /opt/swift/etc</span><br><span class="line">cp account-server.conf-sample /etc/swift/account-server.conf</span><br><span class="line">cp container-server.conf-sample /etc/swift/container-server.conf</span><br><span class="line">cp object-server.conf-sample /etc/swift/object-server.conf</span><br><span class="line">cp proxy-server.conf-sample /etc/swift/proxy-server.conf</span><br><span class="line">cp drive-audit.conf-sample /etc/swift/drive-audit.conf</span><br><span class="line">cp swift.conf-sample /etc/swift/swift.conf</span><br><span class="line"></span><br><span class="line">chown -R swift:swift /etc/swift</span><br></pre></td></tr></table></figure>
<p>In this setup, we rely on <em>tempauth</em> for authentication.</p>
<h3><span id="config-the-swiftconf">Config the swift.conf</span></h3><h4><span id="setting-the-hash-path-prefix-and-suffix">Setting the hash path prefix and suffix</span></h4><p>These two random strings are used to determine the hash result of the partitions on the rings. They are supposed to be confidential.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">swift_hash_path_suffix = random_32_length_string1</span><br><span class="line">swift_hash_path_prefix = random_32_length_string2</span><br></pre></td></tr></table></figure>
<p>You can use </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">head -c 32 /dev/random | base64</span><br></pre></td></tr></table></figure>
<p>to get one random 32 length string.</p>
<h4><span id="the-storage-policy">The storage policy</span></h4><p>You can custermize the storage policy as per the swift book, but it is optional.</p>
<h3><span id="build-the-rings">Build the rings</span></h3><p>The 3 parameters are part_power, replicas, min_part_hours</p>
<ul>
<li>part_power: the number of partitions in the storage cluster. The typical setting is log_2 ( 100 <em> maximun number of disks ). For this setup, it is log_2 (100 </em> 1) which is close to 7. </li>
<li>replicas: in this setup, there is only one drive. Therefore, only 1 replica is allowed.</li>
<li>min_part_hours: the default is 24 hours. Tune it as per the swift book or the official document.</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">cd /etc/swift</span><br><span class="line">swift-ring-builder account.builder create 7 1 1</span><br><span class="line">swift-ring-builder container.builder create 7 1 1</span><br><span class="line">swift-ring-builder object.builder create 7 1 1</span><br></pre></td></tr></table></figure>
<h3><span id="prepare-the-drives">Prepare the drives</span></h3><p>You can use a disk or chop off disk space from existing disk to provide storage for swift. Follow the step 2 of this <a href="http://blog.adityapatawari.com/2014/01/openstack-101-how-to-setup-openstack_12.html" target="_blank" rel="noopener">article</a>. Copied here: </p>
<p><em>Attach a disk which would be used for storage or chop off some disk space from the existing disk.<br>Using additional disks:<br>Most likely this is done when there is large amount of data to be stored. XFS is the recommended filesystem and is known to work well with Swift. If the additional disk is attached as /dev/sdb then following will do the trick:</em></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"># fdisk /dev/sdb</span><br><span class="line"># mkfs.xfs /dev/sdb1</span><br><span class="line"># echo &quot;/dev/sdb1 /srv/node/partition1 xfs noatime,nodiratime,nobarrier,logbufs=8 0 0&quot; &gt;&gt; /etc/fstab </span><br><span class="line"># mkdir -p /srv/node/partition1</span><br><span class="line"># mount /srv/node/partition1</span><br></pre></td></tr></table></figure>
<p><em>Chopping off disk space from the existing disk:<br>We can chop off disk from existing disks as well. This is usually done for smaller installations or for “proof-of-concept” stage. We can use XFS like before or we can use ext4 as well.</em></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"># truncate --size=2G /tmp/swiftstorage</span><br><span class="line"># DEVICE=$(losetup --show -f /tmp/swiftstorage)</span><br><span class="line"># mkfs.ext4 $DEVICE</span><br><span class="line"># mkdir -p /srv/node/partition1</span><br><span class="line"># mount $DEVICE /srv/node/partition1 -t ext4 -o noatime,nodiratime,nobarrier,user_xattr</span><br></pre></td></tr></table></figure>
<p>In either case, you need to </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">chown -R swift:swift /srv/node/partition1</span><br></pre></td></tr></table></figure>
<p>Also, you need to mount automatically after system reboot. So put the mount command line into a script, e.g., <em>/opt/swift/bin/mount_devices</em>. Then add a file <em>start_swift.conf</em> under <em>/etc/init/</em> with content</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">description &quot;mount swift drives&quot;</span><br><span class="line">start on runlevel [234]</span><br><span class="line">stop on runlevel [0156]</span><br><span class="line">exec /opt/swift/bin/mount_devices</span><br></pre></td></tr></table></figure>
<p>Make sure to make the script runnable</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">chmod +x /opt/swift/bin/mount_devices</span><br></pre></td></tr></table></figure>
<h3><span id="add-the-drives-to-the-rings">Add the drives to the rings</span></h3><p>The single parameter <em>100</em> is the weight for load balancing. Note that the <em>partition1</em> in the command is in the path of <em>/srv/node/partition1</em>. If you change the path, you need to change both places. It is not the name of the device in <em>/dev/sda</em>, for example. Make sure about the <em>IP</em>s and the <em>PORT</em>s. They are the address of the processes (account, container, and object). I was blocked by the port for quite a while, simply because the default ports in the conf files are different from the ones used below (not sure why…).</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">swift-ring-builder account.builder add r1z1-127.0.0.1:6002/partition1 100</span><br><span class="line">swift-ring-builder container.builder add r1z1-127.0.0.1:6001/partition1 100</span><br><span class="line">swift-ring-builder object.builder add r1z1-127.0.0.1:6000/partition1 100</span><br></pre></td></tr></table></figure>
<p>Rebalance the rings to create them actually.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">swift-ring-builder account.builder rebalance</span><br><span class="line">swift-ring-builder container.builder rebalance</span><br><span class="line">swift-ring-builder object.builder rebalance</span><br></pre></td></tr></table></figure>
<p>You will find the *.ring.gz files and a backup folder. </p>
<h3><span id="configure-the-logs">Configure the logs</span></h3><p>put a file named <em>0-swift.conf</em> under <em>/etc/rsyslog.d</em> directory, containing only one line:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">local0.* /var/log/swift/all.log</span><br></pre></td></tr></table></figure>
<p>And then create the directory and set the right permissions.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">mkdir /var/log/swift</span><br><span class="line">chown -R syslog.adm /var/log/swift</span><br><span class="line">chmod -R g+w /var/log/swift</span><br><span class="line"></span><br><span class="line">service rsyslog restart</span><br></pre></td></tr></table></figure>
<h3><span id="start-the-proxy-server">Start the proxy server</span></h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">swift-init proxy start</span><br></pre></td></tr></table></figure>
<p>If you see warning messages as discussed in this <a href="https://ask.openstack.org/en/question/93267/unable-to-start-swift-proxy-liberasurecode-missing-libshssso/" target="_blank" rel="noopener">post</a>. You can follow the solutions there, copied here:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">curl -o libisal2_2.15.0-3~bpo14.04+1_amd64.deb http://mitaka-trusty.pkgs.mirantis.com/debian/pool/trusty-mitaka-backports/main/l/libisal/libisal2_2.15.0-3~bpo14.04+1_amd64.deb </span><br><span class="line">sudo dpkg -i libisal2_2.15.0-3~bpo14.04+1_amd64.deb</span><br><span class="line">git clone https://bitbucket.org/kmgreen2/pyeclib.git </span><br><span class="line">sudo python setup.py install</span><br><span class="line">sudo apt-get uninstall python-pyeclib</span><br></pre></td></tr></table></figure>
<h3><span id="configure-tempauth-in-proxy-serverconf">Configure tempauth in proxy-server.conf</span></h3><p>We rely on <em>tempauth</em> for authentication in this setup. If you are using keystone, follow this <a href="http://blog.adityapatawari.com/2014/01/openstack-101-how-to-setup-openstack_12.html" target="_blank" rel="noopener">post</a> or this <a href="https://gist.github.com/anak10thn/7446838" target="_blank" rel="noopener">one</a>.</p>
<p>First, start the memcache:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">service memcached start</span><br></pre></td></tr></table></figure>
<p>Add your users to proxy-server.conf under the tempauth block.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">[filter:tempauth]</span><br><span class="line">use = egg:swift#tempauth</span><br><span class="line"># You can override the default log routing for this filter here:</span><br><span class="line">...</span><br><span class="line"># &lt;account&gt; is from the user_&lt;account&gt;_&lt;user&gt; name.</span><br><span class="line"># Here are example entries, required for running the tests:</span><br><span class="line">user_admin_admin = admin .admin .reseller_admin</span><br><span class="line">user_test_tester = testing .admin</span><br><span class="line">user_test2_tester2 = testing2 .admin</span><br><span class="line">user_test_tester3 = testing3</span><br></pre></td></tr></table></figure>
<p>The syntax is </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">user_$SWIFTACCOUNT_$SWIFTUSER = $KEY [group] [group] [...] [storage_url]</span><br></pre></td></tr></table></figure>
<p>which means you can configure the user for each storage url.</p>
<p>Then, modify these two options:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">allow_account_management = true</span><br><span class="line">account_autocreate = true</span><br></pre></td></tr></table></figure>
<h3><span id="start-the-servers">Start the servers</span></h3><p>Create the cache directory</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">mkdir -p /var/swift/recon</span><br><span class="line">chown -R swift:swift /var/swift/recon</span><br></pre></td></tr></table></figure>
<p>Start the services after making sure the conf files are right, especially the ip and port. The ip is typically set to 0.0.0.0 and the port should be the same as adding the drives. </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">swift-init account start</span><br><span class="line">swift-init container start</span><br><span class="line">swift-init object start</span><br></pre></td></tr></table></figure>
<p>Then, restart the proxy server</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">swift-init proxy restart</span><br></pre></td></tr></table></figure>
<h3><span id="verify-the-setup">Verify the setup</span></h3><p>Send in the authentication (note that I’m using the <em>admin</em> user defined in the proxy-server.conf with group <em>admin</em> and password <em>admin</em>):</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">curl -v -H &apos;X-Auth-User: admin:admin&apos; -H &apos;X-Auth-Key: admin&apos; http://localhost:8080/auth/v1.0/</span><br></pre></td></tr></table></figure>
<p>The above will get you the X-Auth-Token if everything is right. For instance,</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">* Hostname was NOT found in DNS cache</span><br><span class="line">*   Trying 127.0.0.1...</span><br><span class="line">* Connected to localhost (127.0.0.1) port 8080 (#0)</span><br><span class="line">&gt; GET /auth/v1.0/ HTTP/1.1</span><br><span class="line">&gt; User-Agent: curl/7.35.0</span><br><span class="line">&gt; Host: localhost:8080</span><br><span class="line">&gt; Accept: */*</span><br><span class="line">&gt; X-Auth-User: admin:admin</span><br><span class="line">&gt; X-Auth-Key: admin</span><br><span class="line">&gt; </span><br><span class="line">&lt; HTTP/1.1 200 OK</span><br><span class="line">&lt; X-Storage-Url: http://localhost:8080/v1/AUTH_admin</span><br><span class="line">&lt; X-Auth-Token-Expires: 18098</span><br><span class="line">&lt; X-Auth-Token: AUTH_tka1a0d192e57746839c1749f238ba5419</span><br><span class="line">&lt; Content-Type: text/html; charset=UTF-8</span><br><span class="line">&lt; X-Storage-Token: AUTH_tka1a0d192e57746839c1749f238ba5419</span><br><span class="line">&lt; Content-Length: 0</span><br><span class="line">&lt; X-Trans-Id: txb9682bc6bab448659fd50-005881a50f</span><br><span class="line">&lt; X-Openstack-Request-Id: txb9682bc6bab448659fd50-005881a50f</span><br><span class="line">&lt; Date: Fri, 20 Jan 2017 05:50:07 GMT</span><br><span class="line">&lt; </span><br><span class="line">* Connection #0 to host localhost left intact</span><br></pre></td></tr></table></figure>
<p>Next, use the token to access the account by</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">curl -v -H &apos;X-Storage-Token: AUTH_tka1a0d192e57746839c1749f238ba5419&apos; http://127.0.0.1:8080/v1/AUTH_admin/</span><br></pre></td></tr></table></figure>
<p>the admin in the url <em>AUTH_admin</em> should be the same as the username. You should get something like follows.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">* Hostname was NOT found in DNS cache</span><br><span class="line">*   Trying 127.0.0.1...</span><br><span class="line">* Connected to 127.0.0.1 (127.0.0.1) port 8080 (#0)</span><br><span class="line">&gt; GET /v1/AUTH_admin HTTP/1.1</span><br><span class="line">&gt; User-Agent: curl/7.35.0</span><br><span class="line">&gt; Host: 127.0.0.1:8080</span><br><span class="line">&gt; Accept: */*</span><br><span class="line">&gt; X-Storage-Token: AUTH_tka1a0d192e57746839c1749f238ba5419</span><br><span class="line">&gt; </span><br><span class="line">&lt; HTTP/1.1 200 OK</span><br><span class="line">&lt; Content-Length: 12</span><br><span class="line">&lt; X-Account-Object-Count: 0</span><br><span class="line">&lt; X-Account-Storage-Policy-Policy-0-Bytes-Used: 0</span><br><span class="line">&lt; X-Account-Storage-Policy-Policy-0-Container-Count: 1</span><br><span class="line">&lt; X-Timestamp: 1484824088.30547</span><br><span class="line">&lt; X-Account-Storage-Policy-Policy-0-Object-Count: 0</span><br><span class="line">&lt; X-Account-Bytes-Used: 0</span><br><span class="line">&lt; X-Account-Container-Count: 1</span><br><span class="line">&lt; Content-Type: text/plain; charset=utf-8</span><br><span class="line">&lt; Accept-Ranges: bytes</span><br><span class="line">&lt; X-Trans-Id: txf57c870a9ba146d9947d0-005881a5cd</span><br><span class="line">&lt; X-Openstack-Request-Id: txf57c870a9ba146d9947d0-005881a5cd</span><br><span class="line">&lt; Date: Fri, 20 Jan 2017 05:53:17 GMT</span><br><span class="line">&lt; </span><br><span class="line">mycontainer</span><br><span class="line">* Connection #0 to host 127.0.0.1 left intact</span><br></pre></td></tr></table></figure>
<p>I was blocked here for quite a while simply because the port in the proxy-server.conf is 6202, not 6002. Be careful!!!</p>
<p>If you get something wrong, go to the log file (at /var/log/swift/all.log) and see the error message there. </p>
<p>You can further verify the setup by creating a container and upload/download a file with </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">curl -v -H &apos;X-Storage-Token: AUTH_tka1a0d192e57746839c1749f238ba5419&apos; -X PUT http://127.0.0.1:8080/v1/AUTH_admin/mycontainer</span><br><span class="line">swift -A http://127.0.0.1:8080/auth/v1.0/ -U admin:admin -K admin upload mycontainer some_file</span><br></pre></td></tr></table></figure>
<p>In the last command line, we use swift client instead of curl. There are other subcommand other than upload. There are delete, download, list, post, and stat. To avoid putting the url and user info in every command, one could put the following into .bashrc</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">export ST_AUTH=http://localhost:8080/auth/v1.0</span><br><span class="line">export ST_USER=admin:admin</span><br><span class="line">export ST_KEY=admin</span><br></pre></td></tr></table></figure>
<h3><span id="start-the-consistency-processes">Start the consistency processes</span></h3><p>Swift relies on a few other processes for consistency purposes. </p>
<p>Edit (or create) the <em>/etc/default/rsync</em> file and add the following line:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">RSYNC_ENABLE=true</span><br></pre></td></tr></table></figure>
<p>Then, edit (or create) the <em>/etc/rsyncd.conf</em> file, adding the following:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">uid = swift</span><br><span class="line">gid = swift</span><br><span class="line">log file = /var/log/rsyncd.log</span><br><span class="line">pid file = /var/run/rsyncd.pid</span><br><span class="line">[account]</span><br><span class="line">max connections = 25</span><br><span class="line">path = /srv/node/</span><br><span class="line">read only = false</span><br><span class="line">lock file = /var/lock/account.lock</span><br><span class="line">[container]</span><br><span class="line">max connections = 25</span><br><span class="line">path = /srv/node/</span><br><span class="line">read only = false</span><br><span class="line">lock file = /var/lock/container.lock</span><br><span class="line">[object]</span><br><span class="line">max connections = 25</span><br><span class="line">path = /srv/node/</span><br><span class="line">read only = false</span><br><span class="line">lock file = /var/lock/object.lock</span><br></pre></td></tr></table></figure>
<p>Start the rsync service</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">service rsync start</span><br></pre></td></tr></table></figure>
<p>Now, you can start the processes by </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">swift-init account-replicator start</span><br><span class="line">swift-init container-replicator start</span><br><span class="line">swift-init object-replicator start</span><br></pre></td></tr></table></figure>
<p>One useful way of controlling these processes is by</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">swift-init all start/stop/restart</span><br></pre></td></tr></table></figure>
<h3><span id="setup-on-multiple-nodes">Setup on multiple nodes</span></h3><p>The plan of deployment depends on the hardware. One need to read the part IV of the swift book before that. I found this <a href="https://thornelabs.net/2014/07/14/install-a-stand-alone-multi-node-openstack-swift-cluster-with-virtualbox-or-vmware-fusion-and-vagrant.html" target="_blank" rel="noopener">article</a> very well writen. One can learn the way of deployment for a small cluster. </p>
<p>There are a few points one should keep in mind. </p>
<ul>
<li>Copy the swift.conf file to all nodes;</li>
<li>Add the drives across all nodes to the rings;</li>
<li>Copy the rings to all nodes;</li>
</ul>
<h3><span id="references">References</span></h3><ol>
<li>Install a Stand-alone, Multi-node OpenStack Swift Cluster with VirtualBox or VMware Fusion and Vagrant (<a href="https://thornelabs.net/2014/07/14/install-a-stand-alone-multi-node-openstack-swift-cluster-with-virtualbox-or-vmware-fusion-and-vagrant.html" target="_blank" rel="noopener">https://thornelabs.net/2014/07/14/install-a-stand-alone-multi-node-openstack-swift-cluster-with-virtualbox-or-vmware-fusion-and-vagrant.html</a>)</li>
<li>OpenStack 101: How to Setup OpenStack Swift (<a href="http://blog.adityapatawari.com/2014/01/openstack-101-how-to-setup-openstack_12.html" target="_blank" rel="noopener">http://blog.adityapatawari.com/2014/01/openstack-101-how-to-setup-openstack_12.html</a>)</li>
<li>OpenStack Swift (the swift book)</li>
</ol>
</div></article></div></main><footer><div class="paginator"><a href="/blog/the-crowd/" class="prev">上一篇</a><a href="/blog/implementing-your-own-inputformat/" class="next">下一篇</a></div><div class="copyright"><p>© 2015 - 2018 <a href="liqul.github.io/blog">Liqun Li</a>, powered by <a href="https://hexo.io/" target="_blank">Hexo</a> and <a href="https://github.com/pinggod/hexo-theme-apollo" target="_blank">hexo-theme-apollo</a>.</p></div></footer></div><script async src="//cdn.bootcss.com/mathjax/2.7.0/MathJax.js?config=TeX-MML-AM_CHTML" integrity="sha384-crwIf/BuaWM9rM65iM+dWFldgQ1Un8jWZMuh3puxb8TOY9+linwLoI7ZHZT+aekW" crossorigin="anonymous"></script></body></html>