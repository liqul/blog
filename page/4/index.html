<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  <title>Home | Bucket &amp; Hammer</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  
    <meta name="keywords" content="Knowlege, Knowlege, Knowlege" />
  
  
  
  
  <meta property="og:type" content="website">
<meta property="og:title" content="Bucket &amp; Hammer">
<meta property="og:url" content="liqul.github.io/blog/page/4/index.html">
<meta property="og:site_name" content="Bucket &amp; Hammer">
<meta property="og:locale" content="default">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Bucket &amp; Hammer">
  
    <link rel="alternate" href="/atom.xml" title="Bucket &amp; Hammer" type="application/atom+xml">
  
  <link rel="icon" href="/blog/css/images/favicon.ico">
  
    <link href="//fonts.googleapis.com/css?family=Source+Code+Pro" rel="stylesheet" type="text/css">
  
  <link href="https://fonts.googleapis.com/css?family=Open+Sans|Montserrat:700" rel="stylesheet" type="text/css">
  <link href="https://fonts.googleapis.com/css?family=Roboto:400,300,300italic,400italic" rel="stylesheet" type="text/css">
  <link href="//cdn.bootcss.com/font-awesome/4.6.3/css/font-awesome.min.css" rel="stylesheet">
  <style type="text/css">
    @font-face{font-family:futura-pt;src:url(https://use.typekit.net/af/9749f0/00000000000000000001008f/27/l?subset_id=2&fvd=n5) format("woff2");font-weight:500;font-style:normal;}
    @font-face{font-family:futura-pt;src:url(https://use.typekit.net/af/90cf9f/000000000000000000010091/27/l?subset_id=2&fvd=n7) format("woff2");font-weight:500;font-style:normal;}
    @font-face{font-family:futura-pt;src:url(https://use.typekit.net/af/8a5494/000000000000000000013365/27/l?subset_id=2&fvd=n4) format("woff2");font-weight:lighter;font-style:normal;}
    @font-face{font-family:futura-pt;src:url(https://use.typekit.net/af/d337d8/000000000000000000010095/27/l?subset_id=2&fvd=i4) format("woff2");font-weight:400;font-style:italic;}</style>
    
  <link rel="stylesheet" id="athemes-headings-fonts-css" href="//fonts.googleapis.com/css?family=Yanone+Kaffeesatz%3A200%2C300%2C400%2C700&amp;ver=4.6.1" type="text/css" media="all">

  <link rel="stylesheet" id="athemes-headings-fonts-css" href="//fonts.googleapis.com/css?family=Oswald%3A300%2C400%2C700&amp;ver=4.6.1" type="text/css" media="all">
  <link rel="stylesheet" href="/blog/css/style.css">

  <script src="/blog/js/jquery-3.1.1.min.js"></script>

  <!-- Bootstrap core CSS -->
  <link rel="stylesheet" href="/blog/css/bootstrap.css" >
  <link rel="stylesheet" href="/blog/css/fashion.css" >
  <link rel="stylesheet" href="/blog/css/glyphs.css" >

</head>



  <body>


  


<header id="allheader" class="site-header" role="banner" 
   >
  <div class="clearfix container">
      <div class="site-branding">

          <h1 class="site-title">
            
              <a href="/blog/" rel="home" >
                <img style="margin-bottom: 10px;"  width="650px" height="124px" alt="Hike News" src=" /blog/css/images/title.png">
              </a>
            
          </h1>
          
          
            
          <nav id="main-navigation" class="main-navigation" role="navigation">
            <a class="nav-open">Menu</a>
            <a class="nav-close">Close</a>

            <div class="clearfix sf-menu">
              <ul id="main-nav" class="menu sf-js-enabled sf-arrows"  style="touch-action: pan-y;">
                    
                      <li class="menu-item menu-item-type-custom menu-item-object-custom menu-item-home menu-item-1663"> <a class="" href="/blog/">Home</a> </li>
                    
                      <li class="menu-item menu-item-type-custom menu-item-object-custom menu-item-home menu-item-1663"> <a class="" href="/blog/archives">Archives</a> </li>
                    
                      <li class="menu-item menu-item-type-custom menu-item-object-custom menu-item-home menu-item-1663"> <a class="" href="/blog/categories">Categories</a> </li>
                    
                      <li class="menu-item menu-item-type-custom menu-item-object-custom menu-item-home menu-item-1663"> <a class="" href="/blog/tags">Tags</a> </li>
                    
                      <li class="menu-item menu-item-type-custom menu-item-object-custom menu-item-home menu-item-1663"> <a class="" href="/blog/about">About</a> </li>
                    
              </ul>
            </div>
          </nav>

      </div>
  </div>
</header>


  <div id="container">
    <div id="wrap">
            
      <div id="content" class="outer">
        
          <section id="main">
  
    <article id="post-the-raft-consensus-algorithm"  class="article article-type-post" itemscope itemprop="blogPost" >
  <div id="articleInner" class="clearfix post-1016 post type-post status-publish format-standard has-post-thumbnail hentry category-template-2 category-uncategorized tag-codex tag-edge-case tag-featured-image tag-image tag-template">
    
    
      <header class="article-header">
        
  
    <h1 class="thumb" itemprop="name">
      <a class="article-title" href="/blog/the-raft-consensus-algorithm/">Notes on The Raft Consensus Algorithm</a>
    </h1>
  

      </header>
    
    <div class="article-meta">
      
	<a href="/blog/the-raft-consensus-algorithm/" class="article-date">
	  <time datetime="2017-03-31T06:25:39.000Z" itemprop="datePublished">March 31, 2017</time>
	</a>

      
	<span class="ico-folder"></span>
    <a class="article-category-link" href="/blog/categories/Tech/">Tech</a>
 
      
    </div>
    <div class="article-entry" itemprop="articleBody">
      
        <p>What’s consensus?</p>
<blockquote>
<p>It allows a collection of machines to work as a coherent group that can survive the failures of some of its members.</p>
</blockquote>
<p>It means not only a group of machines reach a final decision for a request, but also the state machine is replicated across these machines, so that some failures do not affect the functioning. Raft is a consensus algorithm seeking to be correct, implementable, and understandable. </p>
<p>The <a href="https://ramcloud.stanford.edu/~ongaro/thesis.pdf" target="_blank" rel="noopener">thesis</a> is very well written. It is much more comprehensive compared to the NSDI paper. Implementing Raft based on the thesis shouldn’t be too difficult (of course, also not trivial). The author also built a <a href="https://raft.github.io/" target="_blank" rel="noopener">website</a> putting all kinds of helping things there. I read the paper and decide to take some notes here.</p>
<p><img src="/blog/assets/state.png" width="800"></p>
<p>There are two key parts sitting in the core of the algorithm:</p>
<p><strong>Leader election</strong></p>
<p>The election is triggered by a timeout. If a server failed to detect heartbeats from the current leader, it start a new <em>term</em> of election. During the term, it broadcast requests to collect votes from other servers. If equal or more than majority of servers reply with a vote, the server becomes the leader of this term. The “term” here is a monotonically increasing logic time. From the perspective of a server receiving the vote request, it decides whether to give the vote based on a few considerations. First of all, if the sender even falls behind the receiver in terms of log index, the receiver should not vote for it. Also, if the receiver can still hear the heartbeats from current leader, it should not vote too. In this case, the requester might be a <em>disruptive server</em>. In other cases, the receiver should vote for the sender. </p>
<p><img src="/blog/assets/leader election.png" width="800"></p>
<p><strong>Log replication</strong></p>
<p>Once a server becomes the leader, it’s mission is simply replicate it’s log to every other follower. The replication means make the log of a follower <em>exactly</em> the same as the leader. For each pair of leader and follower, the leader first identify the highest index where they reach an agreement. Starting from there, the leader overwrite its log to the follower. The leader handles all requests from clients. Once it receives a new request, it first put the request into its own log. Then, it replicate the request to all followers. If equal or more than majority followers (including the leader itself) answer the replication request with success, the leader apply the request into its state machine (this is called commit). The leader put the new log index into its heartbeats, so followers know if the request has been committed, after which each follower commit the request too.</p>
<p><img src="/blog/assets/log replication.png" width="800"></p>
<p>More formal introduction of the core Raft could be found in Fig. 3.1 in the thesis paper. There are also a few extensions to make the algorithm practical to be used in production systems, such as the group management. I also found Fig. 10.1 a very good reference of architecture. </p>
<p>There are quite a lot of implementations of Raft, which could be found <a href="https://raft.github.io/" target="_blank" rel="noopener">here</a>. I also find a project named Copycat, with code <a href="https://github.com/atomix/copycat" target="_blank" rel="noopener">here</a> and document <a href="http://atomix.io/copycat/" target="_blank" rel="noopener">here</a>. Copycat is a full featured implementation of Raft in java. Building your own application based on Copycat shouldn’t be too difficult. They provide an example of implementing a KV store based on Copycat in their source code <a href="https://github.com/atomix/copycat/tree/master/examples" target="_blank" rel="noopener">here</a>, which is used as the “<a href="http://atomix.io/copycat/docs/getting-started/" target="_blank" rel="noopener">Get Started</a>“ tutorial. Another very important reason, why I think Copycat a good reference, is that it emphases the abstraction of state machine, client, server, and operations. Therefore, going through it’s document enhanced my understanding of Raft. </p>
<p>If you don’t want to build your own Raft, may be Copycat is worthwhile a try, though I haven’t any real experience beyond a toy project.</p>
<p>The annotated thesis could be found <a href="/blog/assets/raft-thesis.pdf">here</a>.</p>
<p><strong>A go-through case for understanding</strong></p>
<p>A typical request handling process is as follows:</p>
<ol>
<li>The client sends a request to the cluster;</li>
<li>The leader handles the request by putting it to a WAL;</li>
<li>The leader sends the request to all followers;</li>
<li>Each follower puts the received request to its WAL, and responds to the leader;</li>
<li>Once the leader has heard a majority number of responses from its followers, the leader commit the request by applying the WAL to its state machine;</li>
<li>The leader inform the client that the request has been handled properly, and then, put the index of the request into its heartbeat to let all followers know the status of each request;</li>
<li>Once the follower knows that the request has been committed by the leader, the follower commit the request too by applying it to its own state machine. </li>
</ol>
<p>There are a few key points to understand in the process above:</p>
<p>1.Does the client always know if its request has been handled properly?</p>
<p>No. If the leader commits the request and then crashes, the client will not know if the request has been actually successfully handled. In some cases, the client will resend the request which may lead to duplicated data. It leaves for the client to avoid such kind of duplication. </p>
<p>2.How about the leader crashes before inform its followers that the request has been committed?</p>
<p>If the leader crashes, a follower will be elected to be the next leader. The follower must have the latest state according to the mechanism of Raft. Therefore, the next leader definitely has the WAL for the request, and the request has definitely been replicated across a majority number of hosts. Therefore, it is safe to replicate its state to all followers. </p>
<p>3.Key feature of a consensus algorithm (or strong consistency)?</p>
<p>Under normal situations, if there’s a state change, the key step changing the state should be always handled by a certain node. The state changing should be replicated to a majority number of followers before informing the requester a success. Each read request goes to that certain node as well. Once there’s node failures or networking partitions, the service stop working until returning to the normal situation again.</p>

      
    </div>
    <footer class="entry-meta entry-footer">
      
	<span class="ico-folder"></span>
    <a class="article-category-link" href="/blog/categories/Tech/">Tech</a>

      
  <span class="ico-tags"></span>
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/blog/tags/Consensus/">Consensus</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/blog/tags/Copycat/">Copycat</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/blog/tags/Raft/">Raft</a></li></ul>

      
    </footer>
    <hr class="entry-footer-hr">
  </div>
  
</article>

<!-- Table of Contents -->

  
    <article id="post-an-algorithm-deduplicate-file-locks"  class="article article-type-post" itemscope itemprop="blogPost" >
  <div id="articleInner" class="clearfix post-1016 post type-post status-publish format-standard has-post-thumbnail hentry category-template-2 category-uncategorized tag-codex tag-edge-case tag-featured-image tag-image tag-template">
    
    
      <header class="article-header">
        
  
    <h1 class="thumb" itemprop="name">
      <a class="article-title" href="/blog/an-algorithm-deduplicate-file-locks/">An Algorithm Deduplicating File Locks</a>
    </h1>
  

      </header>
    
    <div class="article-meta">
      
	<a href="/blog/an-algorithm-deduplicate-file-locks/" class="article-date">
	  <time datetime="2017-03-26T13:02:44.000Z" itemprop="datePublished">March 26, 2017</time>
	</a>

      
	<span class="ico-folder"></span>
    <a class="article-category-link" href="/blog/categories/Tech/">Tech</a>
 
      
    </div>
    <div class="article-entry" itemprop="articleBody">
      
        <p>In one of my recent project, I need to implement a lock service for files. It is quite similar to the lock service of existing file systems. I need to support two modes: write (exclusive) and read (shard). For instance, “R/a/b/c” means a read lock for the file with path “/a/b/c”. Likewise, “W/a/b/c” stands for a write lock. </p>
<p>The interface is pretty straightforward. The user provide a set of locks, e.g., {R/a/b/c, R/a/b/d}, to be locked by our service. One challenge we face is to deduplicate the locks given by the user. For instance, the user may provide a set of locks {R/a/b/c, W/a/b/c}. In this example, we know the write lock is stronger than the read lock, and therefore, the set is equivalent to {W/a/b/c}. We tend to reduce the number of locks, since it is beneficial for checking less conflicts in the steps afterwards. </p>
<p>So far, the deduplication problem sounds quite simple, since we only need to consider locks with exactly the same path. However, we also need to support a wildcard notation, because we have a large number of files under one directory. If we want to lock all files in this directory, we need to generate a huge list of locks, each for a file. With a wildcard, we lock all files under “/a/b/“ with “R/a/b/*”. The wildcard makes the deduplication problem much more complicated. </p>
<p>We first clarify the coverage of locks by a concrete example:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">W/a/b/* &gt; W/a/b/c &gt; R/a/b/c</span><br></pre></td></tr></table></figure>
<p>Given a large set of locks, a very simple algorithm is that we compare each pair of locks. If one is stronger than the other, the weaker one is throw away. The result set contains only locks where no one is stronger than other locks. This algorithm’s complexity is O(n*n) which is slow if the given set is large. So, I try to find a faster algorithm. </p>
<p>After some thoughts, I developed an algorithm with complexity O(n), which constructs a tree on the set of locks. Each tree node has the following attributes:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">class Node &#123;</span><br><span class="line">    String name; //the name of the node</span><br><span class="line">    String mode; //&quot;W&quot; or &quot;R&quot;</span><br><span class="line">    Node parent; //the parent of the node</span><br><span class="line">    boolean mark = false; //mark=true if there&apos;s at least one W node in its subtree</span><br><span class="line">    Map&lt;String, Node&gt; children = new HashMap&lt;&gt;(); //the children of this node</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>We now explain how to construct a lock tree with a concrete example.</p>
<p><img src="/blog/assets/algorithm.png"></p>
<p>In the figure above, we show inserting a set of locks into an empty lock tree. Each node is represented with a string “mode:name:mark”. </p>
<p><em>Step 1~3</em>: Inserting the first three locks {R/a/b/c, R/a/b/d, R/a/e/f} is straightforward.<br><em>Step 4:</em> Then, inserting the 4th lock, i.e., “W/a/b/c”, has two effects: (1) upgrade the original “R” lock of /a/b/c to “W” mode; (2) mark the path of “/a/b/c” from 0 to 1.<br><em>Step 5:</em> The 5th lock “R/a/b/e” is the same with the first three.<br><em>Step 6~7:</em> Then, the 6th lock “R/a/b/*“ contains a wildcard. Having a “R” wildcard means replacing all unmarked nodes (“R:e:0” and “R:d:0”) with a “R:*:0” node, in its parent’s subtree (the parent is “R:b:1” in this case). Similarly, inserting “R/a/*/*“ first removes all unmarked nodes in “R:a:1”‘s subtree, i.e., “R:e:0”, “R:*:0”, and “R:f:0”, and then insert new nodes with wildcard.<br><em>Step 8:</em> Finally, inserting a “W” mode lock with wildcard means deleting all nodes in the subtree of “R:a:1” (the wildcard node’s parent) and then insert the new nodes. </p>
<p>After constructing the lock tree, each path from root to leaf is a lock in our deduplicated result set. In practice, a hashmap may already solve most duplicated cases. We rarely encounter extreme cases as shown in the example above. The algorithm briefly described above is only for fun :). I didn’t mention paths with different lengths since they could be put into different trees, which is therefore not a real problem. </p>
<p>I didn’t elaborate all cases in the example above, which is more complicated. A sample implementation of the algorithm could be find <a href="/blog/assets/LockTree.java">here</a>. The output is as follows:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">R/a/b/c</span><br><span class="line">ROOT: abc[R]</span><br><span class="line">R/a/b/d</span><br><span class="line">ROOT: abc[R]</span><br><span class="line">ROOT: abd[R]</span><br><span class="line">R/a/e/f</span><br><span class="line">ROOT: abc[R]</span><br><span class="line">ROOT: abd[R]</span><br><span class="line">ROOT: aef[R]</span><br><span class="line">W/a/b/c</span><br><span class="line">ROOT: abc[W]</span><br><span class="line">ROOT: abd[R]</span><br><span class="line">ROOT: aef[R]</span><br><span class="line">R/a/b/e</span><br><span class="line">ROOT: abc[W]</span><br><span class="line">ROOT: abd[R]</span><br><span class="line">ROOT: abe[R]</span><br><span class="line">ROOT: aef[R]</span><br><span class="line">R/a/b/*</span><br><span class="line">ROOT: abc[W]</span><br><span class="line">ROOT: ab*[R]</span><br><span class="line">ROOT: aef[R]</span><br><span class="line">R/a/*/*</span><br><span class="line">ROOT: abc[W]</span><br><span class="line">ROOT: a**[R]</span><br><span class="line">W/a/*/*</span><br><span class="line">ROOT: a**[W]</span><br></pre></td></tr></table></figure>

      
    </div>
    <footer class="entry-meta entry-footer">
      
	<span class="ico-folder"></span>
    <a class="article-category-link" href="/blog/categories/Tech/">Tech</a>

      
  <span class="ico-tags"></span>
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/blog/tags/lock/">lock</a></li></ul>

      
    </footer>
    <hr class="entry-footer-hr">
  </div>
  
</article>

<!-- Table of Contents -->

  
    <article id="post-a-role-based-admission-control-system"  class="article article-type-post" itemscope itemprop="blogPost" >
  <div id="articleInner" class="clearfix post-1016 post type-post status-publish format-standard has-post-thumbnail hentry category-template-2 category-uncategorized tag-codex tag-edge-case tag-featured-image tag-image tag-template">
    
    
      <header class="article-header">
        
  
    <h1 class="thumb" itemprop="name">
      <a class="article-title" href="/blog/a-role-based-admission-control-system/">Notes on Designing an Admission Control System</a>
    </h1>
  

      </header>
    
    <div class="article-meta">
      
	<a href="/blog/a-role-based-admission-control-system/" class="article-date">
	  <time datetime="2017-03-07T07:50:03.000Z" itemprop="datePublished">March 7, 2017</time>
	</a>

      
	<span class="ico-folder"></span>
    <a class="article-category-link" href="/blog/categories/Tech/">Tech</a>
 
      
    </div>
    <div class="article-entry" itemprop="articleBody">
      
        <p>An admission control system takes care of two parts: <em>action</em> and <em>resource</em>. As a concrete example, let’s assume you are a sales manager. A typical business is viewing the orders made by all sales man in your group. Here, viewing the orders is the “action” part, while the orders made by your group is the “resource” part.</p>
<p>Given a user account, an admission control system tells which actions the user could take on which resources. For a website, the action is usually represented with a URI. For instance, </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&quot;/orders/view&quot; -&gt; view the orders</span><br><span class="line">&quot;/user/delete&quot; -&gt; delete a user</span><br><span class="line">&quot;/user/update&quot; -&gt; update a user&apos;s profile</span><br></pre></td></tr></table></figure>
<p>A typical way of managing the actions is through a layered representation of users, roles, and permissions. A user belongs to a role, and a role is composed of a set of permissions. Each permission is linked to a URI for instance. For convenience reasons, people usually add additional layers to the three-layer structure. For example, a “permission group” layer makes it easier for the manager to assign permissions when the number of permissions is too large. </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">user -&gt; role -&gt; permission</span><br></pre></td></tr></table></figure>
<p>Representing the resource is nontrivial. Before that, you need domain knowledge to understand the structure of the resource. In our example of sales manager, the resource are orders which could be managed in a tree. The manager can see all orders within her subtree, while a sales man cannot see orders from her siblings. In this case, the resource is put into a tree as follows.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">manager -- sales man 1</span><br><span class="line">        |</span><br><span class="line">        -- sales man 2</span><br><span class="line">        |</span><br><span class="line">        -- sales man 3 -- agent 1</span><br><span class="line">                       |</span><br><span class="line">                       -- agent 2</span><br></pre></td></tr></table></figure>
<p>You may maintain multiple trees, each for a logic organization. For instance, one tree for sales and another for operators. Each order is linked to a node on the tree. When a action arrives, e.g., “/orders/view/1” where “1” is the order id, we check if the linked node of this order entry in DB. If the node is within the user’s subtree, the admission is granted, otherwise denied. </p>
<p>Last but not least, be sure to use a white list for the super user. In other words, the super user should <em>not</em> go through the admission control system. Otherwise, when the admission control system is down, you can do nothing at all without permission.</p>

      
    </div>
    <footer class="entry-meta entry-footer">
      
	<span class="ico-folder"></span>
    <a class="article-category-link" href="/blog/categories/Tech/">Tech</a>

      
  <span class="ico-tags"></span>
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/blog/tags/admission-control/">admission control</a></li></ul>

      
    </footer>
    <hr class="entry-footer-hr">
  </div>
  
</article>

<!-- Table of Contents -->

  
    <article id="post-the-crowd"  class="article article-type-post" itemscope itemprop="blogPost" >
  <div id="articleInner" class="clearfix post-1016 post type-post status-publish format-standard has-post-thumbnail hentry category-template-2 category-uncategorized tag-codex tag-edge-case tag-featured-image tag-image tag-template">
    
    
      <header class="article-header">
        
  
    <h1 class="thumb" itemprop="name">
      <a class="article-title" href="/blog/the-crowd/">乌合之众</a>
    </h1>
  

      </header>
    
    <div class="article-meta">
      
	<a href="/blog/the-crowd/" class="article-date">
	  <time datetime="2017-02-25T14:31:47.000Z" itemprop="datePublished">February 25, 2017</time>
	</a>

      
	<span class="ico-folder"></span>
    <a class="article-category-link" href="/blog/categories/Book-Reading/">Book Reading</a>
 
      
    </div>
    <div class="article-entry" itemprop="articleBody">
      
        <p>准确的说《乌合之众》是指“The Crowd——A Study of the Popular Mind”，作者是Gustave Le Bon，一位1931年离世的法国作家。我所读的版本是由广西师范大学出版社出版的，由冯克利翻译的版本。有意思的是这本书正文只有32开的183页，而其中1-29页是Robert K. Merton撰写的读后感，所以在阅读正文之前已经有非常详尽的对于书的评论了。</p>
<p>读后感里对《乌合之众》的评论是非常纠结的，既赞扬了作者深刻的观察力，也批评了作者受其根深蒂固的观念的影响。相信赞扬的成分还是要比批评的成分大得多的，其实一部书里哪怕揭示了一点潜藏的知识，那这部书就已经很了不起了，哪怕附带许多明显的错误。《乌合之众》就是这样，在短短的一百多页里，作者其实只想传达一个观点——“群体的思维和个人是不同的”。更准确的说，是群体的思维是<strong>混乱的、富含想象力的、可传染的、极端的、低俗简单的、扩大化的、矛盾的，跟文明社会里的个人相比，群体就好比是来自野蛮社会的个体。</strong></p>
<p>《乌合之众》里有非常多关于上面我列举的各个形容词的描述，例如：“打动群体心灵的是神话中的英雄，而不是一时的真实英雄”、“群体感情的一致倾向会立刻变成一个既定事实”、“群体总是落后于博学之士和哲学家好几代人”。尤其经典的是“群体推理的特点，是把彼此不同、只在表面上相似的事物搅在一起，并且立刻把具体的事物普遍化”，比如“受雇主剥削的苦力，立刻便认为天下所有的雇主都是剥削他们的人”。</p>
<p>这本书两个世纪前就已经完成了，但它所描绘的现象却不断重现着。近代近两百年来中国发生的各项运动，以及参与这些运动的农民、学生、工人、商人等等，无不是《乌合之众》里描绘的角色。他们富有激情，时刻以民族、道德为口号党同伐异，采用最野蛮和暴力的方式。他们看似有无穷的力量，推动社会和历史前进，而实际上他们不过是任人摆布的玩偶，为达到某些目的而布施的棋子。</p>
<p>可恨的是直到今天这样的场景仍然此起彼伏，人们并没有比一两百年前的先辈更加冷静和明白，而一些野心家还试图利用群体的这种特点，一旦风吹草动人们仍然会像暴民一样无差别摧毁一切（很多时候包括这些活动的制造者）。作为个人，在群体面前显得太势单力薄了，我们无法改变什么，甚至无法保护自己，我们能够做的，仅仅是躲避群体带来的灾难——这种灾难是自然灾难无法比拟的！</p>

      
    </div>
    <footer class="entry-meta entry-footer">
      
	<span class="ico-folder"></span>
    <a class="article-category-link" href="/blog/categories/Book-Reading/">Book Reading</a>

      
      
    </footer>
    <hr class="entry-footer-hr">
  </div>
  
</article>

<!-- Table of Contents -->

  
    <article id="post-running-mapreduce-over-openstack-swift"  class="article article-type-post" itemscope itemprop="blogPost" >
  <div id="articleInner" class="clearfix post-1016 post type-post status-publish format-standard has-post-thumbnail hentry category-template-2 category-uncategorized tag-codex tag-edge-case tag-featured-image tag-image tag-template">
    
    
      <header class="article-header">
        
  
    <h1 class="thumb" itemprop="name">
      <a class="article-title" href="/blog/running-mapreduce-over-openstack-swift/">Running Mapreduce over Openstack Swift</a>
    </h1>
  

      </header>
    
    <div class="article-meta">
      
	<a href="/blog/running-mapreduce-over-openstack-swift/" class="article-date">
	  <time datetime="2017-02-13T02:19:09.000Z" itemprop="datePublished">February 13, 2017</time>
	</a>

      
	<span class="ico-folder"></span>
    <a class="article-category-link" href="/blog/categories/Tech/">Tech</a>
 
      
    </div>
    <div class="article-entry" itemprop="articleBody">
      
        <p>I recently got a chance of experimenting mapreduce over several opensource object storages. Openstack swift is definitely one well known object storage service. However, I found it non-trivial to set it up for evaluation. Therefore, I put some notes below. </p>
<p>This article is only for os=Ubuntu 14.04 and swift=liberty. I noticed that the newer versions of swift is with much better documentation, which is much easier to follow. The appendix contains my early trials of installing swift from source.  </p>
<h2><span id="read-the-followings">Read the followings</span></h2><ul>
<li><a href="http://stackoverflow.com/questions/19004503/the-relationship-between-endpoints-regions-etc-in-keystone-openstack" target="_blank" rel="noopener">http://stackoverflow.com/questions/19004503/the-relationship-between-endpoints-regions-etc-in-keystone-openstack</a></li>
<li>Part 1. Fundamentals and Architecture in “Openstack Swift - Using, Administering, and Developing for Swift Object Storage”</li>
</ul>
<p>Make sure you have some sense for concepts including user, role, tenant, project, endpoint, proxy server, account server, object server, rings, and etc.</p>
<p>To my understanding, they are:</p>
<ul>
<li>user: a real user, or a service</li>
<li>role: role of users, corresponding to a set of permissions</li>
<li>tenant = project: a set of users</li>
<li>endpoint: the entry point urls of openstack services</li>
<li>proxy server: handling user requests in swift</li>
<li>account server: handling user account in swift, also used as domain or primary namespace </li>
<li>object server: handling object storage in swift</li>
<li>rings: the consistent hashing algorithm used by swift</li>
<li>keystone: the authentication service in openstack. Key concepts on keystone can be found <a href="http://docs.openstack.org/admin-guide/identity-concepts.html" target="_blank" rel="noopener">here</a></li>
</ul>
<h2><span id="setup-keynote-and-swift">Setup keynote and swift</span></h2><h3><span id="install-dependencies">Install dependencies</span></h3><ul>
<li><p>Install MariaDB (or MySQL) and memcache following <a href="https://www.server-world.info/en/note?os=Ubuntu_14.04&amp;p=openstack_liberty&amp;f=2" target="_blank" rel="noopener">page</a></p>
</li>
<li><p>Install keystone following <a href="https://www.server-world.info/en/note?os=Ubuntu_14.04&amp;p=openstack_liberty&amp;f=3" target="_blank" rel="noopener">page1</a> and <a href="https://www.server-world.info/en/note?os=Ubuntu_14.04&amp;p=openstack_liberty&amp;f=4" target="_blank" rel="noopener">page2</a>. Note that if you want to run mapreduce over swift, you can <em>not</em> use the TempAuth approach. Read this <a href="https://issues.apache.org/jira/browse/HADOOP-10420" target="_blank" rel="noopener">page</a> for more details. </p>
</li>
<li><p>Install swift following <a href="https://www.server-world.info/en/note?os=Ubuntu_14.04&amp;p=openstack_liberty2&amp;f=3" target="_blank" rel="noopener">page1</a>, <a href="https://www.server-world.info/en/note?os=Ubuntu_14.04&amp;p=openstack_liberty2&amp;f=4" target="_blank" rel="noopener">page2</a>, and <a href="https://www.server-world.info/en/note?os=Ubuntu_14.04&amp;p=openstack_liberty2&amp;f=5" target="_blank" rel="noopener">page3</a>. You can start the swift service with </p>
</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">swift-init all start</span><br></pre></td></tr></table></figure>
<h3><span id="setup-hadoop">Setup Hadoop</span></h3><ul>
<li>Setup Hadoop with version &gt;= 2.3 and configure it following <a href="http://spark.apache.org/docs/latest/storage-openstack-swift.html" target="_blank" rel="noopener">page1</a> and <a href="https://github.com/zioproto/hadoop-swift-tutorial" target="_blank" rel="noopener">page2</a>.</li>
<li>Make sure SwiftNativeFileSystem is in the classpath, read this <a href="https://github.com/zioproto/hadoop-swift-tutorial" target="_blank" rel="noopener">page</a> for any problem you find.</li>
<li>Configure etc/hadoop/core-site.xml，add following contents:</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line">&lt;configuration&gt;</span><br><span class="line">  &lt;property&gt;</span><br><span class="line">    &lt;name&gt;fs.swift.impl&lt;/name&gt;</span><br><span class="line">    &lt;value&gt;org.apache.hadoop.fs.swift.snative.SwiftNativeFileSystem&lt;/value&gt;</span><br><span class="line">  &lt;/property&gt;</span><br><span class="line">  &lt;property&gt;</span><br><span class="line">    &lt;name&gt;fs.swift.service.SwiftTest.auth.url&lt;/name&gt; &lt;---SwiftTest is the name of the service</span><br><span class="line">    &lt;value&gt;http://127.0.0.1:5000/v2.0/tokens&lt;/value&gt; &lt;---the ip:port should point to keystone. Make sure having &quot;/tokens&quot; there.</span><br><span class="line">  &lt;/property&gt;</span><br><span class="line">  &lt;property&gt;</span><br><span class="line">    &lt;name&gt;fs.swift.service.SwiftTest.auth.endpoint.prefix&lt;/name&gt;</span><br><span class="line">    &lt;value&gt;/AUTH_&lt;/value&gt;</span><br><span class="line">  &lt;/property&gt;</span><br><span class="line">  &lt;property&gt;</span><br><span class="line">    &lt;name&gt;fs.swift.service.SwiftTest.http.port&lt;/name&gt;</span><br><span class="line">    &lt;value&gt;8080&lt;/value&gt; &lt;--- the same with that in proxy-server.conf</span><br><span class="line">  &lt;/property&gt;</span><br><span class="line">  &lt;property&gt;</span><br><span class="line">    &lt;name&gt;fs.swift.service.SwiftTest.region&lt;/name&gt;</span><br><span class="line">    &lt;value&gt;RegionOne&lt;/value&gt;</span><br><span class="line">  &lt;/property&gt;</span><br><span class="line">  &lt;property&gt;</span><br><span class="line">    &lt;name&gt;fs.swift.service.SwiftTest.public&lt;/name&gt;</span><br><span class="line">    &lt;value&gt;true&lt;/value&gt;</span><br><span class="line">  &lt;/property&gt;</span><br><span class="line">  &lt;property&gt;</span><br><span class="line">    &lt;name&gt;fs.swift.service.SwiftTest.tenant&lt;/name&gt;</span><br><span class="line">    &lt;value&gt;admin&lt;/value&gt; &lt;--- name of the project, not the role!</span><br><span class="line">  &lt;/property&gt;</span><br><span class="line">  &lt;property&gt;</span><br><span class="line">    &lt;name&gt;fs.swift.service.SwiftTest.username&lt;/name&gt;</span><br><span class="line">    &lt;value&gt;admin&lt;/value&gt; &lt;--- user name</span><br><span class="line">  &lt;/property&gt;</span><br><span class="line">  &lt;property&gt;</span><br><span class="line">    &lt;name&gt;fs.swift.service.SwiftTest.password&lt;/name&gt;</span><br><span class="line">    &lt;value&gt;adminpassword&lt;/value&gt; &lt;--- password</span><br><span class="line">  &lt;/property&gt;</span><br><span class="line">&lt;/configuration&gt;</span><br></pre></td></tr></table></figure>
<h3><span id="verify-all-setup">Verify all setup</span></h3><ul>
<li>create a container (swift post nameofcontainer). Important! the name should be only consist of letters. No ‘_’ is allowed.</li>
<li>upload a file (swift upload nameofcontainer nameoffile).</li>
<li>hdfs dfs -ls swift://nameofcontainer.SwiftTest/. This should show you files you uploaded previously.</li>
<li>hadoop distcp nameoffile swift://mycontainer.SwiftTest/nameoffile</li>
</ul>
<h2><span id="appendix-install-swift-from-source">Appendix: Install swift from source</span></h2><h3><span id="dependencies">Dependencies</span></h3><h4><span id="from-the-swift-book">From the swift book</span></h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">apt-get install git curl gcc memcached rsync sqlite3 xfsprogs \</span><br><span class="line">git-core libffi-dev python-setuptools</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">apt-get install python-coverage python-dev python-nose \</span><br><span class="line">python-simplejson python-xattr python-eventlet \</span><br><span class="line">python-greenlet python-pastedeploy python-netifaces \</span><br><span class="line">python-pip python-dnspython python-mock</span><br></pre></td></tr></table></figure>
<h4><span id="install-the-latest-liberasurecode-as-per-some-post-may-not-be-necessary">Install the latest liberasurecode (as per some post, may not be necessary)</span></h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">sudo apt-get install build-essential autoconf automake libtool</span><br><span class="line">cd /opt/</span><br><span class="line">git clone https://github.com/openstack/liberasurecode.git</span><br><span class="line">cd liberasurecode</span><br><span class="line">./autogen.sh</span><br><span class="line">./configure</span><br><span class="line">make</span><br><span class="line">make test</span><br><span class="line">sudo make install</span><br></pre></td></tr></table></figure>
<h3><span id="install-the-swift-cli">Install the Swift CLI</span></h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">cd /opt</span><br><span class="line">git clone https://github.com/openstack/python-swiftclient.git</span><br><span class="line">cd /opt/python-swiftclient; sudo pip install -r requirements.txt;</span><br><span class="line">python setup.py install; cd ..</span><br></pre></td></tr></table></figure>
<p>I run into a problem of invalid format of the requirement.txt. You may need to do some editing in that case.</p>
<h3><span id="install-the-swift">Install the Swift</span></h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">cd /opt</span><br><span class="line">git clone https://github.com/openstack/swift.git</span><br><span class="line">cd /opt/swift ; sudo python setup.py install; cd ..</span><br></pre></td></tr></table></figure>
<p>The above is from the swift book. But I realized I still need to run “sudo pip install -r requirements.txt” before the setup*</p>
<p>Another issue I found is that it takes forever to pip install cryptography in the requirements.txt. I searched in Google where some guy said it took 20 min for building. For me, after 20 min, it still hanged there. </p>
<p>I tried to install all dependencies manually, as follows without the <em>cryptography</em>. After that, it was installed successfully:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">Requirement already satisfied (use --upgrade to upgrade): cryptography in /usr/local/lib/python2.7/dist-packages</span><br><span class="line">Requirement already satisfied (use --upgrade to upgrade): idna&gt;=2.0 in /usr/local/lib/python2.7/dist-packages (from cryptography)</span><br><span class="line">Requirement already satisfied (use --upgrade to upgrade): pyasn1&gt;=0.1.8 in /usr/local/lib/python2.7/dist-packages (from cryptography)</span><br><span class="line">Requirement already satisfied (use --upgrade to upgrade): six&gt;=1.4.1 in /usr/local/lib/python2.7/dist-packages (from cryptography)</span><br><span class="line">Requirement already satisfied (use --upgrade to upgrade): setuptools&gt;=11.3 in /usr/local/lib/python2.7/dist-packages (from cryptography)</span><br><span class="line">Requirement already satisfied (use --upgrade to upgrade): enum34 in /usr/local/lib/python2.7/dist-packages (from cryptography)</span><br><span class="line">Requirement already satisfied (use --upgrade to upgrade): ipaddress in /usr/local/lib/python2.7/dist-packages (from cryptography)</span><br><span class="line">Requirement already satisfied (use --upgrade to upgrade): cffi&gt;=1.4.1 in /usr/local/lib/python2.7/dist-packages (from cryptography)</span><br><span class="line">Requirement already satisfied (use --upgrade to upgrade): pycparser in /usr/local/lib/python2.7/dist-packages (from cffi&gt;=1.4.1-&gt;cryptography)</span><br></pre></td></tr></table></figure>
<h3><span id="copy-in-swift-configuration-files">Copy in Swift configuration files</span></h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">mkdir -p /etc/swift</span><br><span class="line">cd /opt/swift/etc</span><br><span class="line">cp account-server.conf-sample /etc/swift/account-server.conf</span><br><span class="line">cp container-server.conf-sample /etc/swift/container-server.conf</span><br><span class="line">cp object-server.conf-sample /etc/swift/object-server.conf</span><br><span class="line">cp proxy-server.conf-sample /etc/swift/proxy-server.conf</span><br><span class="line">cp drive-audit.conf-sample /etc/swift/drive-audit.conf</span><br><span class="line">cp swift.conf-sample /etc/swift/swift.conf</span><br><span class="line"></span><br><span class="line">chown -R swift:swift /etc/swift</span><br></pre></td></tr></table></figure>
<p>In this setup, we rely on <em>tempauth</em> for authentication.</p>
<h3><span id="config-the-swiftconf">Config the swift.conf</span></h3><h4><span id="setting-the-hash-path-prefix-and-suffix">Setting the hash path prefix and suffix</span></h4><p>These two random strings are used to determine the hash result of the partitions on the rings. They are supposed to be confidential.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">swift_hash_path_suffix = random_32_length_string1</span><br><span class="line">swift_hash_path_prefix = random_32_length_string2</span><br></pre></td></tr></table></figure>
<p>You can use </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">head -c 32 /dev/random | base64</span><br></pre></td></tr></table></figure>
<p>to get one random 32 length string.</p>
<h4><span id="the-storage-policy">The storage policy</span></h4><p>You can custermize the storage policy as per the swift book, but it is optional.</p>
<h3><span id="build-the-rings">Build the rings</span></h3><p>The 3 parameters are part_power, replicas, min_part_hours</p>
<ul>
<li>part_power: the number of partitions in the storage cluster. The typical setting is log_2 ( 100 <em> maximun number of disks ). For this setup, it is log_2 (100 </em> 1) which is close to 7. </li>
<li>replicas: in this setup, there is only one drive. Therefore, only 1 replica is allowed.</li>
<li>min_part_hours: the default is 24 hours. Tune it as per the swift book or the official document.</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">cd /etc/swift</span><br><span class="line">swift-ring-builder account.builder create 7 1 1</span><br><span class="line">swift-ring-builder container.builder create 7 1 1</span><br><span class="line">swift-ring-builder object.builder create 7 1 1</span><br></pre></td></tr></table></figure>
<h3><span id="prepare-the-drives">Prepare the drives</span></h3><p>You can use a disk or chop off disk space from existing disk to provide storage for swift. Follow the step 2 of this <a href="http://blog.adityapatawari.com/2014/01/openstack-101-how-to-setup-openstack_12.html" target="_blank" rel="noopener">article</a>. Copied here: </p>
<p><em>Attach a disk which would be used for storage or chop off some disk space from the existing disk.<br>Using additional disks:<br>Most likely this is done when there is large amount of data to be stored. XFS is the recommended filesystem and is known to work well with Swift. If the additional disk is attached as /dev/sdb then following will do the trick:</em></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"># fdisk /dev/sdb</span><br><span class="line"># mkfs.xfs /dev/sdb1</span><br><span class="line"># echo &quot;/dev/sdb1 /srv/node/partition1 xfs noatime,nodiratime,nobarrier,logbufs=8 0 0&quot; &gt;&gt; /etc/fstab </span><br><span class="line"># mkdir -p /srv/node/partition1</span><br><span class="line"># mount /srv/node/partition1</span><br></pre></td></tr></table></figure>
<p><em>Chopping off disk space from the existing disk:<br>We can chop off disk from existing disks as well. This is usually done for smaller installations or for “proof-of-concept” stage. We can use XFS like before or we can use ext4 as well.</em></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"># truncate --size=2G /tmp/swiftstorage</span><br><span class="line"># DEVICE=$(losetup --show -f /tmp/swiftstorage)</span><br><span class="line"># mkfs.ext4 $DEVICE</span><br><span class="line"># mkdir -p /srv/node/partition1</span><br><span class="line"># mount $DEVICE /srv/node/partition1 -t ext4 -o noatime,nodiratime,nobarrier,user_xattr</span><br></pre></td></tr></table></figure>
<p>In either case, you need to </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">chown -R swift:swift /srv/node/partition1</span><br></pre></td></tr></table></figure>
<p>Also, you need to mount automatically after system reboot. So put the mount command line into a script, e.g., <em>/opt/swift/bin/mount_devices</em>. Then add a file <em>start_swift.conf</em> under <em>/etc/init/</em> with content</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">description &quot;mount swift drives&quot;</span><br><span class="line">start on runlevel [234]</span><br><span class="line">stop on runlevel [0156]</span><br><span class="line">exec /opt/swift/bin/mount_devices</span><br></pre></td></tr></table></figure>
<p>Make sure to make the script runnable</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">chmod +x /opt/swift/bin/mount_devices</span><br></pre></td></tr></table></figure>
<h3><span id="add-the-drives-to-the-rings">Add the drives to the rings</span></h3><p>The single parameter <em>100</em> is the weight for load balancing. Note that the <em>partition1</em> in the command is in the path of <em>/srv/node/partition1</em>. If you change the path, you need to change both places. It is not the name of the device in <em>/dev/sda</em>, for example. Make sure about the <em>IP</em>s and the <em>PORT</em>s. They are the address of the processes (account, container, and object). I was blocked by the port for quite a while, simply because the default ports in the conf files are different from the ones used below (not sure why…).</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">swift-ring-builder account.builder add r1z1-127.0.0.1:6002/partition1 100</span><br><span class="line">swift-ring-builder container.builder add r1z1-127.0.0.1:6001/partition1 100</span><br><span class="line">swift-ring-builder object.builder add r1z1-127.0.0.1:6000/partition1 100</span><br></pre></td></tr></table></figure>
<p>Rebalance the rings to create them actually.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">swift-ring-builder account.builder rebalance</span><br><span class="line">swift-ring-builder container.builder rebalance</span><br><span class="line">swift-ring-builder object.builder rebalance</span><br></pre></td></tr></table></figure>
<p>You will find the *.ring.gz files and a backup folder. </p>
<h3><span id="configure-the-logs">Configure the logs</span></h3><p>put a file named <em>0-swift.conf</em> under <em>/etc/rsyslog.d</em> directory, containing only one line:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">local0.* /var/log/swift/all.log</span><br></pre></td></tr></table></figure>
<p>And then create the directory and set the right permissions.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">mkdir /var/log/swift</span><br><span class="line">chown -R syslog.adm /var/log/swift</span><br><span class="line">chmod -R g+w /var/log/swift</span><br><span class="line"></span><br><span class="line">service rsyslog restart</span><br></pre></td></tr></table></figure>
<h3><span id="start-the-proxy-server">Start the proxy server</span></h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">swift-init proxy start</span><br></pre></td></tr></table></figure>
<p>If you see warning messages as discussed in this <a href="https://ask.openstack.org/en/question/93267/unable-to-start-swift-proxy-liberasurecode-missing-libshssso/" target="_blank" rel="noopener">post</a>. You can follow the solutions there, copied here:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">curl -o libisal2_2.15.0-3~bpo14.04+1_amd64.deb http://mitaka-trusty.pkgs.mirantis.com/debian/pool/trusty-mitaka-backports/main/l/libisal/libisal2_2.15.0-3~bpo14.04+1_amd64.deb </span><br><span class="line">sudo dpkg -i libisal2_2.15.0-3~bpo14.04+1_amd64.deb</span><br><span class="line">git clone https://bitbucket.org/kmgreen2/pyeclib.git </span><br><span class="line">sudo python setup.py install</span><br><span class="line">sudo apt-get uninstall python-pyeclib</span><br></pre></td></tr></table></figure>
<h3><span id="configure-tempauth-in-proxy-serverconf">Configure tempauth in proxy-server.conf</span></h3><p>We rely on <em>tempauth</em> for authentication in this setup. If you are using keystone, follow this <a href="http://blog.adityapatawari.com/2014/01/openstack-101-how-to-setup-openstack_12.html" target="_blank" rel="noopener">post</a> or this <a href="https://gist.github.com/anak10thn/7446838" target="_blank" rel="noopener">one</a>.</p>
<p>First, start the memcache:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">service memcached start</span><br></pre></td></tr></table></figure>
<p>Add your users to proxy-server.conf under the tempauth block.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">[filter:tempauth]</span><br><span class="line">use = egg:swift#tempauth</span><br><span class="line"># You can override the default log routing for this filter here:</span><br><span class="line">...</span><br><span class="line"># &lt;account&gt; is from the user_&lt;account&gt;_&lt;user&gt; name.</span><br><span class="line"># Here are example entries, required for running the tests:</span><br><span class="line">user_admin_admin = admin .admin .reseller_admin</span><br><span class="line">user_test_tester = testing .admin</span><br><span class="line">user_test2_tester2 = testing2 .admin</span><br><span class="line">user_test_tester3 = testing3</span><br></pre></td></tr></table></figure>
<p>The syntax is </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">user_$SWIFTACCOUNT_$SWIFTUSER = $KEY [group] [group] [...] [storage_url]</span><br></pre></td></tr></table></figure>
<p>which means you can configure the user for each storage url.</p>
<p>Then, modify these two options:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">allow_account_management = true</span><br><span class="line">account_autocreate = true</span><br></pre></td></tr></table></figure>
<h3><span id="start-the-servers">Start the servers</span></h3><p>Create the cache directory</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">mkdir -p /var/swift/recon</span><br><span class="line">chown -R swift:swift /var/swift/recon</span><br></pre></td></tr></table></figure>
<p>Start the services after making sure the conf files are right, especially the ip and port. The ip is typically set to 0.0.0.0 and the port should be the same as adding the drives. </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">swift-init account start</span><br><span class="line">swift-init container start</span><br><span class="line">swift-init object start</span><br></pre></td></tr></table></figure>
<p>Then, restart the proxy server</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">swift-init proxy restart</span><br></pre></td></tr></table></figure>
<h3><span id="verify-the-setup">Verify the setup</span></h3><p>Send in the authentication (note that I’m using the <em>admin</em> user defined in the proxy-server.conf with group <em>admin</em> and password <em>admin</em>):</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">curl -v -H &apos;X-Auth-User: admin:admin&apos; -H &apos;X-Auth-Key: admin&apos; http://localhost:8080/auth/v1.0/</span><br></pre></td></tr></table></figure>
<p>The above will get you the X-Auth-Token if everything is right. For instance,</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">* Hostname was NOT found in DNS cache</span><br><span class="line">*   Trying 127.0.0.1...</span><br><span class="line">* Connected to localhost (127.0.0.1) port 8080 (#0)</span><br><span class="line">&gt; GET /auth/v1.0/ HTTP/1.1</span><br><span class="line">&gt; User-Agent: curl/7.35.0</span><br><span class="line">&gt; Host: localhost:8080</span><br><span class="line">&gt; Accept: */*</span><br><span class="line">&gt; X-Auth-User: admin:admin</span><br><span class="line">&gt; X-Auth-Key: admin</span><br><span class="line">&gt; </span><br><span class="line">&lt; HTTP/1.1 200 OK</span><br><span class="line">&lt; X-Storage-Url: http://localhost:8080/v1/AUTH_admin</span><br><span class="line">&lt; X-Auth-Token-Expires: 18098</span><br><span class="line">&lt; X-Auth-Token: AUTH_tka1a0d192e57746839c1749f238ba5419</span><br><span class="line">&lt; Content-Type: text/html; charset=UTF-8</span><br><span class="line">&lt; X-Storage-Token: AUTH_tka1a0d192e57746839c1749f238ba5419</span><br><span class="line">&lt; Content-Length: 0</span><br><span class="line">&lt; X-Trans-Id: txb9682bc6bab448659fd50-005881a50f</span><br><span class="line">&lt; X-Openstack-Request-Id: txb9682bc6bab448659fd50-005881a50f</span><br><span class="line">&lt; Date: Fri, 20 Jan 2017 05:50:07 GMT</span><br><span class="line">&lt; </span><br><span class="line">* Connection #0 to host localhost left intact</span><br></pre></td></tr></table></figure>
<p>Next, use the token to access the account by</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">curl -v -H &apos;X-Storage-Token: AUTH_tka1a0d192e57746839c1749f238ba5419&apos; http://127.0.0.1:8080/v1/AUTH_admin/</span><br></pre></td></tr></table></figure>
<p>the admin in the url <em>AUTH_admin</em> should be the same as the username. You should get something like follows.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">* Hostname was NOT found in DNS cache</span><br><span class="line">*   Trying 127.0.0.1...</span><br><span class="line">* Connected to 127.0.0.1 (127.0.0.1) port 8080 (#0)</span><br><span class="line">&gt; GET /v1/AUTH_admin HTTP/1.1</span><br><span class="line">&gt; User-Agent: curl/7.35.0</span><br><span class="line">&gt; Host: 127.0.0.1:8080</span><br><span class="line">&gt; Accept: */*</span><br><span class="line">&gt; X-Storage-Token: AUTH_tka1a0d192e57746839c1749f238ba5419</span><br><span class="line">&gt; </span><br><span class="line">&lt; HTTP/1.1 200 OK</span><br><span class="line">&lt; Content-Length: 12</span><br><span class="line">&lt; X-Account-Object-Count: 0</span><br><span class="line">&lt; X-Account-Storage-Policy-Policy-0-Bytes-Used: 0</span><br><span class="line">&lt; X-Account-Storage-Policy-Policy-0-Container-Count: 1</span><br><span class="line">&lt; X-Timestamp: 1484824088.30547</span><br><span class="line">&lt; X-Account-Storage-Policy-Policy-0-Object-Count: 0</span><br><span class="line">&lt; X-Account-Bytes-Used: 0</span><br><span class="line">&lt; X-Account-Container-Count: 1</span><br><span class="line">&lt; Content-Type: text/plain; charset=utf-8</span><br><span class="line">&lt; Accept-Ranges: bytes</span><br><span class="line">&lt; X-Trans-Id: txf57c870a9ba146d9947d0-005881a5cd</span><br><span class="line">&lt; X-Openstack-Request-Id: txf57c870a9ba146d9947d0-005881a5cd</span><br><span class="line">&lt; Date: Fri, 20 Jan 2017 05:53:17 GMT</span><br><span class="line">&lt; </span><br><span class="line">mycontainer</span><br><span class="line">* Connection #0 to host 127.0.0.1 left intact</span><br></pre></td></tr></table></figure>
<p>I was blocked here for quite a while simply because the port in the proxy-server.conf is 6202, not 6002. Be careful!!!</p>
<p>If you get something wrong, go to the log file (at /var/log/swift/all.log) and see the error message there. </p>
<p>You can further verify the setup by creating a container and upload/download a file with </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">curl -v -H &apos;X-Storage-Token: AUTH_tka1a0d192e57746839c1749f238ba5419&apos; -X PUT http://127.0.0.1:8080/v1/AUTH_admin/mycontainer</span><br><span class="line">swift -A http://127.0.0.1:8080/auth/v1.0/ -U admin:admin -K admin upload mycontainer some_file</span><br></pre></td></tr></table></figure>
<p>In the last command line, we use swift client instead of curl. There are other subcommand other than upload. There are delete, download, list, post, and stat. To avoid putting the url and user info in every command, one could put the following into .bashrc</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">export ST_AUTH=http://localhost:8080/auth/v1.0</span><br><span class="line">export ST_USER=admin:admin</span><br><span class="line">export ST_KEY=admin</span><br></pre></td></tr></table></figure>
<h3><span id="start-the-consistency-processes">Start the consistency processes</span></h3><p>Swift relies on a few other processes for consistency purposes. </p>
<p>Edit (or create) the <em>/etc/default/rsync</em> file and add the following line:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">RSYNC_ENABLE=true</span><br></pre></td></tr></table></figure>
<p>Then, edit (or create) the <em>/etc/rsyncd.conf</em> file, adding the following:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">uid = swift</span><br><span class="line">gid = swift</span><br><span class="line">log file = /var/log/rsyncd.log</span><br><span class="line">pid file = /var/run/rsyncd.pid</span><br><span class="line">[account]</span><br><span class="line">max connections = 25</span><br><span class="line">path = /srv/node/</span><br><span class="line">read only = false</span><br><span class="line">lock file = /var/lock/account.lock</span><br><span class="line">[container]</span><br><span class="line">max connections = 25</span><br><span class="line">path = /srv/node/</span><br><span class="line">read only = false</span><br><span class="line">lock file = /var/lock/container.lock</span><br><span class="line">[object]</span><br><span class="line">max connections = 25</span><br><span class="line">path = /srv/node/</span><br><span class="line">read only = false</span><br><span class="line">lock file = /var/lock/object.lock</span><br></pre></td></tr></table></figure>
<p>Start the rsync service</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">service rsync start</span><br></pre></td></tr></table></figure>
<p>Now, you can start the processes by </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">swift-init account-replicator start</span><br><span class="line">swift-init container-replicator start</span><br><span class="line">swift-init object-replicator start</span><br></pre></td></tr></table></figure>
<p>One useful way of controlling these processes is by</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">swift-init all start/stop/restart</span><br></pre></td></tr></table></figure>
<h3><span id="setup-on-multiple-nodes">Setup on multiple nodes</span></h3><p>The plan of deployment depends on the hardware. One need to read the part IV of the swift book before that. I found this <a href="https://thornelabs.net/2014/07/14/install-a-stand-alone-multi-node-openstack-swift-cluster-with-virtualbox-or-vmware-fusion-and-vagrant.html" target="_blank" rel="noopener">article</a> very well writen. One can learn the way of deployment for a small cluster. </p>
<p>There are a few points one should keep in mind. </p>
<ul>
<li>Copy the swift.conf file to all nodes;</li>
<li>Add the drives across all nodes to the rings;</li>
<li>Copy the rings to all nodes;</li>
</ul>
<h3><span id="references">References</span></h3><ol>
<li>Install a Stand-alone, Multi-node OpenStack Swift Cluster with VirtualBox or VMware Fusion and Vagrant (<a href="https://thornelabs.net/2014/07/14/install-a-stand-alone-multi-node-openstack-swift-cluster-with-virtualbox-or-vmware-fusion-and-vagrant.html" target="_blank" rel="noopener">https://thornelabs.net/2014/07/14/install-a-stand-alone-multi-node-openstack-swift-cluster-with-virtualbox-or-vmware-fusion-and-vagrant.html</a>)</li>
<li>OpenStack 101: How to Setup OpenStack Swift (<a href="http://blog.adityapatawari.com/2014/01/openstack-101-how-to-setup-openstack_12.html" target="_blank" rel="noopener">http://blog.adityapatawari.com/2014/01/openstack-101-how-to-setup-openstack_12.html</a>)</li>
<li>OpenStack Swift (the swift book)</li>
</ol>

      
    </div>
    <footer class="entry-meta entry-footer">
      
	<span class="ico-folder"></span>
    <a class="article-category-link" href="/blog/categories/Tech/">Tech</a>

      
  <span class="ico-tags"></span>
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/blog/tags/big-data/">big data</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/blog/tags/mapreduce/">mapreduce</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/blog/tags/openstack/">openstack</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/blog/tags/swift/">swift</a></li></ul>

      
    </footer>
    <hr class="entry-footer-hr">
  </div>
  
</article>

<!-- Table of Contents -->

  
    <article id="post-implementing-your-own-inputformat"  class="article article-type-post" itemscope itemprop="blogPost" >
  <div id="articleInner" class="clearfix post-1016 post type-post status-publish format-standard has-post-thumbnail hentry category-template-2 category-uncategorized tag-codex tag-edge-case tag-featured-image tag-image tag-template">
    
    
      <header class="article-header">
        
  
    <h1 class="thumb" itemprop="name">
      <a class="article-title" href="/blog/implementing-your-own-inputformat/">Implementing Your Own Mapreduce Input Format</a>
    </h1>
  

      </header>
    
    <div class="article-meta">
      
	<a href="/blog/implementing-your-own-inputformat/" class="article-date">
	  <time datetime="2017-02-13T02:11:53.000Z" itemprop="datePublished">February 13, 2017</time>
	</a>

      
	<span class="ico-folder"></span>
    <a class="article-category-link" href="/blog/categories/Tech/">Tech</a>
 
      
    </div>
    <div class="article-entry" itemprop="articleBody">
      
        <p>There are two steps for each input format, namely, getSplit and recordReader. GetSplit transforms the original input data into splits, one split for each mapper. Typically, if a big file is feed into mapreduce, it will be divided into splits of block size (e.g., 64M or 128M). However, if small files are provided, mapreduce will treat each file as a split. RecordReader turn each split into key value pairs, which are used by the mapper later. </p>
<p>In this article, I use several examples to explain how an inputformat be implemented. I’m greatly influenced by a few great references, such as <a href="http://www.idryman.org/blog/2013/09/22/process-small-files-on-hadoop-using-combinefileinputformat-1/" target="_blank" rel="noopener">this</a> and <a href="https://gist.github.com/airawat/6647007" target="_blank" rel="noopener">this</a>. </p>
<p>The first example is from book <a href="http://shop.oreilly.com/product/0636920033448.do" target="_blank" rel="noopener">“Hadoop: The Definitive Guide”</a>. WholeFileInputFormat treats each individual input file as a value. We do not need to implement our own getSplit function. Once the isSplitable function returns false, no file will be divided. Each file is treated as a split for the mapper. </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">public class WholeFileInputFormat extends FileInputFormat&lt;NullWritable, BytesWritable&gt; &#123;</span><br><span class="line">    @Override</span><br><span class="line">    protected boolean isSplitable(JobContext context, Path filename) &#123;</span><br><span class="line">        return false;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    @Override</span><br><span class="line">    public RecordReader&lt;NullWritable, BytesWritable&gt; createRecordReader(InputSplit inputSplit, TaskAttemptContext taskAttemptContext) throws IOException, InterruptedException &#123;</span><br><span class="line">        WholeFileRecordReader reader = new WholeFileRecordReader();</span><br><span class="line">        reader.initialize(inputSplit, taskAttemptContext);</span><br><span class="line">        return reader;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>Since each file is a split, the inputSplit of the record reader is actually a FileSplit. In the example code below, each returned value is the whole content of the file. The key is null in this example, which can also be the name of the file obtained from the fileSplit. </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line">public class WholeFileRecordReader extends RecordReader&lt;NullWritable, BytesWritable&gt; &#123;</span><br><span class="line">  private FileSplit fileSplit;</span><br><span class="line">  private Configuration conf;</span><br><span class="line">  private BytesWritable value = new BytesWritable();</span><br><span class="line">  private boolean processed = false;</span><br><span class="line"></span><br><span class="line">  public void initialize(InputSplit inputSplit, TaskAttemptContext taskAttemptContext) throws IOException, InterruptedException &#123;</span><br><span class="line">      this.fileSplit = (FileSplit) inputSplit;</span><br><span class="line">      this.conf = taskAttemptContext.getConfiguration();</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  public boolean nextKeyValue() throws IOException, InterruptedException &#123;</span><br><span class="line">      if(!processed) &#123;</span><br><span class="line">          byte[] contents = new byte[(int)fileSplit.getLength()];</span><br><span class="line">          Path file = fileSplit.getPath();</span><br><span class="line">          FileSystem fs = file.getFileSystem(conf);</span><br><span class="line">          FSDataInputStream in = null;</span><br><span class="line">          try &#123;</span><br><span class="line">              in = fs.open(file);</span><br><span class="line">              IOUtils.readFully(in, contents, 0, contents.length);</span><br><span class="line">              value.set(contents, 0, contents.length);</span><br><span class="line">          &#125; finally &#123;</span><br><span class="line">              IOUtils.closeStream(in);</span><br><span class="line">          &#125;</span><br><span class="line">          processed = true;</span><br><span class="line">          return true;</span><br><span class="line">      &#125;</span><br><span class="line">      return false;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  public NullWritable getCurrentKey() throws IOException, InterruptedException &#123;</span><br><span class="line">      return NullWritable.get();</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  public BytesWritable getCurrentValue() throws IOException, InterruptedException &#123;</span><br><span class="line">      return value;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  public float getProgress() throws IOException, InterruptedException &#123;</span><br><span class="line">      return processed? 1.0f : 0.0f;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  public void close() throws IOException &#123;</span><br><span class="line">      //do nothing</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>I also think the TeraInputFormat a good example. The key difference from the previous example lies in the input file format of terasort. According to the document, each input element is a 100 byte array, with the first 10 bytes as key and the left 90 bytes as value. This raises a challenge for dividing the input file into splits with exactly multiple of 100 bytes. In the code below, the getSplits simply invokes super.getSplits, ignoring the format issue. Then, in the record reader, the offset is adjusted to the next multiple of 100. </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br></pre></td><td class="code"><pre><span class="line">public class TeraInputFormat extends FileInputFormat&lt;Text, Text&gt; &#123;</span><br><span class="line">    static final String PARTITION_FILENAME = &quot;_partition.lst&quot;;</span><br><span class="line">    private static final String NUM_PARTITIONS = &quot;mapreduce.terasort.num.partitions&quot;;</span><br><span class="line">    private static final String SAMPLE_SIZE = &quot;mapreduce.terasort.partitions.sample&quot;;</span><br><span class="line">    static final int KEY_LENGTH = 10;</span><br><span class="line">    static final int VALUE_LENGTH = 90;</span><br><span class="line">    static final int RECORD_LENGTH = 100;</span><br><span class="line">    private static MRJobConfig lastContext = null;</span><br><span class="line">    private static List&lt;InputSplit&gt; lastResult = null;</span><br><span class="line"></span><br><span class="line">    public TeraInputFormat() &#123;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public RecordReader&lt;Text, Text&gt; createRecordReader(InputSplit split, TaskAttemptContext context) throws IOException &#123;</span><br><span class="line">        return new TeraInputFormat.TeraRecordReader();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public List&lt;InputSplit&gt; getSplits(JobContext job) throws IOException &#123;</span><br><span class="line">        if(job == lastContext) &#123;</span><br><span class="line">            return lastResult;</span><br><span class="line">        &#125; else &#123;</span><br><span class="line">            long t1 = System.currentTimeMillis();</span><br><span class="line">            lastContext = job;</span><br><span class="line">            lastResult = super.getSplits(job);</span><br><span class="line">            long t2 = System.currentTimeMillis();</span><br><span class="line">            System.out.println(&quot;Spent &quot; + (t2 - t1) + &quot;ms computing base-splits.&quot;);</span><br><span class="line">            if(job.getConfiguration().getBoolean(TeraScheduler.USE, true)) &#123;</span><br><span class="line">                TeraScheduler scheduler = new TeraScheduler((FileSplit[])lastResult.toArray(new FileSplit[0]), job.getConfiguration());</span><br><span class="line">                lastResult = scheduler.getNewFileSplits();</span><br><span class="line">                long t3 = System.currentTimeMillis();</span><br><span class="line">                System.out.println(&quot;Spent &quot; + (t3 - t2) + &quot;ms computing TeraScheduler splits.&quot;);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            return lastResult;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    static class TeraRecordReader extends RecordReader&lt;Text, Text&gt; &#123;</span><br><span class="line">        private FSDataInputStream in;</span><br><span class="line">        private long offset;</span><br><span class="line">        private long length;</span><br><span class="line">        private static final int RECORD_LENGTH = 100;</span><br><span class="line">        private byte[] buffer = new byte[100];</span><br><span class="line">        private Text key;</span><br><span class="line">        private Text value;</span><br><span class="line"></span><br><span class="line">        public TeraRecordReader() throws IOException &#123;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        public void initialize(InputSplit split, TaskAttemptContext context) throws IOException, InterruptedException &#123;</span><br><span class="line">            Path p = ((FileSplit)split).getPath();</span><br><span class="line">            FileSystem fs = p.getFileSystem(context.getConfiguration());</span><br><span class="line">            this.in = fs.open(p);</span><br><span class="line">            long start = ((FileSplit)split).getStart();</span><br><span class="line">            this.offset = (100L - start % 100L) % 100L;</span><br><span class="line">            this.in.seek(start + this.offset);</span><br><span class="line">            this.length = ((FileSplit)split).getLength();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        public void close() throws IOException &#123;</span><br><span class="line">            this.in.close();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        public Text getCurrentKey() &#123;</span><br><span class="line">            return this.key;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        public Text getCurrentValue() &#123;</span><br><span class="line">            return this.value;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        public float getProgress() throws IOException &#123;</span><br><span class="line">            return (float)this.offset / (float)this.length;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        public boolean nextKeyValue() throws IOException &#123;</span><br><span class="line">            if(this.offset &gt;= this.length) &#123;</span><br><span class="line">                return false;</span><br><span class="line">            &#125; else &#123;</span><br><span class="line">                long newRead;</span><br><span class="line">                for(int read = 0; read &lt; 100; read = (int)((long)read + newRead)) &#123;</span><br><span class="line">                    newRead = (long)this.in.read(this.buffer, read, 100 - read);</span><br><span class="line">                    if(newRead == -1L) &#123;</span><br><span class="line">                        if(read == 0) &#123;</span><br><span class="line">                            return false;</span><br><span class="line">                        &#125;</span><br><span class="line"></span><br><span class="line">                        throw new EOFException(&quot;read past eof&quot;);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                if(this.key == null) &#123;</span><br><span class="line">                    this.key = new Text();</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                if(this.value == null) &#123;</span><br><span class="line">                    this.value = new Text();</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                this.key.set(this.buffer, 0, 10);</span><br><span class="line">                this.value.set(this.buffer, 10, 90);</span><br><span class="line">                this.offset += 100L;</span><br><span class="line">                return true;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>One of the most common reason of customizing your own input format is for combining small files into fewer bigger ones. For this purpose, we still need to disable the split of files. Note that the implemented CombineWholeFileInputFormat extends CombineFileInputFormat which helps to turn the input split into a combine file split (the size of each split could be tuned) which may contains multiple small files. Each individual file could be retrieved with an index as shown in the record reader below. </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line">public class CombineWholeFileInputFormat extends CombineFileInputFormat&lt;Text, BytesWritable&gt; &#123;</span><br><span class="line">    @Override</span><br><span class="line">    protected boolean isSplitable(JobContext context, Path filename) &#123;</span><br><span class="line">        return false;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    @Override</span><br><span class="line">    public RecordReader&lt;Text, BytesWritable&gt; createRecordReader(InputSplit inputSplit, TaskAttemptContext taskAttemptContext) throws IOException &#123;</span><br><span class="line">        return new CombineFileRecordReader&lt;Text, BytesWritable&gt;(</span><br><span class="line">                (CombineFileSplit)inputSplit,</span><br><span class="line">                taskAttemptContext,</span><br><span class="line">                CombineWholeFileRecordReader.class</span><br><span class="line">        );</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">public class CombineWholeFileRecordReader extends RecordReader&lt;Text, BytesWritable&gt; &#123;</span><br><span class="line">    private WholeFileRecordReader reader;</span><br><span class="line">    private String fileName;</span><br><span class="line">    public CombineWholeFileRecordReader(CombineFileSplit split, TaskAttemptContext context, Integer index) throws IOException, InterruptedException &#123;</span><br><span class="line">        FileSplit fileSplit = new FileSplit(split.getPath(index),</span><br><span class="line">                split.getOffset(index), split.getLength(index),</span><br><span class="line">                split.getLocations());</span><br><span class="line"></span><br><span class="line">        fileName = fileSplit.getPath().toString();</span><br><span class="line"></span><br><span class="line">        reader = new WholeFileRecordReader();</span><br><span class="line">        reader.initialize(fileSplit, context);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public void initialize(InputSplit inputSplit, TaskAttemptContext taskAttemptContext) throws IOException, InterruptedException &#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public boolean nextKeyValue() throws IOException, InterruptedException &#123;</span><br><span class="line">        return reader.nextKeyValue();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public Text getCurrentKey() throws IOException, InterruptedException &#123;</span><br><span class="line">        return new Text(fileName);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public BytesWritable getCurrentValue() throws IOException, InterruptedException &#123;</span><br><span class="line">        return reader.getCurrentValue();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public float getProgress() throws IOException, InterruptedException &#123;</span><br><span class="line">        return reader.getProgress();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public void close() throws IOException &#123;</span><br><span class="line">        reader.close();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2><span id="summary">Summary</span></h2><p>This article demonstrated a few sample implementations of input format for a mapreduce job. The basic idea is first divide the whole input data into splits and then read each split with a record reader. Usually, there are already plenty of base input formats that can be leveraged for customizing into more sophisticated ones.</p>

      
    </div>
    <footer class="entry-meta entry-footer">
      
	<span class="ico-folder"></span>
    <a class="article-category-link" href="/blog/categories/Tech/">Tech</a>

      
  <span class="ico-tags"></span>
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/blog/tags/mapreduce/">mapreduce</a></li></ul>

      
    </footer>
    <hr class="entry-footer-hr">
  </div>
  
</article>

<!-- Table of Contents -->

  
    <article id="post-questions-applying-ai"  class="article article-type-post" itemscope itemprop="blogPost" >
  <div id="articleInner" class="clearfix post-1016 post type-post status-publish format-standard has-post-thumbnail hentry category-template-2 category-uncategorized tag-codex tag-edge-case tag-featured-image tag-image tag-template">
    
    
      <header class="article-header">
        
  
    <h1 class="thumb" itemprop="name">
      <a class="article-title" href="/blog/questions-applying-ai/">Questions Asked When Applying AI</a>
    </h1>
  

      </header>
    
    <div class="article-meta">
      
	<a href="/blog/questions-applying-ai/" class="article-date">
	  <time datetime="2017-02-11T10:08:51.000Z" itemprop="datePublished">February 11, 2017</time>
	</a>

      
	<span class="ico-folder"></span>
    <a class="article-category-link" href="/blog/categories/Tech/">Tech</a>
 
      
    </div>
    <div class="article-entry" itemprop="articleBody">
      
        <h3><span id="artificial-intelligence-ai-or-human-intelligence-hi">Artificial Intelligence (AI) or Human Intelligence (HI)?</span></h3><p>It is not always obvious to determine using AI or HI. If you feel confident to have sufficient data to train sophisticate models, you may prefer using AI. Otherwise, using HI based rules is a more straight way tackling the problems. In practice, a hybrid solution combining both AI and HI is usually a wise choice.  </p>
<h3><span id="classification-or-regression">Classification or Regression?</span></h3><p>It all depends on the output of the problem. If the outcome is continuous, use regression, otherwise classification. In the digital world, nothing is really continuous. So, if there are too many categories, use regression is a wiser choice. </p>
<h3><span id="do-i-need-preprocessing">Do I need preprocessing?</span></h3><p>It is rare case that no preprocessing is required. Data usually contains a lot of noise. If the raw data is feed into the learning algorithm, unpredictable outcome may be obtained. Filtering the extraneous data before doing the learning, and most important, also apply the filter before applying the algorithm in your real system. Once you encounter an extraneous event, use HI to determine the output to your end user. </p>
<h3><span id="complex-or-less-complex">Complex or Less complex?</span></h3><p>In the world of learning algorithm, the complexity of the problem is important to choose to apply a “legacy” algorithms like random forest, SVM, or to apply a “cutting-edge” algorithm like CNN. Though DNN beats the smartest people in some areas, it is still quite big for some applications, e.g., activity classification on smartphones. Also, keep in mind that those super powerful algorithms need tons of data as learning input. So, before tasting the cutting-edge techniques, be sure to prepare enough “food” for them. </p>
<h3><span id="how-to-avoid-over-fitting">How to avoid over-fitting?</span></h3><p>The cue comes from cross validation. Depending on how much data you have, you make take out 30% data for testing, and the left 70% for training. Or, you may split the whole data set as 10 splits. You take out 1 split for testing and the left 9 splits for training. If you have only few data, use leave one out cross validation.</p>
<h3><span id="whats-the-cost">What’s the cost?</span></h3><p>Learning algorithms typically treat all output result neutrally, which however is rare in practice. So, be sure to consider about your cost function, and apply it to the learning algorithm. There are a few ways of applying a cost function given a learning algorithm as a blackbox. </p>
<h3><span id="how-domain-knowledge-comes-in">How domain-knowledge comes in?</span></h3><p>In general, domain knowledge belongs to HI. Here, I simply want to emphasis that domain knowledge may come in multiple ways. For example, the output of a classification algorithm may be smoothed with a HMM smoother powered by domain knowledge. Also, choosing the features requires deep understanding about the problem to solve. Make a stretch algorithm framework for the problem and then feed more and more domain knowledge in brain to make it better.</p>
<p>Finally, I want to put a picture of the architecture that I designed for transportation activity detection on smartphones. </p>
<p><img src="/blog/assets/architecture.jpg" width="400"></p>

      
    </div>
    <footer class="entry-meta entry-footer">
      
	<span class="ico-folder"></span>
    <a class="article-category-link" href="/blog/categories/Tech/">Tech</a>

      
  <span class="ico-tags"></span>
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/blog/tags/AI/">AI</a></li></ul>

      
    </footer>
    <hr class="entry-footer-hr">
  </div>
  
</article>

<!-- Table of Contents -->

  
    <article id="post-toolbox"  class="article article-type-post" itemscope itemprop="blogPost" >
  <div id="articleInner" class="clearfix post-1016 post type-post status-publish format-standard has-post-thumbnail hentry category-template-2 category-uncategorized tag-codex tag-edge-case tag-featured-image tag-image tag-template">
    
    
      <header class="article-header">
        
  
    <h1 class="thumb" itemprop="name">
      <a class="article-title" href="/blog/toolbox/">Toolbox</a>
    </h1>
  

      </header>
    
    <div class="article-meta">
      
	<a href="/blog/toolbox/" class="article-date">
	  <time datetime="2016-12-18T03:42:47.000Z" itemprop="datePublished">December 18, 2016</time>
	</a>

      
	<span class="ico-folder"></span>
    <a class="article-category-link" href="/blog/categories/Tech/">Tech</a>
 
      
    </div>
    <div class="article-entry" itemprop="articleBody">
      
        <h2><span id="particle-filtering">Particle Filtering</span></h2><p>Particle filtering is essentially a heuristic continious search process. Each particle represents a probe of the whole search space. Thus, the number of particles represents the size of the search space. There are a few key steps in the search process: initialization, update weight, andd resampling. Each of these steps can be heuristically tuned following the physic world rules. A good example of applying particle filtering can be found in “Robust Indoor Localization on a Commercial Smart-Phone”, CMU TR 2011. In the paper, they adopted <em>Importance Resampling</em> which is a typical approach by selecting these <em>important</em> particles each iteration. Alternatively, another popular approach is to learn the distribution of the particles and re-generate them based on the learnt model. For example, we assume the particles follow a Normal distribution (learnt based on mean and stddev of their positions), and the observation implies another Normal distribution (pre-knowledge), we can then use a joint distribution to generate the new batch of particles. Two must read papers are <a href="https://kabru.eecs.umich.edu/yuanchao/paper/jsac15magicol.pdf" target="_blank" rel="noopener">Magicol</a> and <a href="http://ieeexplore.ieee.org/document/7272098/?arnumber=7272098" target="_blank" rel="noopener">this one</a>.</p>
<h2><span id="forward-error-correction">Forward Error Correction</span></h2><p>The purpose of FEC is to ease the correction of error packets in a packet-based network. Though there are various ways to accomplish this goal, a easy-to-follow paper is “Effective erasure codes for reliable computer communication protocols”, Sigcomm Comput. Commun. Rev. 1997. The key idea is to treat N packets as N unknowns, and generate M (M greater than or equal N) un-collinear equations such that any N equations (among M) can derive the original N packets. There is actually no inherent difference between FEC and <em>network coding</em>. The key idea of network coding is to exploit the broadcast nature of wireless communication to save as much bandwidth as possible. Dina Katabi has been working on this back to a few years ago, which could be found <a href="http://groups.csail.mit.edu/netmit/wordpress/projects/network-coding/cope/" target="_blank" rel="noopener">here</a>. </p>
<h2><span id="periodicity-detection">Periodicity Detection</span></h2><p>There are basically two mechanisms: short-time FFT and auto-correlation. A very easy-to-follow paper “On Periodicity Detection and Structural Periodic Similarity” SDM’05. The key idea of that paper is to fuse them for robustness. The paper is written in an interesting fashion.  This paper also gives a high-level description on FFT. </p>
<p>Periodicity detection is actually independent to the sensor. However, with different sensors, the specific approach may vary a little bit. A very good reference using RGB camera sensor is “Real-Time Periodic Motion Detection, Analysis, and Applications” CVPR 2000. The approach in the reference paper is quite intuitive and easy to follow. </p>
<p>Though detecting periodic activities has been well studied, it is still challenging to achieve online counting. A good practice for counting is based on a state machine with two states: (1) periodicity detection: where frequency analysis (FFT) is applied to a sliding window and peak energy ratio to tell if a periodic activity is observed; (2) edge detection: the rising/falling edges are counted. There are a few important thresholds. First, the peak energy ratio which describes how “higher” the energy of the peak should be above the ambient. Second, the threshold used to detemine if there’s a rising/falling edge. These choices require definitely domain knowledge and should use real data to learn them. </p>
<h2><span id="local-regression">Local Regression</span></h2><p>Regression is used to predict the output of a system based on existing observations. Local regression is thus used to account for locality which is a common phenomena in many physic world scenarios. Andrew Ng’s CS229 lecture notes is a good tutorial for understanding this concept. One example of applying local regression is in the Modellet paper, as well as in “Refining WI-FI Based Indoor Positioning” ISCAICT, 2010. The key technology for avoiding overfitting is leave-one-out cross-validation (LOOCV). The key idea of cross-validation is to ensure good performance on an independent test set. More details can be found in reference paper. </p>
<h2><span id="modulation">Modulation</span></h2><p>A easy-to-follow guide to modulation could be found in <a href="/blog/assets/modulation.pdf">here</a>.</p>
<h2><span id="rolling-shutter">Rolling Shutter</span></h2><p>One widely used <em>exposure control</em> is called rolling shutter where each row has a different exposure starting time. Therefore, if the scene is varying frequently, the captured data may vary from row to row. One brief introduction of rolling shutter can be found in “Energy characterization and optimization of image sensing toward continuous mobile vision” Mobisys’13. The exposure time for each row is exactly the exposure time of the camera which depends on the lighting condition. The difference of the starting times between adjacent rows is called <em>row readout</em> time, which depends on the hardware. Then, to analyse a shining light signal in the frequency domain, the sampling interval is deemed to be the readout time, and the sampling duration is the exposure time. A special case is that if the sampling duration is the multiple of the signal period, the signal is undetectable. Note that the exposure time doesn’t affect the highest detectable frequency, however, the longer the sampling duration, the lower the SNR. </p>
<p>Using rolling shutter to detect a shinning LED light source is feasible in theory. However, due to factors like imperfect sensor, exposure time, and background interference, the SNR is typically low. In common office condition, the recommended illumination level is 300 to 500 Lux. Therefore, it is impractical to apply this technique under such conditions.</p>
<h2><span id="imu-sensor-fusion">IMU Sensor Fusion</span></h2><p>Modern mobile devices ship with low-cost IMU sensors, i.e., accelerometer, gyroscope, and compass. Ideally, they can be used to track the orientation of the rigid body of the device. However, suffering from the drift issue, the sensor outputs cannot be directly used. A common way of dealing with such problems is fusing the readings from various sensors. This in general belongs to the field of Mechatronics and Robotics, and thus the derivation is quite complicated. Fortunately, we can leverage existing work described in the paper “An efficient orientation filter for inertial and inertial/magnetic sensor arrays” by Sebastian Madgwick in 2010. His code is distributed publicly and used by a lot of open source projects like <a href="http://www.x-io.co.uk/open-source-imu-and-ahrs-algorithms/" target="_blank" rel="noopener">this</a> and <a href="http://mbed.org/cookbook/IMU/" target="_blank" rel="noopener">this</a> is a port of the algorithm in C. </p>
<p>Recently, I found this <a href="http://www.chrobotics.com/library" target="_blank" rel="noopener">place</a> does a very good job explaining the key points on sensor fusion, and a copy in pdf is <a href="/blog/assets/rotation.pdf">here</a>.</p>
<h2><span id="random-sample-consensus">Random Sample Consensus</span></h2><p>Random Sample Consensus is usually referred to as <em>RANSAC</em>, which is an iterative method to estimate parameters of a model from a set of observations. The key idea is very straightforward. The algorithm starts by randomly selecting a subset of all observations to train the unknown parameters of the model. Then, it tests the remain observations and count how many of them fits the model. If the ratio is higher than a threshold, the model is considered acceptable. Otherwise, the model is rejected. The algorithm goes through a finite number of iterations to find the optimal model with the highest consensus ratio. There are two key parameters, namely thresholds of consensus and acceptable model. In order to get a good estimation, the user should have solid domain knowledge of the distribution of the data and outliers. Examples and implementation in C++ could be found at <a href="http://en.wikipedia.org/wiki/RANSAC" target="_blank" rel="noopener">here</a> and <a href="http://www.mrpt.org/tutorials/\\programming/maths-and-geometry/ransac-c-examples/" target="_blank" rel="noopener">here</a>. </p>
<p>One may wounder why not using all data to train the model. The answer is that, sometimes, it is unnecessary to use all data. One example is when you want to calculate the transform matrix from one point cloud to another. </p>
<h2><span id="diff-algorithm">Diff Algorithm</span></h2><p>Diff is an important algorithm in various applications such as finding the difference in two code segments. There are various ways of doing this where a representive one is described in the paper “An O(ND) Difference Algorithm and Its Variations”. One salient point of this paper is the formulation of the problem using <em>Edit Graph</em>. A C# implementation and discussions cound be found <a href="http://www.mathertel.de/Diff/default.aspx" target="_blank" rel="noopener">here</a>. A nicer description can be found <a href="http://simplygenius.net/Article/DiffTutorial1" target="_blank" rel="noopener">here</a>.</p>
<h2><span id="kernel-density-estimation-kde">Kernel Density Estimation (KDE)</span></h2><p>Kernel density estimation (<a href="https://en.wikipedia.org/wiki/Kernel_density_estimation" target="_blank" rel="noopener">KDE</a>) is a technique typically used to smooth the discrete density function, or more precisely the histogram, learnt from a finite set of samples. For instance, we observed 10 samples of the RSSI of a Wi-Fi access point, ranging from -40dB to -90dB. Then, we can derive the histogram distributing the samples in to 10dB sized bins. However, due to the limited number of samples, we may result in a coarse-grained shape. KDE is used to deal with such situations. The key idea is to “leak” some probability density into neighboring bins. To achieve this goal, KDE involves a kernel, commonly uniform, triangular, bi-weight, normal, or others, and apply it across the histogram. An intuitive example could be found on the Wikipedia with normal kernel. Thus, to perform KDE, one needs to choose an appropriate kernel, as well as a bandwidth for the kernel. Generally, KDE is an empirical method to make the discrete probability density function more reasonable. However, one definitely need to understand the domain knowledge to ensure that KDE really makes some sense. </p>
<h2><span id="apriori-algorithm">Apriori Algorithm</span></h2><p>Apriori is a classic algorithm for mining association rules in a large dataset. One famous application of Apriori is to mine common merchandise itemset bought by customers. There are two key metric in Apriori, i.e., support and confidence. Support quantify the number of transactions containing the itemset of interest. For instance, there are a total of 1000 transactions where 100 of them contains both bread and butter, then the support ratio is 100/1000=0.1. Another important metric is the confidence which measures the reasoning confidence. Use the same example. If 200 transactions contains bread and only 100 of them have butter, then the confidence is 100/200. In other words, we have 50% confidence to say that if someone buy break, she will also buy butter. Before mining the dataset, one need to specify these two metrics. Typically, confidence is set to a very high value like 99% to ensure the derived rules are significant and meaningful. The ratio of support depends heavily to the domain knowledge. In the market transaction example, support needs to be high to motivate the rearrange the goods being aware of the cost. However, in some cases, we focus more on the confidence, where the support could be low. </p>
<p>The algorithm works in a bottom up way. Apriori first finds out all one-item sets with support higher than the chosen metric. Then it elaborate all combinations of one-item sets to form two-item sets. The process keeps on until no more higher level set satisfies the support metric. Then, Aporiori applies the confidence metric to filter out invalid itemsets. Apriori is with many implementations which can be found easily.</p>

      
    </div>
    <footer class="entry-meta entry-footer">
      
	<span class="ico-folder"></span>
    <a class="article-category-link" href="/blog/categories/Tech/">Tech</a>

      
  <span class="ico-tags"></span>
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/blog/tags/tool-collection/">tool collection</a></li></ul>

      
    </footer>
    <hr class="entry-footer-hr">
  </div>
  
</article>

<!-- Table of Contents -->

  
    <article id="post-yangming"  class="article article-type-post" itemscope itemprop="blogPost" >
  <div id="articleInner" class="clearfix post-1016 post type-post status-publish format-standard has-post-thumbnail hentry category-template-2 category-uncategorized tag-codex tag-edge-case tag-featured-image tag-image tag-template">
    
    
      <header class="article-header">
        
  
    <h1 class="thumb" itemprop="name">
      <a class="article-title" href="/blog/yangming/">阳明先生的哲学</a>
    </h1>
  

      </header>
    
    <div class="article-meta">
      
	<a href="/blog/yangming/" class="article-date">
	  <time datetime="2016-12-02T16:00:00.000Z" itemprop="datePublished">December 3, 2016</time>
	</a>

      
	<span class="ico-folder"></span>
    <a class="article-category-link" href="/blog/categories/Thinking/">Thinking</a>
 
      
    </div>
    <div class="article-entry" itemprop="articleBody">
      
        <p>王守仁，幼名云，字伯安，浙江余姚人。初次接触阳明先生是通过《明朝那些事》，作者当年明月称其为“一个高尚的人，一个纯粹的人，一个有道德的人，一个脱离了低级趣味的人，一个有益于人民的人”。阳明先生对后世的影响应首推其哲学，当时称之为“心学”，可惜《明朝那些事》里讲得更多的是他的事迹，虽然提到“知行合一”但没有解释清楚其内在含义。所以虽然读了《明朝那些事》，阳明先生的思想在我看来还是雾里看花。</p>
<p>阳明先生虽然在哲学界享有盛名，但其知名度并不高。这是个很奇怪的现象，其原因可能有二：其一，阳明先生似乎并不喜欢著书，最为著名的《传习录》也由其弟子收集整理，类似于《论语》。其实大部头的书籍并不符合他的性格，他崇尚简洁，其倡导的观念归纳起来寥寥数句而已，何须长篇累牍。其二，阳明先生所推崇的思想在当代看来是赤裸裸的唯心主义。在这“唯物主义”的意识形态下，这纯粹是封建社会糟粕，不禁止就不错了，怎会大张旗鼓地宣传？当然，这或许也与某些人十分崇拜他有关吧。</p>
<p>我对阳明先生的肤浅理解其实仅仅来源于《传习录》。个人拙见，其思想的根源可以归纳为“人心即天地”，《传习录》有：</p>
<blockquote>
<p>‘心犹镜也。圣人心如明镜。常人心如昏镜。近世格物之说，如以镜照物，照上用功。不知镜尚昏在，何能照？先生之格物，如磨镜而使之明。磨上用功。明了后亦未尝废照’ </p>
</blockquote>
<p>此类语句在《传习录》中还有很多。</p>
<p>所以，人们真正该用功的地方乃是磨练自己的内心。“知行合一”或“天泉桥话别”为阳明先生解释如何磨练人心的具体方法。其中“知行合一”被许多人认为是阳明先生的思想核心，我认为其原因是：这句话说起来朗朗上口容易引起“共鸣”，没有真正理解其意义的读者往往以为类似“行胜于言”或“言行合一”，其实差之毫厘谬以千里。</p>
<p>明白了阳明先生的哲学，就清楚人的成长没有捷径。人成长的过程即人心接受历练的过程，不经历诸多繁杂事务决不能“动心忍性增益其所不能”。同时，正由于人心即天地，“磨镜而使之明”就成为了唯一和终极的人生目标，看清这一点，才会明白什么成长过程中遇到的障碍不过“磨镜”的石头而已，应敞开胸怀地迎接，而不是畏首畏尾地逃避。</p>
<p>2016-05-01：理解了“知行合一”，就明白为什么说评价一个人不要看他说过什么，而要看他做过什么。他说出来的话不一定代表他最真实的想法，而做的事情必然是最符合他的内心的。</p>

      
    </div>
    <footer class="entry-meta entry-footer">
      
	<span class="ico-folder"></span>
    <a class="article-category-link" href="/blog/categories/Thinking/">Thinking</a>

      
  <span class="ico-tags"></span>
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/blog/tags/Learning/">Learning</a></li></ul>

      
    </footer>
    <hr class="entry-footer-hr">
  </div>
  
</article>

<!-- Table of Contents -->

  
    <article id="post-install-octave-on-osx-ei-capitan-10113"  class="article article-type-post" itemscope itemprop="blogPost" >
  <div id="articleInner" class="clearfix post-1016 post type-post status-publish format-standard has-post-thumbnail hentry category-template-2 category-uncategorized tag-codex tag-edge-case tag-featured-image tag-image tag-template">
    
    
      <header class="article-header">
        
  
    <h1 class="thumb" itemprop="name">
      <a class="article-title" href="/blog/install-octave-on-osx-ei-capitan-10113/">Install Octave on OSX EI Capitan 10.11.3</a>
    </h1>
  

      </header>
    
    <div class="article-meta">
      
	<a href="/blog/install-octave-on-osx-ei-capitan-10113/" class="article-date">
	  <time datetime="2016-12-02T16:00:00.000Z" itemprop="datePublished">December 3, 2016</time>
	</a>

      
	<span class="ico-folder"></span>
    <a class="article-category-link" href="/blog/categories/Tech/">Tech</a>
 
      
    </div>
    <div class="article-entry" itemprop="articleBody">
      
        <p>Installing Octave on the latest OSX can be error prone. One may download the Octave-Forge bundle from sourceforge <a href="https://sourceforge.net/projects/octave/files/Octave%20MacOSX%20Binary/2013-12-30%20binary%20installer%20of%20Octave%203.8.0%20for%20OSX%2010.9.1%20%28beta%29/" target="_blank" rel="noopener">here</a> which however is large and also a bit out of date. </p>
<!--break-->
<p>Alternatively, if you use homebrew to do this, please be ware of<br>a few traps. Here are the steps I adopted to successfully install Octave.<br>If you do not have Xcode or Homebrew installed yet, please refer to Google<br>to get them installed properly.</p>
<h3><span id="1-preliminaries">1. Preliminaries</span></h3><ul>
<li>Install XQuartz from <a href="http://www.xquartz.org/" target="_blank" rel="noopener">here</a>.</li>
<li>Install gcc with (this is for gfortran).</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ brew install gcc</span><br></pre></td></tr></table></figure>
<p>It may take quite some time to install gcc from source. If you cannot wait, do xcode-select –install before install gcc. This will have mac install a pre-compiled version which is very fast.</p>
<h3><span id="2-import-the-scientific-computing-packages-with">2. Import the scientific computing packages with</span></h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ brew update &amp;&amp; brew upgrade</span><br><span class="line">$ brew tap homebrew/science</span><br></pre></td></tr></table></figure>
<p>If you see any warnings, run</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ brew doctor</span><br></pre></td></tr></table></figure>
<p>and follow any suggestions to fix the problem. And then re-import the packages as follows</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ brew untap homebrew/science</span><br><span class="line">$ brew tap homebrew/science</span><br></pre></td></tr></table></figure>
<h3><span id="3-install-octave">3. Install Octave</span></h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ brew install octave --without-docs</span><br></pre></td></tr></table></figure>
<p>The option <em>–without-docs</em> above is to suppress errors due to missing Tex installation. </p>
<h3><span id="4-install-gnuplot">4. Install gnuplot</span></h3><p>As gnuplot will automatically be installed with octave, but without support for X11. So we need to reinstall it properly.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ brew uninstall gnuplot</span><br><span class="line">$ brew install gnuplot --with-x</span><br></pre></td></tr></table></figure>
<p>To me, I still got the following warnings after the steps above.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">warning: ft_render: unable to load appropriate font</span><br><span class="line">warning: could not match any font: *-normal-normal-10</span><br></pre></td></tr></table></figure>
<p>It can be fixed by following this stack overflow <a href="http://stackoverflow.com/questions/35249881/octave-fontconfig-error" target="_blank" rel="noopener">post</a>. Simply put it here where you should add this line into your ~/.bash_profile.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">export FONTCONFIG_PATH=/opt/X11/lib/X11/fontconfig</span><br></pre></td></tr></table></figure>
<p>And run</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ source ~/.bash_profile</span><br></pre></td></tr></table></figure>
<p>to reload the config within your terminal. Alternatively, you could restart your teminal.</p>
<h3><span id="5-configurations">5. Configurations</span></h3><p>Put the following configurations into <em>~/.octaverc</em>. If there’s no such file, just create one yourself.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">setenv (&quot;GNUTERM&quot;, &quot;X11&quot;)</span><br><span class="line"></span><br><span class="line"># optional if you are in favor of a more elegant prompt.</span><br><span class="line">PS1(&apos;❯❯ &apos;)</span><br></pre></td></tr></table></figure>

      
    </div>
    <footer class="entry-meta entry-footer">
      
	<span class="ico-folder"></span>
    <a class="article-category-link" href="/blog/categories/Tech/">Tech</a>

      
  <span class="ico-tags"></span>
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/blog/tags/octave/">octave</a></li></ul>

      
    </footer>
    <hr class="entry-footer-hr">
  </div>
  
</article>

<!-- Table of Contents -->

  


  <nav id="page-nav">
    
    <a class="extend prev" rel="prev" href="/blog/page/3/">Prev</a><a class="page-number" href="/blog/">1</a><a class="page-number" href="/blog/page/2/">2</a><a class="page-number" href="/blog/page/3/">3</a><span class="page-number current">4</span><a class="page-number" href="/blog/page/5/">5</a><a class="page-number" href="/blog/page/6/">6</a><a class="extend next" rel="next" href="/blog/page/5/">Next</a>
  </nav>

</section>
          <aside id="sidebar">
  
    <div style="margin: 20px 0;">
	<div id="search-form-wrap">

    <form class="search-form">
        <label style="width: 72%;">
            <span class="screen-reader-text">Search for:</span>
            <input type="search" class="search-field" style="height: 36px; width: 100%;" placeholder=" Search…" value="" name="s" title="Search for:">
        </label>
        <input type="submit" class="search-form-submit" value="Search">
    </form>
    <div class="ins-search">
    <div class="ins-search-mask"></div>
    <div class="ins-search-container">
        <div class="ins-input-wrapper">
            <input type="text" class="ins-search-input" placeholder="Type something..."/>
            <span class="ins-close ins-selectable"><i class="fa fa-times-circle"></i></span>
        </div>
        <div class="ins-section-wrapper">
            <div class="ins-section-container"></div>
        </div>
    </div>
</div>
<script>
(function (window) {
    var INSIGHT_CONFIG = {
        TRANSLATION: {
            POSTS: 'Posts',
            PAGES: 'Pages',
            CATEGORIES: 'Categories',
            TAGS: 'Tags',
            UNTITLED: '(Untitled)',
        },
        ROOT_URL: '/blog/',
        CONTENT_URL: '/blog/content.json',
    };
    window.INSIGHT_CONFIG = INSIGHT_CONFIG;
})(window);
</script>
<script src="/blog/js/insight.js"></script>

</div>
</div>
  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Connect With Us</h3>
    <div class="widget widget_athemes_social_icons">

    	<ul class="clearfix widget-social-icons">   
    	
   			<li><a href="https://www.linkedin.com/in/liqunli/" title="Linkedin"><i class="fa fa-linkedin" aria-hidden="true"></i></a></li> 

   		
   			<li><a href="https://scholar.google.com/citations?user=icgetesAAAAJ&amp;hl=en" title="Google Scholar"><i class="fa fa-google scholar" aria-hidden="true"></i></a></li> 

   		
   			<li><a href="https://500px.com/liqul" title="500Px"><i class="fa fa-500px" aria-hidden="true"></i></a></li> 

   		
   		</ul>


   		<!--
   		<ul class="clearfix widget-social-icons">   		
   		<li class="widget-si-twitter"><a href="http://twitter.com" title="Twitter"><i class="ico-twitter"></i></a></li> 
		<li class="widget-si-facebook"><a href="http://facebook.com" title="Facebook"><i class="ico-facebook"></i></a></li>
			<li class="widget-si-gplus"><a href="http://plus.google.com" title="Google+"><i class="ico-gplus"></i></a></li>
			<li class="widget-si-pinterest"><a href="http://pinterest.com" title="Pinterest"><i class="ico-pinterest"></i></a></li>
			<li class="widget-si-flickr"><a href="http://flickr.com" title="Flickr"><i class="ico-flickr"></i></a></li>
			<li class="widget-si-instagram"><a href="http://instagram.com" title="Instagram"><i class="ico-instagram"></i></a></li>
		</ul> -->

    </div>
  </div>


  
    
  <div class="widget_athemes_tabs">
    <ul id="widget-tab" class="clearfix widget-tab-nav">
      <li class="active"><a>Recent Posts</a></li>
    </ul>
    <div class="widget">
      <ul>
        
          <li class="clearfix">

            
              <div class="widget-entry-summary" style="margin: 0;">
            

              <h6 style="margin: 0;"><a href="/blog/news-2019/">新闻记录-2019</a></h6>
              <span>March 10, 2019</span>
            </div>

          </li>
        
          <li class="clearfix">

            
              <div class="widget-entry-summary" style="margin: 0;">
            

              <h6 style="margin: 0;"><a href="/blog/currency-depreciation/">金融概念整理——货币贬值</a></h6>
              <span>March 8, 2019</span>
            </div>

          </li>
        
          <li class="clearfix">

            
              <div class="widget-entry-summary" style="margin: 0;">
            

              <h6 style="margin: 0;"><a href="/blog/linux-delete-file/">Linux下文件删除的规则</a></h6>
              <span>March 8, 2019</span>
            </div>

          </li>
        
          <li class="clearfix">

            
              <div class="widget-entry-summary" style="margin: 0;">
            

              <h6 style="margin: 0;"><a href="/blog/housing-price-as-indicator/">金融概念整理——房价指标</a></h6>
              <span>March 7, 2019</span>
            </div>

          </li>
        
          <li class="clearfix">

            
              <div class="widget-entry-summary" style="margin: 0;">
            

              <h6 style="margin: 0;"><a href="/blog/credit-spread/">金融概念整理——信用利差（credit spread）</a></h6>
              <span>March 6, 2019</span>
            </div>

          </li>
        
          <li class="clearfix">

            
              <div class="widget-entry-summary" style="margin: 0;">
            

              <h6 style="margin: 0;"><a href="/blog/news/">新闻纪录-2018</a></h6>
              <span>January 3, 2019</span>
            </div>

          </li>
        
      </ul>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Categories</h3>
    <div class="widget">
      <ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/blog/categories/Book-Reading/">Book Reading</a><span class="category-list-count">3</span></li><li class="category-list-item"><a class="category-list-link" href="/blog/categories/Finance/">Finance</a><span class="category-list-count">4</span></li><li class="category-list-item"><a class="category-list-link" href="/blog/categories/News/">News</a><span class="category-list-count">2</span></li><li class="category-list-item"><a class="category-list-link" href="/blog/categories/Photography/">Photography</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/blog/categories/Reading/">Reading</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/blog/categories/Tech/">Tech</a><span class="category-list-count">40</span></li><li class="category-list-item"><a class="category-list-link" href="/blog/categories/Thinking/">Thinking</a><span class="category-list-count">2</span></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Tag Cloud</h3>
    <div class="widget tagcloud">
      <a href="/blog/tags/AI/" style="font-size: 10px;">AI</a> <a href="/blog/tags/Consensus/" style="font-size: 10px;">Consensus</a> <a href="/blog/tags/Copycat/" style="font-size: 10px;">Copycat</a> <a href="/blog/tags/Deadlock/" style="font-size: 10px;">Deadlock</a> <a href="/blog/tags/Finance/" style="font-size: 10px;">Finance</a> <a href="/blog/tags/HBase/" style="font-size: 10px;">HBase</a> <a href="/blog/tags/Housing/" style="font-size: 10px;">Housing</a> <a href="/blog/tags/IMU/" style="font-size: 10px;">IMU</a> <a href="/blog/tags/Learning/" style="font-size: 10px;">Learning</a> <a href="/blog/tags/Linux/" style="font-size: 10px;">Linux</a> <a href="/blog/tags/MVCC/" style="font-size: 10px;">MVCC</a> <a href="/blog/tags/Mapreduce/" style="font-size: 10px;">Mapreduce</a> <a href="/blog/tags/Mysql/" style="font-size: 10px;">Mysql</a> <a href="/blog/tags/OOM/" style="font-size: 10px;">OOM</a> <a href="/blog/tags/Raft/" style="font-size: 18px;">Raft</a> <a href="/blog/tags/Uniqueness/" style="font-size: 10px;">Uniqueness</a> <a href="/blog/tags/accelerometer/" style="font-size: 10px;">accelerometer</a> <a href="/blog/tags/admission-control/" style="font-size: 10px;">admission control</a> <a href="/blog/tags/aurora/" style="font-size: 10px;">aurora</a> <a href="/blog/tags/big-data/" style="font-size: 20px;">big data</a> <a href="/blog/tags/compaction/" style="font-size: 10px;">compaction</a> <a href="/blog/tags/compass/" style="font-size: 10px;">compass</a> <a href="/blog/tags/consistency/" style="font-size: 12px;">consistency</a> <a href="/blog/tags/credit-spread/" style="font-size: 10px;">credit spread</a> <a href="/blog/tags/currency/" style="font-size: 10px;">currency</a> <a href="/blog/tags/distributed/" style="font-size: 10px;">distributed</a> <a href="/blog/tags/elasticsearch/" style="font-size: 10px;">elasticsearch</a> <a href="/blog/tags/flink/" style="font-size: 10px;">flink</a> <a href="/blog/tags/git/" style="font-size: 12px;">git</a> <a href="/blog/tags/gyroscope/" style="font-size: 10px;">gyroscope</a> <a href="/blog/tags/hbase/" style="font-size: 10px;">hbase</a> <a href="/blog/tags/investment/" style="font-size: 10px;">investment</a> <a href="/blog/tags/links/" style="font-size: 10px;">links</a> <a href="/blog/tags/lock/" style="font-size: 14px;">lock</a> <a href="/blog/tags/mapreduce/" style="font-size: 12px;">mapreduce</a> <a href="/blog/tags/mysql/" style="font-size: 10px;">mysql</a> <a href="/blog/tags/nginx/" style="font-size: 10px;">nginx</a> <a href="/blog/tags/non-blocking/" style="font-size: 10px;">non-blocking</a> <a href="/blog/tags/octave/" style="font-size: 10px;">octave</a> <a href="/blog/tags/openstack/" style="font-size: 10px;">openstack</a> <a href="/blog/tags/photography/" style="font-size: 10px;">photography</a> <a href="/blog/tags/php/" style="font-size: 12px;">php</a> <a href="/blog/tags/quorum/" style="font-size: 10px;">quorum</a> <a href="/blog/tags/rabbitmq/" style="font-size: 16px;">rabbitmq</a> <a href="/blog/tags/replication/" style="font-size: 10px;">replication</a> <a href="/blog/tags/sbt/" style="font-size: 10px;">sbt</a> <a href="/blog/tags/scala/" style="font-size: 10px;">scala</a> <a href="/blog/tags/spark/" style="font-size: 10px;">spark</a> <a href="/blog/tags/ssd/" style="font-size: 10px;">ssd</a> <a href="/blog/tags/storage/" style="font-size: 10px;">storage</a> <a href="/blog/tags/swift/" style="font-size: 10px;">swift</a> <a href="/blog/tags/tool-collection/" style="font-size: 10px;">tool collection</a> <a href="/blog/tags/transaction/" style="font-size: 10px;">transaction</a> <a href="/blog/tags/国史大纲/" style="font-size: 10px;">国史大纲</a> <a href="/blog/tags/洪业/" style="font-size: 10px;">洪业</a> <a href="/blog/tags/认知/" style="font-size: 10px;">认知</a>
    </div>
  </div>

  
</aside>
        
      </div>

    </div>
    <!-- <nav id="mobile-nav">
  
    <a href="/blog/" class="mobile-nav-link">Home</a>
  
    <a href="/blog/archives" class="mobile-nav-link">Archives</a>
  
    <a href="/blog/categories" class="mobile-nav-link">Categories</a>
  
    <a href="/blog/tags" class="mobile-nav-link">Tags</a>
  
    <a href="/blog/about" class="mobile-nav-link">About</a>
  
</nav> -->
    <footer id="footer" class="site-footer">
  

  <div class="clearfix container">
      <div class="site-info">
	      &copy; 2019 Bucket &amp; Hammer All Rights Reserved.
        
            <span id="busuanzi_container_site_uv">
              本站访客数<span id="busuanzi_value_site_uv"></span>人次  
              本站总访问量<span id="busuanzi_value_site_pv"></span>次
            </span>
          
      </div>
      <div class="site-credit">
        Theme by <a href="https://github.com/iTimeTraveler/hexo-theme-hipaper" target="_blank">hipaper</a>
      </div>
  </div>
</footer>


<!-- min height -->

<script>
    var wrapdiv = document.getElementById("wrap");
    var contentdiv = document.getElementById("content");

    wrapdiv.style.minHeight = document.body.offsetHeight - document.getElementById("allheader").offsetHeight - document.getElementById("footer").offsetHeight + "px";
    contentdiv.style.minHeight = document.body.offsetHeight - document.getElementById("allheader").offsetHeight - document.getElementById("footer").offsetHeight + "px";


    <!-- headerblur min height -->
    
    
</script>
    
<div style="display: none;">
  <script src="https://s11.cnzz.com/z_stat.php?id=1260716016&web_id=1260716016" language="JavaScript"></script>
</div>

<!-- mathjax config similar to math.stackexchange -->

<script type="text/x-mathjax-config">
  MathJax.Hub.Config({
    tex2jax: {
      inlineMath: [ ['$','$'], ["\\(","\\)"] ],
      processEscapes: true
    }
  });
</script>

<script type="text/x-mathjax-config">
    MathJax.Hub.Config({
      tex2jax: {
        skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code']
      }
    });
</script>

<script type="text/x-mathjax-config">
    MathJax.Hub.Queue(function() {
        var all = MathJax.Hub.getAllJax(), i;
        for(i=0; i < all.length; i += 1) {
            all[i].SourceElement().parentNode.className += ' has-jax';
        }
    });
</script>

<script type="text/javascript" src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML">
</script>


  <link rel="stylesheet" href="/blog/fancybox/jquery.fancybox.css">
  <script src="/blog/fancybox/jquery.fancybox.pack.js"></script>


<script src="/blog/js/script.js"></script>
<script src="/blog/js/bootstrap.js"></script>
<script src="/blog/js/main.js"></script>








	<script async src="//dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js">
	</script>






  </div>

  <a id="rocket" href="#top" class=""></a>
  <script type="text/javascript" src="/js/totop.js" async=""></script>
</body>
</html>
