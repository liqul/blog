<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  
  <title>Tag: big data | Liqun&#39;s Homepage</title>
  <meta name="description" content="" />
  <meta name="keywords" content="" />
  <meta name="HandheldFriendly" content="True" />
  <meta name="apple-mobile-web-app-capable" content="yes">
  <link rel="shortcut icon" href="/blog/">
  <link rel="alternate" href="/blog/atom.xml" title="Liqun's Homepage">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta property="og:type" content="website">
<meta property="og:title" content="Liqun&#39;s Homepage">
<meta property="og:url" content="liqul.github.io/blog/tags/big-data/index.html">
<meta property="og:site_name" content="Liqun&#39;s Homepage">
<meta property="og:locale" content="default">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Liqun&#39;s Homepage">
    
  <link href="https://fonts.googleapis.com/css?family=Inconsolata|Titillium+Web" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css?family=Roboto+Mono" rel="stylesheet">
  <link href='//cdn.bootcss.com/node-waves/0.7.5/waves.min.css' rel='stylesheet'>
  <link rel="stylesheet" href="/blog/style.css">
  <script>
    function setLoadingBarProgress(num) {
      document.getElementById('loading-bar').style.width=num+"%";
    }
  </script>
</head>

<body>
  <div id="loading-bar-wrapper">
  <div id="loading-bar"></div>
</div>


  <script>setLoadingBarProgress(20)</script> 
  <header class="l_header">
	<div class='wrapper'>
		<div class="nav-main container container--flex">
			<a class="logo flat-box" href='/blog/' >
				Liqun's Homepage
			</a>
			<div class='menu'>
				<ul class='h-list'>
					
						<li>
							<a class='flat-box nav-home' href='/blog/'>
								Home
							</a>
						</li>
					
						<li>
							<a class='flat-box nav-archives' href='/blog/archives'>
								Archives
							</a>
						</li>
					
						<li>
							<a class='flat-box nav-gallery' href='https://photos.google.com/album/AF1QipNoqKYgspQo5O1YhlFXGCQ7p575KBH3Yxf8WHL4?hl=zh-CN'>
								Gallery
							</a>
						</li>
					
						<li>
							<a class='flat-box nav-about' href='/blog/about'>
								About
							</a>
						</li>
					
				</ul>
				<div class='underline'></div>
			</div>
			
				<div class="m_search">
					<form name="searchform" class="form u-search-form">
						<input type="text" class="input u-search-input" placeholder="Search" />
						<span class="icon icon-search"></span>
					</form>
				</div>
			
			<ul class='switcher h-list'>
				
					<li class='s-search'><a href='javascript:void(0)'><span class="icon icon-search flat-box"></span></a></li>
				
				<li class='s-menu'><a href='javascript:void(0)'><span class="icon icon-menu flat-box"></span></a></li>
			</ul>
		</div>
		
		<div class='nav-sub container container--flex'>
			<a class="logo" class="flat-box" href='javascript:void(0)'>
				Word of Forks
			</a>

			<ul class='switcher h-list'>
				<li class='s-comment'><a href='javascript:void(0)'><span class="icon icon-chat_bubble_outline flat-box"></span></a></li>
				<li class='s-top'><a href='javascript:void(0)'><span class="icon icon-arrow_upward flat-box"></span></a></li>
				<li class='s-toc'><a href='javascript:void(0)'><span class="icon icon-format_list_numbered flat-box"></span></a></li>
			</ul>
		</div>
	</div>
</header>
<aside class="menu-phone">
	<nav>
		
			<a href="/blog/" class="nav-home nav">
				Home
			</a>
		
			<a href="/blog/archives" class="nav-archives nav">
				Archives
			</a>
		
			<a href="https://photos.google.com/album/AF1QipNoqKYgspQo5O1YhlFXGCQ7p575KBH3Yxf8WHL4?hl=zh-CN" class="nav-gallery nav">
				Gallery
			</a>
		
			<a href="/blog/about" class="nav-about nav">
				About
			</a>
		
	</nav>
</aside>

    <script>setLoadingBarProgress(40);</script>
  <div class="l_body">
    <div class='container clearfix'>
      <div class='l_main'>
        
  <script>
    window.subData= { title:'Tag : big data'}
  </script>

<section class="post-list">
	
    <div class='post-wrapper'>
      <article class="post reveal">
  <section class="meta">
    
    <h2 class="title">
      <a href="/blog/flink/">
        Reading &#34;State Management in Apache Flink&#34;
      </a>
    </h2>
    
    <time>
      Sep 9, 2018
    </time>
		
    
    <div class='cats'>
        <a href="/blog/categories/Tech/">Tech</a>
    </div>

  </section>
  <section class="article typo">
	  <div class="tip"><br>Updated on 2018-09-09<br></div>

<p>I’m playing with Flink (1.6) and Structured Streaming (2.3.1) recently. I’m no expert for either framework, so my opinion is based on my very short experience with each of them. </p>

    
	  <div class="readmore">
      <a href="/blog/flink/">Read More</a>
    </div>
    
    
    
	  <div class="full-width auto-padding tags">
      
        <a href="/blog/tags/big-data/">big data</a>
      
        <a href="/blog/tags/flink/">flink</a>
      
	  </div>
    
  </section>
</article>
    </div>
  
    <div class='post-wrapper'>
      <article class="post reveal">
  <section class="meta">
    
    <h2 class="title">
      <a href="/blog/hbase/">
        Notes on HBase
      </a>
    </h2>
    
    <time>
      Apr 17, 2018
    </time>
		
    
    <div class='cats'>
        <a href="/blog/categories/Tech/">Tech</a>
    </div>

  </section>
  <section class="article typo">
	  <p>So far as I know, HBase is the first open source “table” style storage in the big data scope. It is an implementation of the <a href="https://research.google.com/archive/bigtable-osdi06.pdf" target="_blank" rel="noopener">BigTable paper</a> presented by Google. If you read the paper or the <a href="https://hbase.apache.org/book.html" target="_blank" rel="noopener">reference guide</a>, HBase does not look like a table. The paper tells you that it is a </p>
<blockquote>
<p>sparse, distributed, persistent, multidimensional sorted map.</p>
</blockquote>

    
	  <div class="readmore">
      <a href="/blog/hbase/">Read More</a>
    </div>
    
    
    
	  <div class="full-width auto-padding tags">
      
        <a href="/blog/tags/big-data/">big data</a>
      
        <a href="/blog/tags/HBase/">HBase</a>
      
	  </div>
    
  </section>
</article>
    </div>
  
    <div class='post-wrapper'>
      <article class="post reveal">
  <section class="meta">
    
    <h2 class="title">
      <a href="/blog/consistency_model/">
        Eventual Consistency vs. Strong Consistency
      </a>
    </h2>
    
    <time>
      Mar 16, 2018
    </time>
		
    
    <div class='cats'>
        <a href="/blog/categories/Tech/">Tech</a>
    </div>

  </section>
  <section class="article typo">
	  <p><a href="https://cloud.google.com/datastore/docs/articles/balancing-strong-and-eventual-consistency-with-google-cloud-datastore/" target="_blank" rel="noopener">Here</a> is a very good explanation about eventual consistency and strong consistency. I’d like to borrow the two figures on that page below:</p>
<p><img src="/blog/assets/eventual-consistency.png"><br>Fig. 1 figure for eventual consistency</p>

    
	  <div class="readmore">
      <a href="/blog/consistency_model/">Read More</a>
    </div>
    
    
    
	  <div class="full-width auto-padding tags">
      
        <a href="/blog/tags/big-data/">big data</a>
      
        <a href="/blog/tags/distributed/">distributed</a>
      
        <a href="/blog/tags/consistency/">consistency</a>
      
	  </div>
    
  </section>
</article>
    </div>
  
    <div class='post-wrapper'>
      <article class="post reveal">
  <section class="meta">
    
    <h2 class="title">
      <a href="/blog/experience_with_mr_memory_parameters/">
        Notes on MR memory issues
      </a>
    </h2>
    
    <time>
      Feb 5, 2018
    </time>
		
    
    <div class='cats'>
        <a href="/blog/categories/Tech/">Tech</a>
    </div>

  </section>
  <section class="article typo">
	  <div class="tip"><br>Updated on 2018-02-05<br></div>

<p>I recently encountered several OOMs from mapper tasks reading parquet files. The yarn container is killed due to running out of physical memory. Since I already set the JVM memory to 0.8 of the container size, I’m pretty sure that this is due to off-heap memory allocation issues. I found the two jira issues <a href="https://issues.apache.org/jira/browse/SPARK-4073" target="_blank" rel="noopener">here</a> and <a href="https://issues.apache.org/jira/browse/PARQUET-118" target="_blank" rel="noopener">here</a>, pointing me to the snappy codec used by parquet for decompression. There aren’t so much I can do except allocating more memory beside the JVM.  </p>

    
	  <div class="readmore">
      <a href="/blog/experience_with_mr_memory_parameters/">Read More</a>
    </div>
    
    
    
	  <div class="full-width auto-padding tags">
      
        <a href="/blog/tags/big-data/">big data</a>
      
        <a href="/blog/tags/Mapreduce/">Mapreduce</a>
      
        <a href="/blog/tags/OOM/">OOM</a>
      
	  </div>
    
  </section>
</article>
    </div>
  
    <div class='post-wrapper'>
      <article class="post reveal">
  <section class="meta">
    
    <h2 class="title">
      <a href="/blog/quorum_in_amazon_aurora/">
        Quorum in Amazon Aurora
      </a>
    </h2>
    
    <time>
      Oct 27, 2017
    </time>
		
    
    <div class='cats'>
        <a href="/blog/categories/Tech/">Tech</a>
    </div>

  </section>
  <section class="article typo">
	  <p>I recently read a serial of posts about the quorum mechanism in Amazon Aurora, which is a distributed relational database. These posts are: </p>
<ul>
<li><a href="/blog/assets/Amazon Aurora under the hood_ quorums and correlated failure _ AWS Database Blog.pdf">post1</a>: quorums and correlated failure.</li>
<li><a href="/blog/assets/Amazon Aurora Under the Hood_ Quorum Reads and Mutating State _ AWS Database Blog.pdf">post2</a>: quorum reads and mutating state.</li>
<li><a href="/blog/assets/Amazon Aurora Under the Hood_ Reducing Costs Using Quorum Sets _ AWS Database Blog.pdf">post3</a>: reducing costs using quorum sets.</li>
<li><a href="/blog/assets/Amazon Aurora Under the Hood_ Quorum Membership _ AWS Database Blog.pdf">post4</a>: quorum membership.

    
	  <div class="readmore">
      <a href="/blog/quorum_in_amazon_aurora/">Read More</a>
    </div>
    
    
    
	  <div class="full-width auto-padding tags">
      
        <a href="/blog/tags/big-data/">big data</a>
      
        <a href="/blog/tags/quorum/">quorum</a>
      
        <a href="/blog/tags/amazon-aurora/">amazon aurora</a>
      
	  </div>
    
  </section>
</article>
    </div>
  
    <div class='post-wrapper'>
      <article class="post reveal">
  <section class="meta">
    
    <h2 class="title">
      <a href="/blog/new_apache_hbase_mob_compaction_policy/">
        Reading the New Apache HBase MOB Compaction Policy
      </a>
    </h2>
    
    <time>
      Aug 29, 2017
    </time>
		
    
    <div class='cats'>
        <a href="/blog/categories/Tech/">Tech</a>
    </div>

  </section>
  <section class="article typo">
	  <p>In case you want to understand more on MOB (Moderate Object Storage), you may refer to this <a href="https://issues.apache.org/jira/browse/HBASE-11339" target="_blank" rel="noopener">issue</a>. Basically, hbase was first introduced with capability of storing mainly small objects (&lt;100k). Moderate objects stand for files from 100k to 10m. </p>
<p>Recently, there is a <a href="https://blog.cloudera.com/blog/2017/06/introducing-apache-hbase-medium-object-storage-mob-compaction-partition-policies/?elqTrackId=2a7ed08f6935464e84b51ad5a8f15cb2&amp;elq=896612af50b741d7b8bf576ac30276e4&amp;elqaid=4662&amp;elqat=1&amp;elqCampaignId=2850" target="_blank" rel="noopener">blog</a> introducing the new compaction policy for MOB files. The problem with the initial approach is multiple compaction. For instance, the goal is to compact the objects created in one calendar day into one big file. The compaction process starts after the first hour. The objects created in the first hour are compacted into a temporal file. Then, the objects created in the second hour, and the temporal file created for the first hour are compacted into a new temporal file…</p>

    
	  <div class="readmore">
      <a href="/blog/new_apache_hbase_mob_compaction_policy/">Read More</a>
    </div>
    
    
    
	  <div class="full-width auto-padding tags">
      
        <a href="/blog/tags/big-data/">big data</a>
      
        <a href="/blog/tags/hbase/">hbase</a>
      
        <a href="/blog/tags/compaction/">compaction</a>
      
	  </div>
    
  </section>
</article>
    </div>
  
    <div class='post-wrapper'>
      <article class="post reveal">
  <section class="meta">
    
    <h2 class="title">
      <a href="/blog/notes-chain-replication/">
        Understanding Chain Replication
      </a>
    </h2>
    
    <time>
      Jul 28, 2017
    </time>
		
    
    <div class='cats'>
        <a href="/blog/categories/Tech/">Tech</a>
    </div>

  </section>
  <section class="article typo">
	  <p><img src="/blog/assets/chain_replication.svg" alt="Chain Replication"></p>
<p>I learned the idea of chain replication from <a href="https://github.com/hibari/hibari" target="_blank" rel="noopener">hibari</a>,</p>
<blockquote>
<p>Hibari is a production-ready, distributed, ordered key-value, big data store. Hibari uses chain replication for strong consistency, high-availability, and durability. Hibari has excellent performance especially for read and large value operations.</p>
</blockquote>

    
	  <div class="readmore">
      <a href="/blog/notes-chain-replication/">Read More</a>
    </div>
    
    
    
	  <div class="full-width auto-padding tags">
      
        <a href="/blog/tags/big-data/">big data</a>
      
        <a href="/blog/tags/distributed/">distributed</a>
      
        <a href="/blog/tags/replication/">replication</a>
      
	  </div>
    
  </section>
</article>
    </div>
  
    <div class='post-wrapper'>
      <article class="post reveal">
  <section class="meta">
    
    <h2 class="title">
      <a href="/blog/notes-learning-spark/">
        Spark学习笔记
      </a>
    </h2>
    
    <time>
      Jul 7, 2017
    </time>
		
    
    <div class='cats'>
        <a href="/blog/categories/Tech/">Tech</a>
    </div>

  </section>
  <section class="article typo">
	  <h2 id="Spark与Scala"><a href="#Spark与Scala" class="headerlink" title="Spark与Scala"></a>Spark与Scala</h2><p>在学习Spark之前务必对Scala有所理解，否则面对完全陌生的语法是很痛苦的。</p>
<p>Scala的一种入门方式是：</p>
<ol>
<li>学习<a href="https://www.coursera.org/learn/progfun1/home/welcome" target="_blank" rel="noopener">Scala 函数式程序设计原理</a>。这是Scala作者自己开的课程。没什么比语言作者更加能理解这门语言的了，是切入Scala编程的最好入门方式。课程习题参考了《计算机程序的构造和解释》一书，非常经典。</li>
<li>阅读《Scala in depth》一书，对一些Scala的重点概念有更加详细的讨论。</li>
<li>根据特定的topic，Google各种网络资料。</li>
</ol>

    
	  <div class="readmore">
      <a href="/blog/notes-learning-spark/">Read More</a>
    </div>
    
    
    
	  <div class="full-width auto-padding tags">
      
        <a href="/blog/tags/big-data/">big data</a>
      
        <a href="/blog/tags/spark/">spark</a>
      
	  </div>
    
  </section>
</article>
    </div>
  
    <div class='post-wrapper'>
      <article class="post reveal">
  <section class="meta">
    
    <h2 class="title">
      <a href="/blog/non-blocking-read/">
        Notes on Multi-versioned Storage
      </a>
    </h2>
    
    <time>
      Mar 31, 2017
    </time>
		
    
    <div class='cats'>
        <a href="/blog/categories/Tech/">Tech</a>
    </div>

  </section>
  <section class="article typo">
	  <p>I recently read the <a href="https://research.google.com/archive/spanner.html" target="_blank" rel="noopener">Spanner</a> paper. I realized that I cannot understand the idea of TrueTime and Non-blocking read well. Therefore, I did some research by googling the concept of non-blocking read, and came across this mysql <a href="https://dev.mysql.com/doc/refman/5.7/en/innodb-consistent-read.html" target="_blank" rel="noopener">document</a>. After reading it, I realized that my understanding of multi-versioned storage is incorrect. So I decide to put some notes here.</p>
<p>The key points of multi-versioned storage are:  </p>
<ol>
<li>version -&gt; the creation wall clock time of the object (or a vector time)</li>
<li>timestamp -&gt; the query time of the object</li>
<li>the association between the metadata and content should never be changed</li>
</ol>
<p>Each object is associated with a set of metadata. The metadata contains a timestamp field indicating the version of this object. For a concrete example, let’s define a storage model as follows:</p>
<p><img src="/blog/assets/objstore1.png" width="500"></p>
<p>Each metadata contains three fields</p>
<table>
<thead>
<tr>
<th>Field</th>
<th style="text-align:center">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>name</td>
<td style="text-align:center">name of the object. objects with the same name are deem to be the same object</td>
</tr>
<tr>
<td>ctime</td>
<td style="text-align:center">creation time</td>
</tr>
<tr>
<td>deleted</td>
<td style="text-align:center">1 means a tombstone</td>
</tr>
<tr>
<td>extra</td>
<td style="text-align:center">some extra metadata for this object</td>
</tr>
</tbody>
</table>
<p>Let’s use typical operations to clarify the usage of this data model. </p>
<p><strong>Put</strong><br>Put is adding a new versioned object into the storage. In the figure above, the first “obj1” is inserted at 2017-04-01 11:30:12. Inserting another object with the same name is simply adding a new entry to the table pointing to the new content. When an object is requested from client, only the one with the latest timestamp is returned. Therefore, from 2017-04-01 11:30:12 to 2017-04-02 11:31:25, the first obj1 is visible. After 2017-04-02 11:31:25, the client see only the second obj1. With this data model, there is no need to block writes during reading this object, since each operation is based solely on its timestamp. </p>
<p><strong>Delete</strong><br>Delete is simply by putting a tombstone for a certain object. Like the third obj1 in the example. No content is presented for this entry. The objects with a tombstone as the latest entry will be filtered out if requested from clients.</p>
<p><strong>Update</strong><br>In this context, update is different from putting new contents into the object, but altering the object’s metadata (e.g., the extra field in the table). Updating the fields beyond the unique key is less a problem. If we need to update even the name of the object, we need to perform two steps: (1) delete the original object; (2) put a new object with the new metadata. One need to keep these two steps in an atomic transaction.</p>
<p><strong>Search</strong><br>Search is usually based on metadata to find a set of objects. The difference with multi-versioned storage is that we only return an object with the latest timestamp. This could be achieved with a select clause like </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">SELECT t.* FROM (SELECT * FROM table WHERE xxx AND ctime &lt; NOW() ORDER BY ctime DESC) t GROUP BY t.name</span><br></pre></td></tr></table></figure>
<p>We then filter out tombstones reside in the result set.</p>
<p><strong>Get</strong><br>Get is first searching for the latest object before the operation time. Then, the pointer of content is handed over to the client. The client should read the content as soon as possible. Otherwise, the content may be deleted due to recycling.  </p>
<p><strong>Compact</strong><br>Compact refers to merge a set of contents into a big one. This is useful for example for HDFS to relief the name node’s burden of storing a large number of small files. The implementation of compaction is a bit tricky. One first merge the target set of contents into a big file. Then, insert a new entry for each  related object within an atomic transaction. For clarification, let’s suppose we need to compact obj2 and obj3 in our example. We first create a new content with both contents from the original obj2 and obj3. Then, we add new entries for obj2 and obj3, respectively. The tricky part is that the ctime for these two entries are just 1 second larger than the original two. </p>
<p><img src="/blog/assets/objstore2.png" width="600"></p>
<p>This may sounds weired at first. But think about the situation that a new entry for obj2 is put after we started but not finished compaction. In this case, the new content could be covered by the compaction if the ctime is larger than the new entry. We add 1 to the ctime. So, the new entry will either be later, or conflict with the compaction, leading to a failure. Upon such failure, the client simply retry to submit the new content. This should not be a real problem since compaction is a rare operation. </p>
<p>One may wonder why not simply updating the pointers in the original entries for obj2 and obj3. This actually breaks the third key points we mentioned at the beginning. It is important not changing the association. For example, if we want to get an object during compaction, reading may fail since the old contents may be deleted. Also, stale contents may be produced. More importantly, we may need very complicated transaction controls. </p>
<p><strong>Recycle</strong><br>Recycle is used to delete all deleted objects. The deleted objects could be find by searching for tombstones in the table. If a tombstone is detected, all entries before that can be deleted physically, including the tombstone itself. Delete a single content is straightforward. However, if a content is merged into a big file, we can carry out a similar process like compaction to delete the content physically. Old-versioned entries can also be recycled. Both recycling for deleted and old-versioned entries follows a certain policy. We can delete an entry once it has been out dated for a few days. This duration shouldn’t be too soon. Otherwise, we may recycle content being or to be read. </p>
<p>One can see that, with this multi-versioned storage model, all operations are much simpler without dependency to a locking system. We even do not rely on transaction, if compaction is not necessary. Let’s return to the three key parts at the beginning of this note. With a timestamp field, we already get the sense of version. As discussed above, the operation timestamp is critical as we need it to determine which object should be put into the result set. If data is stored across multiple machines, we need to synchronize their clock precisely. TrueTime is a API expose the uncertainty of time among different machines, and thus is critical for such large scale storage implementation. Finally, the association should not be broken, otherwise, we need complicated mechanisms to fix the issues it incurs.</p>


    
    
    
	  <div class="full-width auto-padding tags">
      
        <a href="/blog/tags/big-data/">big data</a>
      
        <a href="/blog/tags/storage/">storage</a>
      
        <a href="/blog/tags/MVCC/">MVCC</a>
      
        <a href="/blog/tags/non-blocking/">non-blocking</a>
      
	  </div>
    
  </section>
</article>
    </div>
  
    <div class='post-wrapper'>
      <article class="post reveal">
  <section class="meta">
    
    <h2 class="title">
      <a href="/blog/running-mapreduce-over-openstack-swift/">
        Running Mapreduce over Openstack Swift
      </a>
    </h2>
    
    <time>
      Feb 13, 2017
    </time>
		
    
    <div class='cats'>
        <a href="/blog/categories/Tech/">Tech</a>
    </div>

  </section>
  <section class="article typo">
	  <p>I recently got a chance of experimenting mapreduce over several opensource object storages. Openstack swift is definitely one well known object storage service. However, I found it non-trivial to set it up for evaluation. Therefore, I put some notes below. </p>
<p>This article is only for os=Ubuntu 14.04 and swift=liberty. I noticed that the newer versions of swift is with much better documentation, which is much easier to follow. The appendix contains my early trials of installing swift from source.  </p>
<h2><span id="read-the-followings">Read the followings</span></h2><ul>
<li><a href="http://stackoverflow.com/questions/19004503/the-relationship-between-endpoints-regions-etc-in-keystone-openstack" target="_blank" rel="noopener">http://stackoverflow.com/questions/19004503/the-relationship-between-endpoints-regions-etc-in-keystone-openstack</a></li>
<li>Part 1. Fundamentals and Architecture in “Openstack Swift - Using, Administering, and Developing for Swift Object Storage”</li>
</ul>
<p>Make sure you have some sense for concepts including user, role, tenant, project, endpoint, proxy server, account server, object server, rings, and etc.</p>
<p>To my understanding, they are:</p>
<ul>
<li>user: a real user, or a service</li>
<li>role: role of users, corresponding to a set of permissions</li>
<li>tenant = project: a set of users</li>
<li>endpoint: the entry point urls of openstack services</li>
<li>proxy server: handling user requests in swift</li>
<li>account server: handling user account in swift, also used as domain or primary namespace </li>
<li>object server: handling object storage in swift</li>
<li>rings: the consistent hashing algorithm used by swift</li>
<li>keystone: the authentication service in openstack. Key concepts on keystone can be found <a href="http://docs.openstack.org/admin-guide/identity-concepts.html" target="_blank" rel="noopener">here</a></li>
</ul>
<h2><span id="setup-keynote-and-swift">Setup keynote and swift</span></h2><h3><span id="install-dependencies">Install dependencies</span></h3><ul>
<li><p>Install MariaDB (or MySQL) and memcache following <a href="https://www.server-world.info/en/note?os=Ubuntu_14.04&amp;p=openstack_liberty&amp;f=2" target="_blank" rel="noopener">page</a></p>
</li>
<li><p>Install keystone following <a href="https://www.server-world.info/en/note?os=Ubuntu_14.04&amp;p=openstack_liberty&amp;f=3" target="_blank" rel="noopener">page1</a> and <a href="https://www.server-world.info/en/note?os=Ubuntu_14.04&amp;p=openstack_liberty&amp;f=4" target="_blank" rel="noopener">page2</a>. Note that if you want to run mapreduce over swift, you can <em>not</em> use the TempAuth approach. Read this <a href="https://issues.apache.org/jira/browse/HADOOP-10420" target="_blank" rel="noopener">page</a> for more details. </p>
</li>
<li><p>Install swift following <a href="https://www.server-world.info/en/note?os=Ubuntu_14.04&amp;p=openstack_liberty2&amp;f=3" target="_blank" rel="noopener">page1</a>, <a href="https://www.server-world.info/en/note?os=Ubuntu_14.04&amp;p=openstack_liberty2&amp;f=4" target="_blank" rel="noopener">page2</a>, and <a href="https://www.server-world.info/en/note?os=Ubuntu_14.04&amp;p=openstack_liberty2&amp;f=5" target="_blank" rel="noopener">page3</a>. You can start the swift service with </p>
</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">swift-init all start</span><br></pre></td></tr></table></figure>
<h3><span id="setup-hadoop">Setup Hadoop</span></h3><ul>
<li>Setup Hadoop with version &gt;= 2.3 and configure it following <a href="http://spark.apache.org/docs/latest/storage-openstack-swift.html" target="_blank" rel="noopener">page1</a> and <a href="https://github.com/zioproto/hadoop-swift-tutorial" target="_blank" rel="noopener">page2</a>.</li>
<li>Make sure SwiftNativeFileSystem is in the classpath, read this <a href="https://github.com/zioproto/hadoop-swift-tutorial" target="_blank" rel="noopener">page</a> for any problem you find.</li>
<li>Configure etc/hadoop/core-site.xml，add following contents:</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line">&lt;configuration&gt;</span><br><span class="line">  &lt;property&gt;</span><br><span class="line">    &lt;name&gt;fs.swift.impl&lt;/name&gt;</span><br><span class="line">    &lt;value&gt;org.apache.hadoop.fs.swift.snative.SwiftNativeFileSystem&lt;/value&gt;</span><br><span class="line">  &lt;/property&gt;</span><br><span class="line">  &lt;property&gt;</span><br><span class="line">    &lt;name&gt;fs.swift.service.SwiftTest.auth.url&lt;/name&gt; &lt;---SwiftTest is the name of the service</span><br><span class="line">    &lt;value&gt;http://127.0.0.1:5000/v2.0/tokens&lt;/value&gt; &lt;---the ip:port should point to keystone. Make sure having &quot;/tokens&quot; there.</span><br><span class="line">  &lt;/property&gt;</span><br><span class="line">  &lt;property&gt;</span><br><span class="line">    &lt;name&gt;fs.swift.service.SwiftTest.auth.endpoint.prefix&lt;/name&gt;</span><br><span class="line">    &lt;value&gt;/AUTH_&lt;/value&gt;</span><br><span class="line">  &lt;/property&gt;</span><br><span class="line">  &lt;property&gt;</span><br><span class="line">    &lt;name&gt;fs.swift.service.SwiftTest.http.port&lt;/name&gt;</span><br><span class="line">    &lt;value&gt;8080&lt;/value&gt; &lt;--- the same with that in proxy-server.conf</span><br><span class="line">  &lt;/property&gt;</span><br><span class="line">  &lt;property&gt;</span><br><span class="line">    &lt;name&gt;fs.swift.service.SwiftTest.region&lt;/name&gt;</span><br><span class="line">    &lt;value&gt;RegionOne&lt;/value&gt;</span><br><span class="line">  &lt;/property&gt;</span><br><span class="line">  &lt;property&gt;</span><br><span class="line">    &lt;name&gt;fs.swift.service.SwiftTest.public&lt;/name&gt;</span><br><span class="line">    &lt;value&gt;true&lt;/value&gt;</span><br><span class="line">  &lt;/property&gt;</span><br><span class="line">  &lt;property&gt;</span><br><span class="line">    &lt;name&gt;fs.swift.service.SwiftTest.tenant&lt;/name&gt;</span><br><span class="line">    &lt;value&gt;admin&lt;/value&gt; &lt;--- name of the project, not the role!</span><br><span class="line">  &lt;/property&gt;</span><br><span class="line">  &lt;property&gt;</span><br><span class="line">    &lt;name&gt;fs.swift.service.SwiftTest.username&lt;/name&gt;</span><br><span class="line">    &lt;value&gt;admin&lt;/value&gt; &lt;--- user name</span><br><span class="line">  &lt;/property&gt;</span><br><span class="line">  &lt;property&gt;</span><br><span class="line">    &lt;name&gt;fs.swift.service.SwiftTest.password&lt;/name&gt;</span><br><span class="line">    &lt;value&gt;adminpassword&lt;/value&gt; &lt;--- password</span><br><span class="line">  &lt;/property&gt;</span><br><span class="line">&lt;/configuration&gt;</span><br></pre></td></tr></table></figure>
<h3><span id="verify-all-setup">Verify all setup</span></h3><ul>
<li>create a container (swift post nameofcontainer). Important! the name should be only consist of letters. No ‘_’ is allowed.</li>
<li>upload a file (swift upload nameofcontainer nameoffile).</li>
<li>hdfs dfs -ls swift://nameofcontainer.SwiftTest/. This should show you files you uploaded previously.</li>
<li>hadoop distcp nameoffile swift://mycontainer.SwiftTest/nameoffile</li>
</ul>
<h2><span id="appendix-install-swift-from-source">Appendix: Install swift from source</span></h2><h3><span id="dependencies">Dependencies</span></h3><h4><span id="from-the-swift-book">From the swift book</span></h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">apt-get install git curl gcc memcached rsync sqlite3 xfsprogs \</span><br><span class="line">git-core libffi-dev python-setuptools</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">apt-get install python-coverage python-dev python-nose \</span><br><span class="line">python-simplejson python-xattr python-eventlet \</span><br><span class="line">python-greenlet python-pastedeploy python-netifaces \</span><br><span class="line">python-pip python-dnspython python-mock</span><br></pre></td></tr></table></figure>
<h4><span id="install-the-latest-liberasurecode-as-per-some-post-may-not-be-necessary">Install the latest liberasurecode (as per some post, may not be necessary)</span></h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">sudo apt-get install build-essential autoconf automake libtool</span><br><span class="line">cd /opt/</span><br><span class="line">git clone https://github.com/openstack/liberasurecode.git</span><br><span class="line">cd liberasurecode</span><br><span class="line">./autogen.sh</span><br><span class="line">./configure</span><br><span class="line">make</span><br><span class="line">make test</span><br><span class="line">sudo make install</span><br></pre></td></tr></table></figure>
<h3><span id="install-the-swift-cli">Install the Swift CLI</span></h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">cd /opt</span><br><span class="line">git clone https://github.com/openstack/python-swiftclient.git</span><br><span class="line">cd /opt/python-swiftclient; sudo pip install -r requirements.txt;</span><br><span class="line">python setup.py install; cd ..</span><br></pre></td></tr></table></figure>
<p>I run into a problem of invalid format of the requirement.txt. You may need to do some editing in that case.</p>
<h3><span id="install-the-swift">Install the Swift</span></h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">cd /opt</span><br><span class="line">git clone https://github.com/openstack/swift.git</span><br><span class="line">cd /opt/swift ; sudo python setup.py install; cd ..</span><br></pre></td></tr></table></figure>
<p>The above is from the swift book. But I realized I still need to run “sudo pip install -r requirements.txt” before the setup*</p>
<p>Another issue I found is that it takes forever to pip install cryptography in the requirements.txt. I searched in Google where some guy said it took 20 min for building. For me, after 20 min, it still hanged there. </p>
<p>I tried to install all dependencies manually, as follows without the <em>cryptography</em>. After that, it was installed successfully:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">Requirement already satisfied (use --upgrade to upgrade): cryptography in /usr/local/lib/python2.7/dist-packages</span><br><span class="line">Requirement already satisfied (use --upgrade to upgrade): idna&gt;=2.0 in /usr/local/lib/python2.7/dist-packages (from cryptography)</span><br><span class="line">Requirement already satisfied (use --upgrade to upgrade): pyasn1&gt;=0.1.8 in /usr/local/lib/python2.7/dist-packages (from cryptography)</span><br><span class="line">Requirement already satisfied (use --upgrade to upgrade): six&gt;=1.4.1 in /usr/local/lib/python2.7/dist-packages (from cryptography)</span><br><span class="line">Requirement already satisfied (use --upgrade to upgrade): setuptools&gt;=11.3 in /usr/local/lib/python2.7/dist-packages (from cryptography)</span><br><span class="line">Requirement already satisfied (use --upgrade to upgrade): enum34 in /usr/local/lib/python2.7/dist-packages (from cryptography)</span><br><span class="line">Requirement already satisfied (use --upgrade to upgrade): ipaddress in /usr/local/lib/python2.7/dist-packages (from cryptography)</span><br><span class="line">Requirement already satisfied (use --upgrade to upgrade): cffi&gt;=1.4.1 in /usr/local/lib/python2.7/dist-packages (from cryptography)</span><br><span class="line">Requirement already satisfied (use --upgrade to upgrade): pycparser in /usr/local/lib/python2.7/dist-packages (from cffi&gt;=1.4.1-&gt;cryptography)</span><br></pre></td></tr></table></figure>
<h3><span id="copy-in-swift-configuration-files">Copy in Swift configuration files</span></h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">mkdir -p /etc/swift</span><br><span class="line">cd /opt/swift/etc</span><br><span class="line">cp account-server.conf-sample /etc/swift/account-server.conf</span><br><span class="line">cp container-server.conf-sample /etc/swift/container-server.conf</span><br><span class="line">cp object-server.conf-sample /etc/swift/object-server.conf</span><br><span class="line">cp proxy-server.conf-sample /etc/swift/proxy-server.conf</span><br><span class="line">cp drive-audit.conf-sample /etc/swift/drive-audit.conf</span><br><span class="line">cp swift.conf-sample /etc/swift/swift.conf</span><br><span class="line"></span><br><span class="line">chown -R swift:swift /etc/swift</span><br></pre></td></tr></table></figure>
<p>In this setup, we rely on <em>tempauth</em> for authentication.</p>
<h3><span id="config-the-swiftconf">Config the swift.conf</span></h3><h4><span id="setting-the-hash-path-prefix-and-suffix">Setting the hash path prefix and suffix</span></h4><p>These two random strings are used to determine the hash result of the partitions on the rings. They are supposed to be confidential.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">swift_hash_path_suffix = random_32_length_string1</span><br><span class="line">swift_hash_path_prefix = random_32_length_string2</span><br></pre></td></tr></table></figure>
<p>You can use </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">head -c 32 /dev/random | base64</span><br></pre></td></tr></table></figure>
<p>to get one random 32 length string.</p>
<h4><span id="the-storage-policy">The storage policy</span></h4><p>You can custermize the storage policy as per the swift book, but it is optional.</p>
<h3><span id="build-the-rings">Build the rings</span></h3><p>The 3 parameters are part_power, replicas, min_part_hours</p>
<ul>
<li>part_power: the number of partitions in the storage cluster. The typical setting is log_2 ( 100 <em> maximun number of disks ). For this setup, it is log_2 (100 </em> 1) which is close to 7. </li>
<li>replicas: in this setup, there is only one drive. Therefore, only 1 replica is allowed.</li>
<li>min_part_hours: the default is 24 hours. Tune it as per the swift book or the official document.</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">cd /etc/swift</span><br><span class="line">swift-ring-builder account.builder create 7 1 1</span><br><span class="line">swift-ring-builder container.builder create 7 1 1</span><br><span class="line">swift-ring-builder object.builder create 7 1 1</span><br></pre></td></tr></table></figure>
<h3><span id="prepare-the-drives">Prepare the drives</span></h3><p>You can use a disk or chop off disk space from existing disk to provide storage for swift. Follow the step 2 of this <a href="http://blog.adityapatawari.com/2014/01/openstack-101-how-to-setup-openstack_12.html" target="_blank" rel="noopener">article</a>. Copied here: </p>
<p><em>Attach a disk which would be used for storage or chop off some disk space from the existing disk.<br>Using additional disks:<br>Most likely this is done when there is large amount of data to be stored. XFS is the recommended filesystem and is known to work well with Swift. If the additional disk is attached as /dev/sdb then following will do the trick:</em></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"># fdisk /dev/sdb</span><br><span class="line"># mkfs.xfs /dev/sdb1</span><br><span class="line"># echo &quot;/dev/sdb1 /srv/node/partition1 xfs noatime,nodiratime,nobarrier,logbufs=8 0 0&quot; &gt;&gt; /etc/fstab </span><br><span class="line"># mkdir -p /srv/node/partition1</span><br><span class="line"># mount /srv/node/partition1</span><br></pre></td></tr></table></figure>
<p><em>Chopping off disk space from the existing disk:<br>We can chop off disk from existing disks as well. This is usually done for smaller installations or for “proof-of-concept” stage. We can use XFS like before or we can use ext4 as well.</em></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"># truncate --size=2G /tmp/swiftstorage</span><br><span class="line"># DEVICE=$(losetup --show -f /tmp/swiftstorage)</span><br><span class="line"># mkfs.ext4 $DEVICE</span><br><span class="line"># mkdir -p /srv/node/partition1</span><br><span class="line"># mount $DEVICE /srv/node/partition1 -t ext4 -o noatime,nodiratime,nobarrier,user_xattr</span><br></pre></td></tr></table></figure>
<p>In either case, you need to </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">chown -R swift:swift /srv/node/partition1</span><br></pre></td></tr></table></figure>
<p>Also, you need to mount automatically after system reboot. So put the mount command line into a script, e.g., <em>/opt/swift/bin/mount_devices</em>. Then add a file <em>start_swift.conf</em> under <em>/etc/init/</em> with content</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">description &quot;mount swift drives&quot;</span><br><span class="line">start on runlevel [234]</span><br><span class="line">stop on runlevel [0156]</span><br><span class="line">exec /opt/swift/bin/mount_devices</span><br></pre></td></tr></table></figure>
<p>Make sure to make the script runnable</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">chmod +x /opt/swift/bin/mount_devices</span><br></pre></td></tr></table></figure>
<h3><span id="add-the-drives-to-the-rings">Add the drives to the rings</span></h3><p>The single parameter <em>100</em> is the weight for load balancing. Note that the <em>partition1</em> in the command is in the path of <em>/srv/node/partition1</em>. If you change the path, you need to change both places. It is not the name of the device in <em>/dev/sda</em>, for example. Make sure about the <em>IP</em>s and the <em>PORT</em>s. They are the address of the processes (account, container, and object). I was blocked by the port for quite a while, simply because the default ports in the conf files are different from the ones used below (not sure why…).</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">swift-ring-builder account.builder add r1z1-127.0.0.1:6002/partition1 100</span><br><span class="line">swift-ring-builder container.builder add r1z1-127.0.0.1:6001/partition1 100</span><br><span class="line">swift-ring-builder object.builder add r1z1-127.0.0.1:6000/partition1 100</span><br></pre></td></tr></table></figure>
<p>Rebalance the rings to create them actually.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">swift-ring-builder account.builder rebalance</span><br><span class="line">swift-ring-builder container.builder rebalance</span><br><span class="line">swift-ring-builder object.builder rebalance</span><br></pre></td></tr></table></figure>
<p>You will find the *.ring.gz files and a backup folder. </p>
<h3><span id="configure-the-logs">Configure the logs</span></h3><p>put a file named <em>0-swift.conf</em> under <em>/etc/rsyslog.d</em> directory, containing only one line:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">local0.* /var/log/swift/all.log</span><br></pre></td></tr></table></figure>
<p>And then create the directory and set the right permissions.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">mkdir /var/log/swift</span><br><span class="line">chown -R syslog.adm /var/log/swift</span><br><span class="line">chmod -R g+w /var/log/swift</span><br><span class="line"></span><br><span class="line">service rsyslog restart</span><br></pre></td></tr></table></figure>
<h3><span id="start-the-proxy-server">Start the proxy server</span></h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">swift-init proxy start</span><br></pre></td></tr></table></figure>
<p>If you see warning messages as discussed in this <a href="https://ask.openstack.org/en/question/93267/unable-to-start-swift-proxy-liberasurecode-missing-libshssso/" target="_blank" rel="noopener">post</a>. You can follow the solutions there, copied here:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">curl -o libisal2_2.15.0-3~bpo14.04+1_amd64.deb http://mitaka-trusty.pkgs.mirantis.com/debian/pool/trusty-mitaka-backports/main/l/libisal/libisal2_2.15.0-3~bpo14.04+1_amd64.deb </span><br><span class="line">sudo dpkg -i libisal2_2.15.0-3~bpo14.04+1_amd64.deb</span><br><span class="line">git clone https://bitbucket.org/kmgreen2/pyeclib.git </span><br><span class="line">sudo python setup.py install</span><br><span class="line">sudo apt-get uninstall python-pyeclib</span><br></pre></td></tr></table></figure>
<h3><span id="configure-tempauth-in-proxy-serverconf">Configure tempauth in proxy-server.conf</span></h3><p>We rely on <em>tempauth</em> for authentication in this setup. If you are using keystone, follow this <a href="http://blog.adityapatawari.com/2014/01/openstack-101-how-to-setup-openstack_12.html" target="_blank" rel="noopener">post</a> or this <a href="https://gist.github.com/anak10thn/7446838" target="_blank" rel="noopener">one</a>.</p>
<p>First, start the memcache:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">service memcached start</span><br></pre></td></tr></table></figure>
<p>Add your users to proxy-server.conf under the tempauth block.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">[filter:tempauth]</span><br><span class="line">use = egg:swift#tempauth</span><br><span class="line"># You can override the default log routing for this filter here:</span><br><span class="line">...</span><br><span class="line"># &lt;account&gt; is from the user_&lt;account&gt;_&lt;user&gt; name.</span><br><span class="line"># Here are example entries, required for running the tests:</span><br><span class="line">user_admin_admin = admin .admin .reseller_admin</span><br><span class="line">user_test_tester = testing .admin</span><br><span class="line">user_test2_tester2 = testing2 .admin</span><br><span class="line">user_test_tester3 = testing3</span><br></pre></td></tr></table></figure>
<p>The syntax is </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">user_$SWIFTACCOUNT_$SWIFTUSER = $KEY [group] [group] [...] [storage_url]</span><br></pre></td></tr></table></figure>
<p>which means you can configure the user for each storage url.</p>
<p>Then, modify these two options:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">allow_account_management = true</span><br><span class="line">account_autocreate = true</span><br></pre></td></tr></table></figure>
<h3><span id="start-the-servers">Start the servers</span></h3><p>Create the cache directory</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">mkdir -p /var/swift/recon</span><br><span class="line">chown -R swift:swift /var/swift/recon</span><br></pre></td></tr></table></figure>
<p>Start the services after making sure the conf files are right, especially the ip and port. The ip is typically set to 0.0.0.0 and the port should be the same as adding the drives. </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">swift-init account start</span><br><span class="line">swift-init container start</span><br><span class="line">swift-init object start</span><br></pre></td></tr></table></figure>
<p>Then, restart the proxy server</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">swift-init proxy restart</span><br></pre></td></tr></table></figure>
<h3><span id="verify-the-setup">Verify the setup</span></h3><p>Send in the authentication (note that I’m using the <em>admin</em> user defined in the proxy-server.conf with group <em>admin</em> and password <em>admin</em>):</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">curl -v -H &apos;X-Auth-User: admin:admin&apos; -H &apos;X-Auth-Key: admin&apos; http://localhost:8080/auth/v1.0/</span><br></pre></td></tr></table></figure>
<p>The above will get you the X-Auth-Token if everything is right. For instance,</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">* Hostname was NOT found in DNS cache</span><br><span class="line">*   Trying 127.0.0.1...</span><br><span class="line">* Connected to localhost (127.0.0.1) port 8080 (#0)</span><br><span class="line">&gt; GET /auth/v1.0/ HTTP/1.1</span><br><span class="line">&gt; User-Agent: curl/7.35.0</span><br><span class="line">&gt; Host: localhost:8080</span><br><span class="line">&gt; Accept: */*</span><br><span class="line">&gt; X-Auth-User: admin:admin</span><br><span class="line">&gt; X-Auth-Key: admin</span><br><span class="line">&gt; </span><br><span class="line">&lt; HTTP/1.1 200 OK</span><br><span class="line">&lt; X-Storage-Url: http://localhost:8080/v1/AUTH_admin</span><br><span class="line">&lt; X-Auth-Token-Expires: 18098</span><br><span class="line">&lt; X-Auth-Token: AUTH_tka1a0d192e57746839c1749f238ba5419</span><br><span class="line">&lt; Content-Type: text/html; charset=UTF-8</span><br><span class="line">&lt; X-Storage-Token: AUTH_tka1a0d192e57746839c1749f238ba5419</span><br><span class="line">&lt; Content-Length: 0</span><br><span class="line">&lt; X-Trans-Id: txb9682bc6bab448659fd50-005881a50f</span><br><span class="line">&lt; X-Openstack-Request-Id: txb9682bc6bab448659fd50-005881a50f</span><br><span class="line">&lt; Date: Fri, 20 Jan 2017 05:50:07 GMT</span><br><span class="line">&lt; </span><br><span class="line">* Connection #0 to host localhost left intact</span><br></pre></td></tr></table></figure>
<p>Next, use the token to access the account by</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">curl -v -H &apos;X-Storage-Token: AUTH_tka1a0d192e57746839c1749f238ba5419&apos; http://127.0.0.1:8080/v1/AUTH_admin/</span><br></pre></td></tr></table></figure>
<p>the admin in the url <em>AUTH_admin</em> should be the same as the username. You should get something like follows.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">* Hostname was NOT found in DNS cache</span><br><span class="line">*   Trying 127.0.0.1...</span><br><span class="line">* Connected to 127.0.0.1 (127.0.0.1) port 8080 (#0)</span><br><span class="line">&gt; GET /v1/AUTH_admin HTTP/1.1</span><br><span class="line">&gt; User-Agent: curl/7.35.0</span><br><span class="line">&gt; Host: 127.0.0.1:8080</span><br><span class="line">&gt; Accept: */*</span><br><span class="line">&gt; X-Storage-Token: AUTH_tka1a0d192e57746839c1749f238ba5419</span><br><span class="line">&gt; </span><br><span class="line">&lt; HTTP/1.1 200 OK</span><br><span class="line">&lt; Content-Length: 12</span><br><span class="line">&lt; X-Account-Object-Count: 0</span><br><span class="line">&lt; X-Account-Storage-Policy-Policy-0-Bytes-Used: 0</span><br><span class="line">&lt; X-Account-Storage-Policy-Policy-0-Container-Count: 1</span><br><span class="line">&lt; X-Timestamp: 1484824088.30547</span><br><span class="line">&lt; X-Account-Storage-Policy-Policy-0-Object-Count: 0</span><br><span class="line">&lt; X-Account-Bytes-Used: 0</span><br><span class="line">&lt; X-Account-Container-Count: 1</span><br><span class="line">&lt; Content-Type: text/plain; charset=utf-8</span><br><span class="line">&lt; Accept-Ranges: bytes</span><br><span class="line">&lt; X-Trans-Id: txf57c870a9ba146d9947d0-005881a5cd</span><br><span class="line">&lt; X-Openstack-Request-Id: txf57c870a9ba146d9947d0-005881a5cd</span><br><span class="line">&lt; Date: Fri, 20 Jan 2017 05:53:17 GMT</span><br><span class="line">&lt; </span><br><span class="line">mycontainer</span><br><span class="line">* Connection #0 to host 127.0.0.1 left intact</span><br></pre></td></tr></table></figure>
<p>I was blocked here for quite a while simply because the port in the proxy-server.conf is 6202, not 6002. Be careful!!!</p>
<p>If you get something wrong, go to the log file (at /var/log/swift/all.log) and see the error message there. </p>
<p>You can further verify the setup by creating a container and upload/download a file with </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">curl -v -H &apos;X-Storage-Token: AUTH_tka1a0d192e57746839c1749f238ba5419&apos; -X PUT http://127.0.0.1:8080/v1/AUTH_admin/mycontainer</span><br><span class="line">swift -A http://127.0.0.1:8080/auth/v1.0/ -U admin:admin -K admin upload mycontainer some_file</span><br></pre></td></tr></table></figure>
<p>In the last command line, we use swift client instead of curl. There are other subcommand other than upload. There are delete, download, list, post, and stat. To avoid putting the url and user info in every command, one could put the following into .bashrc</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">export ST_AUTH=http://localhost:8080/auth/v1.0</span><br><span class="line">export ST_USER=admin:admin</span><br><span class="line">export ST_KEY=admin</span><br></pre></td></tr></table></figure>
<h3><span id="start-the-consistency-processes">Start the consistency processes</span></h3><p>Swift relies on a few other processes for consistency purposes. </p>
<p>Edit (or create) the <em>/etc/default/rsync</em> file and add the following line:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">RSYNC_ENABLE=true</span><br></pre></td></tr></table></figure>
<p>Then, edit (or create) the <em>/etc/rsyncd.conf</em> file, adding the following:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">uid = swift</span><br><span class="line">gid = swift</span><br><span class="line">log file = /var/log/rsyncd.log</span><br><span class="line">pid file = /var/run/rsyncd.pid</span><br><span class="line">[account]</span><br><span class="line">max connections = 25</span><br><span class="line">path = /srv/node/</span><br><span class="line">read only = false</span><br><span class="line">lock file = /var/lock/account.lock</span><br><span class="line">[container]</span><br><span class="line">max connections = 25</span><br><span class="line">path = /srv/node/</span><br><span class="line">read only = false</span><br><span class="line">lock file = /var/lock/container.lock</span><br><span class="line">[object]</span><br><span class="line">max connections = 25</span><br><span class="line">path = /srv/node/</span><br><span class="line">read only = false</span><br><span class="line">lock file = /var/lock/object.lock</span><br></pre></td></tr></table></figure>
<p>Start the rsync service</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">service rsync start</span><br></pre></td></tr></table></figure>
<p>Now, you can start the processes by </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">swift-init account-replicator start</span><br><span class="line">swift-init container-replicator start</span><br><span class="line">swift-init object-replicator start</span><br></pre></td></tr></table></figure>
<p>One useful way of controlling these processes is by</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">swift-init all start/stop/restart</span><br></pre></td></tr></table></figure>
<h3><span id="setup-on-multiple-nodes">Setup on multiple nodes</span></h3><p>The plan of deployment depends on the hardware. One need to read the part IV of the swift book before that. I found this <a href="https://thornelabs.net/2014/07/14/install-a-stand-alone-multi-node-openstack-swift-cluster-with-virtualbox-or-vmware-fusion-and-vagrant.html" target="_blank" rel="noopener">article</a> very well writen. One can learn the way of deployment for a small cluster. </p>
<p>There are a few points one should keep in mind. </p>
<ul>
<li>Copy the swift.conf file to all nodes;</li>
<li>Add the drives across all nodes to the rings;</li>
<li>Copy the rings to all nodes;</li>
</ul>
<h3><span id="references">References</span></h3><ol>
<li>Install a Stand-alone, Multi-node OpenStack Swift Cluster with VirtualBox or VMware Fusion and Vagrant (<a href="https://thornelabs.net/2014/07/14/install-a-stand-alone-multi-node-openstack-swift-cluster-with-virtualbox-or-vmware-fusion-and-vagrant.html" target="_blank" rel="noopener">https://thornelabs.net/2014/07/14/install-a-stand-alone-multi-node-openstack-swift-cluster-with-virtualbox-or-vmware-fusion-and-vagrant.html</a>)</li>
<li>OpenStack 101: How to Setup OpenStack Swift (<a href="http://blog.adityapatawari.com/2014/01/openstack-101-how-to-setup-openstack_12.html" target="_blank" rel="noopener">http://blog.adityapatawari.com/2014/01/openstack-101-how-to-setup-openstack_12.html</a>)</li>
<li>OpenStack Swift (the swift book)</li>
</ol>


    
    
    
	  <div class="full-width auto-padding tags">
      
        <a href="/blog/tags/big-data/">big data</a>
      
        <a href="/blog/tags/mapreduce/">mapreduce</a>
      
        <a href="/blog/tags/openstack/">openstack</a>
      
        <a href="/blog/tags/swift/">swift</a>
      
	  </div>
    
  </section>
</article>
    </div>
  
</section>


      </div>
      <aside class='l_side'>
        
  <section class='m_widget about'>

<div class='header'>Liqun Li</div>
<div class='content'>
<div class='desc'>Tempora mutantur, nos et mutamur in illis ...</div>
</div>
</section>

  <section class='m_widget links'>
<div class='header'>Links</div>
<div class='content'>
    <ul class="entry">
    
        <li><a class="flat-box" target="_blank" href="https://ccoooss.com">
            <div class='name'>ClassicOldSong</div>
        </a></li>
    
        <li><a class="flat-box" target="_blank" href="https://frantic1048.logdown.com/">
            <div class='name'>Frantic1048</div>
        </a></li>
    
        <li><a class="flat-box" target="_blank" href="https://hclmaster.github.io/">
            <div class='name'>Hclmaster</div>
        </a></li>
    
        <li><a class="flat-box" target="_blank" href="https://whst.github.io/">
            <div class='name'>WANG Hsü-Tung</div>
        </a></li>
    
    </ul>
</div>
</section>

  <section class='m_widget categories'>
<div class='header'>Categories</div>
<div class='content'>
    
    <ul class="entry">
    
        <li><a class="flat-box" href="/blog/categories/Book-Reading/"><div class='name'>Book Reading</div><div class='badget'>3</div></a></li>
    
        <li><a class="flat-box" href="/blog/categories/Finance/"><div class='name'>Finance</div><div class='badget'>1</div></a></li>
    
        <li><a class="flat-box" href="/blog/categories/Photography/"><div class='name'>Photography</div><div class='badget'>1</div></a></li>
    
        <li><a class="flat-box" href="/blog/categories/Reading/"><div class='name'>Reading</div><div class='badget'>1</div></a></li>
    
        <li><a class="flat-box" href="/blog/categories/Tech/"><div class='name'>Tech</div><div class='badget'>39</div></a></li>
    
        <li><a class="flat-box" href="/blog/categories/Thinking/"><div class='name'>Thinking</div><div class='badget'>3</div></a></li>
    
    </ul>
    
</div>
</section>

  
<div class="m_widget tagcloud">
    <div class="header">Tags</div>
    <div class='content'>
        <a href="/blog/tags/AI/" style="font-size: 14px; color: #808080">AI</a> <a href="/blog/tags/Consensus/" style="font-size: 14px; color: #808080">Consensus</a> <a href="/blog/tags/Copycat/" style="font-size: 14px; color: #808080">Copycat</a> <a href="/blog/tags/Deadlock/" style="font-size: 14px; color: #808080">Deadlock</a> <a href="/blog/tags/HBase/" style="font-size: 14px; color: #808080">HBase</a> <a href="/blog/tags/IMU/" style="font-size: 14px; color: #808080">IMU</a> <a href="/blog/tags/Learning/" style="font-size: 14px; color: #808080">Learning</a> <a href="/blog/tags/MVCC/" style="font-size: 14px; color: #808080">MVCC</a> <a href="/blog/tags/Mapreduce/" style="font-size: 14px; color: #808080">Mapreduce</a> <a href="/blog/tags/Mysql/" style="font-size: 14px; color: #808080">Mysql</a> <a href="/blog/tags/OOM/" style="font-size: 14px; color: #808080">OOM</a> <a href="/blog/tags/Raft/" style="font-size: 18.8px; color: #1a1a1a">Raft</a> <a href="/blog/tags/Uniqueness/" style="font-size: 14px; color: #808080">Uniqueness</a> <a href="/blog/tags/accelerometer/" style="font-size: 14px; color: #808080">accelerometer</a> <a href="/blog/tags/admission-control/" style="font-size: 14px; color: #808080">admission control</a> <a href="/blog/tags/amazon-aurora/" style="font-size: 14px; color: #808080">amazon aurora</a> <a href="/blog/tags/big-data/" style="font-size: 20px; color: #000">big data</a> <a href="/blog/tags/compaction/" style="font-size: 14px; color: #808080">compaction</a> <a href="/blog/tags/compass/" style="font-size: 14px; color: #808080">compass</a> <a href="/blog/tags/consistency/" style="font-size: 15.2px; color: #666">consistency</a> <a href="/blog/tags/credit-spread/" style="font-size: 14px; color: #808080">credit spread</a> <a href="/blog/tags/distributed/" style="font-size: 15.2px; color: #666">distributed</a> <a href="/blog/tags/elasticsearch/" style="font-size: 14px; color: #808080">elasticsearch</a> <a href="/blog/tags/flink/" style="font-size: 14px; color: #808080">flink</a> <a href="/blog/tags/git/" style="font-size: 15.2px; color: #666">git</a> <a href="/blog/tags/gyroscope/" style="font-size: 14px; color: #808080">gyroscope</a> <a href="/blog/tags/hbase/" style="font-size: 14px; color: #808080">hbase</a> <a href="/blog/tags/investment/" style="font-size: 15.2px; color: #666">investment</a> <a href="/blog/tags/links/" style="font-size: 14px; color: #808080">links</a> <a href="/blog/tags/lock/" style="font-size: 16.4px; color: #4d4d4d">lock</a> <a href="/blog/tags/mapreduce/" style="font-size: 15.2px; color: #666">mapreduce</a> <a href="/blog/tags/mysql/" style="font-size: 14px; color: #808080">mysql</a> <a href="/blog/tags/nginx/" style="font-size: 14px; color: #808080">nginx</a> <a href="/blog/tags/non-blocking/" style="font-size: 14px; color: #808080">non-blocking</a> <a href="/blog/tags/octave/" style="font-size: 14px; color: #808080">octave</a> <a href="/blog/tags/openstack/" style="font-size: 14px; color: #808080">openstack</a> <a href="/blog/tags/photography/" style="font-size: 14px; color: #808080">photography</a> <a href="/blog/tags/php/" style="font-size: 15.2px; color: #666">php</a> <a href="/blog/tags/quorum/" style="font-size: 14px; color: #808080">quorum</a> <a href="/blog/tags/rabbitmq/" style="font-size: 17.6px; color: #333">rabbitmq</a> <a href="/blog/tags/replication/" style="font-size: 14px; color: #808080">replication</a> <a href="/blog/tags/sbt/" style="font-size: 14px; color: #808080">sbt</a> <a href="/blog/tags/scala/" style="font-size: 14px; color: #808080">scala</a> <a href="/blog/tags/spark/" style="font-size: 14px; color: #808080">spark</a> <a href="/blog/tags/ssd/" style="font-size: 14px; color: #808080">ssd</a> <a href="/blog/tags/storage/" style="font-size: 14px; color: #808080">storage</a> <a href="/blog/tags/swift/" style="font-size: 14px; color: #808080">swift</a> <a href="/blog/tags/tool-collection/" style="font-size: 14px; color: #808080">tool collection</a> <a href="/blog/tags/transaction/" style="font-size: 14px; color: #808080">transaction</a> <a href="/blog/tags/国史大纲/" style="font-size: 14px; color: #808080">国史大纲</a> <a href="/blog/tags/洪业/" style="font-size: 14px; color: #808080">洪业</a> <a href="/blog/tags/认知/" style="font-size: 14px; color: #808080">认知</a>
    </div>
</div>



      </aside>
      <script>setLoadingBarProgress(60);</script>
    </div>
  </div>
  <footer id="footer" class="clearfix">

	<div class="social-wrapper">
  	
      
        <a href="https://github.com/stkevintan" class="social github"
          target="_blank" rel="external">
          <span class="icon icon-github"></span>
        </a>
      
        <a href="https://twitter.com/kevinsfork" class="social twitter"
          target="_blank" rel="external">
          <span class="icon icon-twitter"></span>
        </a>
      
        <a href="/atom.xml" class="social rss"
          target="_blank" rel="external">
          <span class="icon icon-rss"></span>
        </a>
      
    
  </div>
  
  <div>Theme <a href='https://github.com/stkevintan/hexo-theme-material-flow' class="codename">MaterialFlow</a> designed by <a href="http://keyin.me/" target="_blank">Kevin Tan</a>.</div>
  
</footer>


  <script>setLoadingBarProgress(80);</script>
  

<script src="//apps.bdimg.com/libs/jquery/2.1.4/jquery.min.js"></script>
<script src='//cdn.bootcss.com/node-waves/0.7.5/waves.min.js'></script>
<script src="//cdn.bootcss.com/scrollReveal.js/3.3.2/scrollreveal.min.js"></script>
<script src="/blog/js/jquery.fitvids.js"></script>
<script>
	var GOOGLE_CUSTOM_SEARCH_API_KEY = "";
	var GOOGLE_CUSTOM_SEARCH_ENGINE_ID = "";
	var ALGOLIA_API_KEY = "";
	var ALGOLIA_APP_ID = "";
	var ALGOLIA_INDEX_NAME = "";
  var AZURE_SERVICE_NAME = "";
  var AZURE_INDEX_NAME = "";
  var AZURE_QUERY_KEY = "";
  var BAIDU_API_ID = "";
  var SEARCH_SERVICE = "hexo";
  var ROOT = "/blog/"||"/";
  if(!ROOT.endsWith('/'))ROOT += '/';
</script>
<script src="/blog/js/search.js"></script>
<script src="/blog/js/app.js"></script>


  <script>setLoadingBarProgress(100);</script>
</body>
</html>
