<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  <title>Home | Bucket &amp; Hammer</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  
    <meta name="keywords" content="Knowlege, Knowlege, Knowlege" />
  
  
  
  
  <meta property="og:type" content="website">
<meta property="og:title" content="Bucket &amp; Hammer">
<meta property="og:url" content="liqul.github.io/blog/page/5/index.html">
<meta property="og:site_name" content="Bucket &amp; Hammer">
<meta property="og:locale" content="default">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Bucket &amp; Hammer">
  
    <link rel="alternate" href="/atom.xml" title="Bucket &amp; Hammer" type="application/atom+xml">
  
  <link rel="icon" href="/blog/css/images/favicon.ico">
  
    <link href="//fonts.googleapis.com/css?family=Source+Code+Pro" rel="stylesheet" type="text/css">
  
  <link href="https://fonts.googleapis.com/css?family=Open+Sans|Montserrat:700" rel="stylesheet" type="text/css">
  <link href="https://fonts.googleapis.com/css?family=Roboto:400,300,300italic,400italic" rel="stylesheet" type="text/css">
  <link href="//cdn.bootcss.com/font-awesome/4.6.3/css/font-awesome.min.css" rel="stylesheet">
  <style type="text/css">
    @font-face{font-family:futura-pt;src:url(https://use.typekit.net/af/9749f0/00000000000000000001008f/27/l?subset_id=2&fvd=n5) format("woff2");font-weight:500;font-style:normal;}
    @font-face{font-family:futura-pt;src:url(https://use.typekit.net/af/90cf9f/000000000000000000010091/27/l?subset_id=2&fvd=n7) format("woff2");font-weight:500;font-style:normal;}
    @font-face{font-family:futura-pt;src:url(https://use.typekit.net/af/8a5494/000000000000000000013365/27/l?subset_id=2&fvd=n4) format("woff2");font-weight:lighter;font-style:normal;}
    @font-face{font-family:futura-pt;src:url(https://use.typekit.net/af/d337d8/000000000000000000010095/27/l?subset_id=2&fvd=i4) format("woff2");font-weight:400;font-style:italic;}</style>
    
  <link rel="stylesheet" id="athemes-headings-fonts-css" href="//fonts.googleapis.com/css?family=Yanone+Kaffeesatz%3A200%2C300%2C400%2C700&amp;ver=4.6.1" type="text/css" media="all">

  <link rel="stylesheet" id="athemes-headings-fonts-css" href="//fonts.googleapis.com/css?family=Oswald%3A300%2C400%2C700&amp;ver=4.6.1" type="text/css" media="all">
  <link rel="stylesheet" href="/blog/css/style.css">

  <script src="/blog/js/jquery-3.1.1.min.js"></script>

  <!-- Bootstrap core CSS -->
  <link rel="stylesheet" href="/blog/css/bootstrap.css" >
  <link rel="stylesheet" href="/blog/css/fashion.css" >
  <link rel="stylesheet" href="/blog/css/glyphs.css" >

</head>



  <body>


  


<header id="allheader" class="site-header" role="banner" 
   >
  <div class="clearfix container">
      <div class="site-branding">

          <h1 class="site-title">
            
              <a href="/blog/" rel="home" >
                <img style="margin-bottom: 10px;"  width="650px" height="124px" alt="Hike News" src=" /blog/css/images/title.png">
              </a>
            
          </h1>
          
          
            
          <nav id="main-navigation" class="main-navigation" role="navigation">
            <a class="nav-open">Menu</a>
            <a class="nav-close">Close</a>

            <div class="clearfix sf-menu">
              <ul id="main-nav" class="menu sf-js-enabled sf-arrows"  style="touch-action: pan-y;">
                    
                      <li class="menu-item menu-item-type-custom menu-item-object-custom menu-item-home menu-item-1663"> <a class="" href="/blog/">Home</a> </li>
                    
                      <li class="menu-item menu-item-type-custom menu-item-object-custom menu-item-home menu-item-1663"> <a class="" href="/blog/archives">Archives</a> </li>
                    
                      <li class="menu-item menu-item-type-custom menu-item-object-custom menu-item-home menu-item-1663"> <a class="" href="/blog/categories">Categories</a> </li>
                    
                      <li class="menu-item menu-item-type-custom menu-item-object-custom menu-item-home menu-item-1663"> <a class="" href="/blog/tags">Tags</a> </li>
                    
                      <li class="menu-item menu-item-type-custom menu-item-object-custom menu-item-home menu-item-1663"> <a class="" href="/blog/about">About</a> </li>
                    
              </ul>
            </div>
          </nav>

      </div>
  </div>
</header>


  <div id="container">
    <div id="wrap">
            
      <div id="content" class="outer">
        
          <section id="main">
  
    <article id="post-guoshidagang"  class="article article-type-post" itemscope itemprop="blogPost" >
  <div id="articleInner" class="clearfix post-1016 post type-post status-publish format-standard has-post-thumbnail hentry category-template-2 category-uncategorized tag-codex tag-edge-case tag-featured-image tag-image tag-template">
    
    
      <header class="article-header">
        
  
    <h1 class="thumb" itemprop="name">
      <a class="article-title" href="/blog/guoshidagang/">《国史大纲》读书笔记</a>
    </h1>
  

      </header>
    
    <div class="article-meta">
      
	<a href="/blog/guoshidagang/" class="article-date">
	  <time datetime="2016-12-02T16:00:00.000Z" itemprop="datePublished">December 3, 2016</time>
	</a>

      
	<span class="ico-folder"></span>
    <a class="article-category-link" href="/blog/categories/Book-Reading/">Book Reading</a>
 
      
    </div>
    <div class="article-entry" itemprop="articleBody">
      
        <!-- toc -->
<ul>
<li><a href="#第四章霸政时期">第四章”霸政时期”</a><ul>
<li><a href="#第三节齐桓晋文之霸业">第三节：“齐桓晋文之霸业”</a></li>
</ul>
</li>
<li><a href="#第五章军国斗争之新局面">第五章“军国斗争之新局面”</a><ul>
<li><a href="#第二节从宗法封建到新军国之种种变迁">第二节：“从宗法封建到新军国之种种变迁”</a></li>
</ul>
</li>
<li><a href="#第六章民间自由学术之兴起">第六章“民间自由学术之兴起”</a><ul>
<li><a href="#第二节儒墨两家之兴起">第二节：“儒墨两家之兴起”</a></li>
<li><a href="#第五节贵族养贤">第五节：“贵族养贤”</a></li>
<li><a href="#第六节平民学者间之反动思想">第六节：“平民学者间之反动思想”</a></li>
</ul>
</li>
<li><a href="#第七章大一统政府之创建">第七章“大一统政府之创建”</a><ul>
<li><a href="#第二节国家民族之传成">第二节：“国家民族之传成”</a></li>
<li><a href="#第三节第一次统一征服之出现及其覆灭">第三节：“第一次统一征服之出现及其覆灭”</a></li>
<li><a href="#第四节平民政府之产生">第四节：“平民政府之产生”</a></li>
</ul>
</li>
<li><a href="#第八章统一政府文治之演进">第八章“统一政府文治之演进”</a><ul>
<li><a href="#第二节西汉初年之政府">第二节：“西汉初年之政府”</a></li>
<li><a href="#第三节西汉初年的士人与学术">第三节：“西汉初年的士人与学术”</a></li>
<li><a href="#第四节中央政府文治思想之开始">第四节：“中央政府文治思想之开始”</a></li>
<li><a href="#第八节王莽受禅与变法">第八节：“王莽受禅与变法”</a></li>
</ul>
</li>
<li><a href="#第九章统一政府之堕落">第九章“统一政府之堕落”</a><ul>
<li><a href="#第四节外戚参加王室的由来">第四节：“外戚参加王室的由来”</a></li>
<li><a href="#第五节宦官参加王室之由来">第五节：“宦官参加王室之由来”</a></li>
</ul>
</li>
<li><a href="#第十章士族之新地位">第十章“士族之新地位”</a><ul>
<li><a href="#第一节士族政治势力之逐步膨胀">第一节：“士族政治势力之逐步膨胀”</a></li>
<li><a href="#第三节太学清议">第三节：“太学清议”</a></li>
<li><a href="#第四节党锢之狱">第四节：“党锢之狱”</a></li>
<li><a href="#第五节门第之造成">第五节：“门第之造成”</a></li>
<li><a href="#第六节东汉士族之风尚">第六节：“东汉士族之风尚”</a></li>
</ul>
</li>
<li><a href="#第十一章统一政府之对外">第十一章“统一政府之对外”</a><ul>
<li><a href="#第一节两汉之国力比较">第一节：“两汉之国力比较”</a></li>
<li><a href="#第二节西汉与匈奴">第二节：“西汉与匈奴”</a></li>
<li><a href="#第三节东汉与西羌">第三节：“东汉与西羌”</a></li>
</ul>
</li>
<li><a href="#第十二章长期分裂之开始">第十二章“长期分裂之开始”</a><ul>
<li><a href="#第二节旧政权之没落">第二节：“旧政权之没落”</a></li>
<li><a href="#第四节新政权之黑暗">第四节：“新政权之黑暗”</a></li>
<li><a href="#第五节思想界之无出路">第五节：“思想界之无出路”</a></li>
</ul>
</li>
<li><a href="#第十三章统一政府之回光返照">第十三章“统一政府之回光返照”</a><ul>
<li><a href="#第二节西晋王室之弱点">第二节：“西晋王室之弱点”</a></li>
<li><a href="#第四节怀慜被掳与人心之反映">第四节：“怀慜被掳与人心之反映”</a></li>
</ul>
</li>
<li><a href="#第十五章北方之长期纷乱">第十五章“北方之长期纷乱”</a><ul>
<li><a href="#第三节五胡十六国大事简表">第三节：“五胡十六国大事简表”</a></li>
</ul>
</li>
<li><a href="#第十六章南方王朝之消沉">第十六章“南方王朝之消沉”</a><ul>
<li><a href="#第二节南朝王室之恶化">第二节：“南朝王室之恶化”</a></li>
</ul>
</li>
<li><a href="#第十七章北方政权之新生命">第十七章“北方政权之新生命”</a><ul>
<li><a href="#第三节魏孝文迁都及北魏之覆灭">第三节：“魏孝文迁都及北魏之覆灭”</a></li>
<li><a href="#第四节北齐北周文治势力之演进">第四节：“北齐北周文治势力之演进”</a></li>
</ul>
</li>
<li><a href="#第十八章变相的封建势力">第十八章“变相的封建势力”</a><ul>
<li><a href="#第一节九品中正制与门阀">第一节：“九品中正制与门阀”</a></li>
<li><a href="#第二节学校与考试制度之颓废">第二节：“学校与考试制度之颓废”</a></li>
<li><a href="#第五节北方的门第">第五节：“北方的门第”</a></li>
</ul>
</li>
<li><a href="#第十九章变相的封建势力之下之社会形态上">第十九章“变相的封建势力之下之社会形态（上）”</a><ul>
<li><a href="#第二节农民身份之转变">第二节：“农民身份之转变”</a></li>
<li><a href="#第三节西晋之户调制度与官品占田制">第三节：“西晋之户调制度与官品占田制”</a></li>
<li><a href="#第五节兵士的身份及待遇">第五节：“兵士的身份及待遇”</a></li>
</ul>
</li>
<li><a href="#第二十章变相的封建势力之下之社会形态下">第二十章“变相的封建势力之下之社会形态（下）”</a><ul>
<li><a href="#第二节北魏均田制">第二节：“北魏均田制”</a></li>
<li><a href="#第三节西魏的府兵制">第三节：“西魏的府兵制”</a></li>
</ul>
</li>
</ul>
<!-- tocstop -->
<blockquote>
<p>一、当信任何一国之国民，尤其是自称知识在水平线以上之国民，对其本国已往历史，应该略有所知。<br> (否则最多只算一有知识的人，不能算一有知识的国民。) </p>
</blockquote>
<blockquote>
<p>二、所谓对其本国已往历史略有所知者，尤必附随一种对其本国已往历史之温情与敬意。<br> (否则只算知道了一些外国史，不得云对本国史有知识。) </p>
</blockquote>
<blockquote>
<p>三、所谓对其本国已往历史有一种温情与敬意者，至少不会对其本国以往历史抱一种偏激的虚无主义，<br>  (即视本国已往历史为无一点有价值，亦无一处足以使彼满意。)<br> 亦至少不会感到现在我们是站在已往历史最高之顶点，<br> (此乃一种浅薄狂妄的进化观。)<br> 而将我们当身种种罪恶与弱点，一切诿卸于古人。<br> (此乃一种似是而非之文化自谴。) </p>
</blockquote>
<blockquote>
<p>四、当信每一国家必待其国民具备上列诸条件者比数渐多，其国家乃再有向前发展之希望。<br> (否则其所改进，等于一个被征服国或次殖民地之改进，对其国家自身不发生关系。换言之，此种改进，无异是一种变相的文化征服，乃其文化自身之萎缩与消灭，并非其文化自身之转变与发皇。) </p>
</blockquote>
<!--break-->
<p>前三章包括序言没有写笔记，一来当时没做，二来其中大量远古事件只有梗概。但并非不重要，也无谓追求完美。</p>
<h2><span id="第四章霸政时期">第四章”霸政时期”</span></h2><h3><span id="第三节齐桓晋文之霸业">第三节：“齐桓晋文之霸业”</span></h3><blockquote>
<p>总观当时霸业，有二大要义：一则为诸夏耕稼民族之城市联盟，以抵抗北方游牧部落之侵略，因此得保持城市文化，使不致沦亡于游牧之蛮族。二则诸夏和平联合以抵御南方的楚国帝国主义之武力兼并，因此得保持封建文化，使不致即进为郡县的国家。</p>
</blockquote>
<blockquote>
<p>其大势为文化先进诸国逐次结合，而为文化后进诸国逐次征服。同时文化后进诸国，虽逐次征服先进诸国，而亦逐次为先进诸国所同化。其文化落伍诸部族，则逐次消灭，或逐次驱斥。</p>
</blockquote>
<p>原来历史书上所说的“春秋五霸”，实际上主要是由于外力作用下，诸国之间形成的，替代没落的周天子的抱团方式。随着所谓戎狄蛮夷的逐渐同化和被驱逐，这种外在的压力最终不复存在，国与国之间就逐渐开始兼并了。</p>
<p>文化是个很有意思的东西，往往先进的文化会被落后的文化征服，似乎越是有文化，就越是骄奢淫逸…而最终实际上要么征服者被先进文化同化，要么由于处理不好这个问题短短数年就被推翻，历史上这样的例子太多太多了。秦国能统一，大概只是因为他地处边缘，最后被中原文化同化，所以在前辈们已经趴在沙滩上动不了的时候上去补了个刀。</p>
<h2><span id="第五章军国斗争之新局面">第五章“军国斗争之新局面”</span></h2><h3><span id="第二节从宗法封建到新军国之种种变迁">第二节：“从宗法封建到新军国之种种变迁”</span></h3><p>书里总结了几个变化：</p>
<ol>
<li>郡县制替代了贵族世袭的采地，食禄制度兴起和养贤</li>
<li>战争由贵族之间的“游戏”变成残酷杀戮</li>
<li>军民渐趋分治，商业和货币兴起，军人和商人兴起而替换了传统的贵族</li>
<li>废井田开阡陌和税收制度改革</li>
</ol>
<p>这些变化存在内在的逻辑关联。周代礼崩乐坏，贵族之间为争夺有限的资源而产生激烈竞争，从而类似中世纪骑士们”过家家“似得战车战转变为步卒肉搏战。为了战胜对方，不再依赖养尊处优的贵族阶级，而必须产生专业的杀戮工具———军队，而为了鼓励底层士卒又产生了军功系统。军人有了晋升阶梯，成为新贵族，而他们需要得到土地奖励，导致了废除与传统贵族分封制对应的井田制，进一步产生了新土地制度下的税收体系。贵族的没落，商人从贵族的附属流入民间，进入自由商业时代，从而引发了货币的兴起。</p>
<p>看这一系列的描述，总感觉能看到欧洲文艺复兴时期的味道，两者都是封建社会崩溃的过程。但是，为何欧洲随后横扫全球而当年“中国”只是实现了秦朝的大一统？两者类似螺旋上升的不同层次。从战国到文艺复兴，两者相隔千年，生产力在逐渐进步，因此类似战国时期各国对内的扩展和对外的兼并，欧洲各国有更强的实力去扩展和兼并，因此不仅在欧洲，它们有能力去兼并更广大的世界。</p>
<p>另外，以前从历史课本里知道的秦朝大一统后的政策，实际上只是战国的延续，并非秦朝创立的新制度。</p>
<h2><span id="第六章民间自由学术之兴起">第六章“民间自由学术之兴起”</span></h2><h3><span id="第二节儒墨两家之兴起">第二节：“儒墨两家之兴起”</span></h3><blockquote>
<p>“兼爱”与“仁”不同。仁非不爱人，特有亲疏等差，故说“孝悌为仁之本”。人决无不能爱其父母而能爱别人者。“兼爱”异于“别爱”，乃一种无分别之爱，亦可说是一种大同之爱，抹杀个人，只就大群着眼。</p>
</blockquote>
<blockquote>
<p>但是儒、墨两派，有他们共同的精神，他们全是站在全人类的立场，来批评和反对当时的贵族生活。儒家精神比较温和，可说是反对贵族立场的右派；墨家较激烈，可说是左派。以下战国学派，全逃不出儒、墨两家之范围。</p>
</blockquote>
<p>正因为孔子、墨子身处不同环境，所以产生的思想也就有差别。孔子认为孝是爱的本源，通过推己及人来把这种爱由自己父母推及其他人。这应该是家族观念的一种延续。而墨子出身寒苦，则没有深刻的家族意识，有的是抱团取暖的底层人民，所以更强调一种类似共产主义的东西。</p>
<p>这里出现了“右派”和“左派”，对应保守和激进。在改革的时候，保守派更加容易容于当时环境，虽然存在一些不彻底的地方，但温和的演变带来的破坏力也就比较小。激进常常伴随着不懂得妥协，一旦成功，其破坏力通常将不好的和好的一并带走。</p>
<h3><span id="第五节贵族养贤">第五节：“贵族养贤”</span></h3><blockquote>
<p>唯四公子门下，真士少，伪士多。只见游士气焰之高涨，而不见他们的真贡献。</p>
</blockquote>
<blockquote>
<p>此非当时之无士，四公子争以养士为名高，动称“门下食客三千人”，何来有如许士？伪滥杂进，则真士不致。</p>
</blockquote>
<p>物以类聚、人以群分，这个道理无论在那时还是今天都是成立的。一旦群体里滋生了争名夺利的氛围，有识之士也就只能敬而远之或沉默不语了。</p>
<h3><span id="第六节平民学者间之反动思想">第六节：“平民学者间之反动思想”</span></h3><blockquote>
<p>老子的理论，其要者，反尚智，反好动，反游士食客，皆针对当时的现象。注：此种现象，皆春秋时代所无。</p>
</blockquote>
<p>由此可知老子主要生活在战国时期。</p>
<h2><span id="第七章大一统政府之创建">第七章“大一统政府之创建”</span></h2><h3><span id="第二节国家民族之传成">第二节：“国家民族之传成”</span></h3><blockquote>
<p>秦以下，虽封建遗形尚未全绝，然终不能再兴。</p>
</blockquote>
<blockquote>
<p>自此景、武下逮东汉，封建名存实亡，寸土一民，皆统于中央，诸封王唯食邑而已。</p>
</blockquote>
<blockquote>
<p>唯明初封诸王，欲以封建、郡县相杂，然一、再传即废。</p>
</blockquote>
<blockquote>
<p>以唐太宗之英武，唐初文、武诸功臣之出众，诚使君臣割地，各自专制一方，…，。所以不能尔者，由国人对于政治意义之认识，久已不许复有贵族世袭封建制度之存在。</p>
</blockquote>
<p>观念最难形成，也最难改变。《乌合之众》里说，一个民族有其固有的基因；《晚晴七十年》里说一种制度代替另一种制度要二三百年时间。辛亥革命把民主思想带入人心后，复辟就变得不可能了。可笑明初居然想复古，结果落下一朝的各种残疾，可笑。</p>
<blockquote>
<p>战国之秦乃如春秋之楚，不得即此谓秦果夷瞿秋。</p>
</blockquote>
<p>中华民族本是各民族融合而成。若怀着无比狭义的民族主义，哪里还有所谓“中华民族”？</p>
<h3><span id="第三节第一次统一征服之出现及其覆灭">第三节：“第一次统一征服之出现及其覆灭”</span></h3><blockquote>
<p>始皇曰：“天下共苦战阀不休，以有侯王。天下初定，又复立国，是树兵也”。</p>
</blockquote>
<blockquote>
<p>秦君臣此番建树，于中国史上政体之促进有大功绩。后人空以专制讥秦，疏欠平允。</p>
</blockquote>
<p>“罗辑思维”介绍《秦迷》一书，讲到秦始皇为统一六国的一系列政治手段，不知道是真是假。但如果上面所言不虚，则在那时候始皇果然十分先进。</p>
<blockquote>
<p>秦代政治的失败，最主要的在其役使民力之逾量。</p>
</blockquote>
<p>创业中都难免犯各种错误，何况第一次形成一个统一的国家。后世不应该以现在的思想去评议古人的决定。</p>
<h3><span id="第四节平民政府之产生">第四节：“平民政府之产生”</span></h3><blockquote>
<p>项羽、田横之徒皆贵族，而皆不能成事，此可以观世变。</p>
</blockquote>
<p>以前没有从这个方面想过。</p>
<blockquote>
<p>当时平民政府的第二个反动思想则为“无为而治”。</p>
</blockquote>
<blockquote>
<p>即如萧何定律，而夷三族、妖言令、携书律等皆存在。至孝惠、高后、文帝时逐渐废除。唯精神上汉则恭俭，秦则骄奢，此其异。</p>
</blockquote>
<p>汉初政治并不比秦国来得先进，相似的政治制度，在不同的掌权人手里，也会出现不同的结果。但这种人治的成分必须减弱才是系统能长期良性运行的保证。可惜后代还是有不明白这个道理的浑人当道。</p>
<blockquote>
<p>平民政府有其必须完成之两大任务，首先要完成统一，其次为完成文治。</p>
</blockquote>
<p>平民政府只能通过暴力革命夺取政权，然后自然对军人要论功行赏，过渡到文治需要相当漫长的时间。</p>
<h2><span id="第八章统一政府文治之演进">第八章“统一政府文治之演进”</span></h2><h3><span id="第二节西汉初年之政府">第二节：“西汉初年之政府”</span></h3><blockquote>
<p>如是则当时的政治组成，第一层是宗室，第二层是武人，第三层是富人，第四层是杂途。注：…。文学、儒术亦杂途之一。</p>
</blockquote>
<p>这个政治结构或许后代会有所演进，但基本面还是差不多的。这也就算是平民学术兴起带来的结果吧。</p>
<h3><span id="第三节西汉初年的士人与学术">第三节：“西汉初年的士人与学术”</span></h3><blockquote>
<p>秦代焚书，最主要者为六国史记，其次为诗、书古文，而百家言非其所重。</p>
</blockquote>
<blockquote>
<p>焚书本起于议政冲突，博士淳于越称说诗、书，引据古典，主复封建，李斯极斥之，遂牵连而请焚书。</p>
</blockquote>
<p>焚书缘起于朝堂上的政治冲突，但领土统一后消灭人民对故国的怀念，最好的方法似乎也是消灭故国的历史。但任何激进的做法其效果都难以理想，尤其是针对人们心理上的问题。秦刚刚灭六国，六国虽然被灭但人还在，除非政权稳固到反对的声音都安静下来，而这需要非常长的时间，否则只能招致报复和反叛。</p>
<h3><span id="第四节中央政府文治思想之开始">第四节：“中央政府文治思想之开始”</span></h3><blockquote>
<p>注：农民政府之好处在真朴，坏处在无礼貌；可爱初在皇帝、宰相如家人，其弊处则皇帝待宰相如奴仆。</p>
</blockquote>
<p>淳朴通常意味着价值观混乱、多重标准。</p>
<blockquote>
<p>汉初政治，往往有较秦为后退者，注：此因平民政府缺少学术意味之故。</p>
</blockquote>
<p>回想中国历代，每每政治清明国力强盛的时候，其学术活动也是极其活跃的，或体现为诗、辞、歌、赋；每每政治昏暗的时候，其学术活动也陷入低潮，内容晦涩黯淡。虽然这只是一个侧面，但仔细想想也不无道理。</p>
<h3><span id="第八节王莽受禅与变法">第八节：“王莽受禅与变法”</span></h3><blockquote>
<p>王莽的政治，完全是一种书生的政治。</p>
</blockquote>
<blockquote>
<p>王莽的失败，变法让贤的政治理论，从此消失，渐变为帝王万世一统的思想。政治只求保王室之安全，亦绝少注意到一般平民的生活。这不是王莽个人的失败，是中国史演进过程中的一个大失败。</p>
</blockquote>
<p>《国史大纲》的论述里谈到，王莽篡位不是一件单纯的个人行为，否则不至于能坚持长达18年的时间。这实际上承袭了儒家一直以来的轮换让贤思想，是一种政治结构的实践。与之对比民国初年张勋复辟正是由于是一种反先进思想的闹剧，所以不能真正在历史上留下什么。从现在来看，似乎觉得那必然是失败的，或许只是因为接受了“万世一统”的观念太深了。这真的是必然吗？当然不是，只是在合适的时机做一件合适的事情会得到好的效果；反过来，哪怕出发点和事情本身是好的，时机不对，得到的效果可能是相反的，而且在人们心理上造成的负面影响可能很久都无法消失。Sigh，这次失败实际上意味着后世再不会有人尝试这种“脑残”的想法了。</p>
<h2><span id="第九章统一政府之堕落">第九章“统一政府之堕落”</span></h2><h3><span id="第四节外戚参加王室的由来">第四节：“外戚参加王室的由来”</span></h3><blockquote>
<p>西汉初年，宗室、功臣、外戚，为朝廷之三大系。</p>
</blockquote>
<p>随着王朝的演进，由功臣而来的荫功集体首先变得越来越弱。政府渐渐独立于王室，而王室则需要外戚来牵制政府的权利。只是宗室逐渐堕落，而导致外戚实力增大而已。不过，只要外戚不至于改朝换代，则没有大碍，因为外戚是不世袭的。</p>
<h3><span id="第五节宦官参加王室之由来">第五节：“宦官参加王室之由来”</span></h3><p>所谓九卿，是指</p>
<ul>
<li>太常：掌宗庙礼仪</li>
<li>光禄勋：掌宫殿门户文官</li>
<li>卫尉：掌宫殿门户武官</li>
<li>太仆：掌车马</li>
<li>廷尉：掌刑辟</li>
<li>大鸿胪：掌蛮夷归化</li>
<li>宗正：掌宗属</li>
<li>大司农：掌农货</li>
<li>少府：掌山货</li>
</ul>
<p>不得不说，虽然名字听起来都很文雅，实际上都是些帝王身边的贴身侍从或“家务官”。只是帝王身边的侍从，后来都演变成其它更实际职能的官员，至古至今都一样的道理。</p>
<blockquote>
<p>宦本宦学、仕宦，非恶称也。</p>
</blockquote>
<p>宦本是做官与做学问，“本无恶称”，奈何历史上留下骂名的比较多，再加上身体残疾，所以成了一种恶称。比起外戚，宦官的可传递性更弱，所以会被选择成为王室集团的一员，与外朝争夺权力。其实，从宦官当权的本质上来讲，也只是帝王堕落而导致的。</p>
<h2><span id="第十章士族之新地位">第十章“士族之新地位”</span></h2><h3><span id="第一节士族政治势力之逐步膨胀">第一节：“士族政治势力之逐步膨胀”</span></h3><blockquote>
<p>博士弟子额之日益增添。</p>
</blockquote>
<p>须知要扩大一组织的影响力，并不是要层层设卡减少参加的人数，美其名曰提高质量。当然也不能鱼龙混杂，否则会造成前面提到过的“真士不至”的问题。两者之间要求得一个平衡。</p>
<blockquote>
<p>全国各郡县常得平均参加中央政局，对大一统政府之维系，尤为有效。</p>
</blockquote>
<p><em>参与感</em>总是凝聚组织结构的最重要手段。</p>
<h3><span id="第三节太学清议">第三节：“太学清议”</span></h3><blockquote>
<p>士人在政治、社会上势力之表现，最先则为一种“清议”。</p>
</blockquote>
<blockquote>
<p>东汉自光武、明、章，虽云崇奖儒业，…，清议为转移，直至东汉末叶，此风弗衰。</p>
</blockquote>
<p>这段文字读起来非常不容易懂，尤其是其中一些句子如：</p>
<blockquote>
<p>国家喜文法廉吏，以为足以止佞，然文吏习为欺谩，廉吏清在一己，无益百姓流亡，盗贼为害也。</p>
</blockquote>
<blockquote>
<p>承王莽后，加严猛为政，因以成俗，是以郡国所举，多办职俗吏，不应宽博之选。</p>
</blockquote>
<blockquote>
<p>王充论衡亦极辩世俗常高“文吏”，贱下“儒生”之非。</p>
</blockquote>
<p>这里面提到的“文法廉吏”、“文吏”、“廉吏”、“俗吏”之类的实际上指代一类人，他们有一定学问，被地方长官选为辅助的官吏，处理一些复杂的政务；而对应的“儒生”则对应那些有学问但不是官吏的人。文吏由于长期处理事务，有一定的执政经验，所以在社会上的地位比儒生要高；相对的儒生没有行政经验，所以被认为不能承担责任，遇到事情战战兢兢不知道如何处理。</p>
<p>文吏可以由儒生转变过来，而长期处理杂务会导致忠诚正直方面欠缺。一些儒生因为看到文吏的腐败行为而拒绝加入其行列。这些儒生看到其它儒生为了当官而放弃自身在正直方面的追求而责骂他们，这导致了社会上更加轻谩儒生。针对这种现象，《论衡》里的<a href="http://so.gushiwen.org/guwen/bfanyi_4792.aspx" target="_blank" rel="noopener">“程材篇”</a>有很多讨论。</p>
<p>正因为东汉初年这些议论，导致了</p>
<blockquote>
<p>稍后郡国查举，渐移趋向。言事者谓郡国查举不以功次，养虚名者累进，故守职者益懈，而吏事陵迟。</p>
</blockquote>
<p>既然推荐制度不考虑完成的功绩，而重点看个人的品行和社会上的名望，所以渐渐人们开始只注重名声，因此从政者为保持高尚的名节，很多实际事务便无法处理。从政者注意民间舆论是一种进步，然而过于影响政治推移就不好了。</p>
<p>矫枉过正，这也是一种必然的结局。</p>
<h3><span id="第四节党锢之狱">第四节：“党锢之狱”</span></h3><blockquote>
<p>因此宦官之势，乃非外朝士人之力所能摧陷廓清，名士不得不内结外戚，而外戚到底是一种腐败的因袭体，名士遂终与之两败。</p>
</blockquote>
<p>国家虽有法度，而有些群体不在约束范围内，或其行为不为外人知晓而实际上无法执行，则法度是不会起作用的。前者可以通过立法来弥补，或者则需打破一些根深蒂固的东西，实际上比立法更难。</p>
<p>依靠一种污浊的势力去打击另一种污浊的势力，此消彼长，最终只能变成一种“循环发生”的现象了，而国家在这个过程中</p>
<blockquote>
<p>“人之云亡，邦国殄瘁”。</p>
</blockquote>
<p>即身系国家安危的贤人都死了，离亡国就不远了。</p>
<blockquote>
<p>黑暗腐败的汉王室，终于倾覆，依附于王室的外戚与宦官，亦同归于尽。</p>
</blockquote>
<p>外戚与宦官实际上寄生于王室，皮之不存毛将焉附？</p>
<h3><span id="第五节门第之造成">第五节：“门第之造成”</span></h3><blockquote>
<p>“累世经学”与“累世公卿”，便造成士族传袭的势力，积久遂成门第。</p>
</blockquote>
<p>做学问在当时是少数家族专有的权益，而经学又是仕途的入门手段，所以传袭成门第。另一方面，上升途径若只掌握在少数群体手中，则长期以往，那些无法上升群体的矛盾将逐步激化。</p>
<blockquote>
<p>自东汉统一政府的倾覆，遂变成变相之封建。长期的分崩离析，而中国史开始走上衰运。</p>
</blockquote>
<p>钱老的观点一直是：中国政治体制需在平静中不断演进，而长久的战争只会造成倒退。回顾古代、近代一些运动，无不印证这个观点。钱老亲历一段岁月，作为那个时代的知识分子，身系中华民族文化是否能传承下去，书写《国史大纲》来从中国历史的发展来解答和对抗一系列的“新思想”，不可不称作一位斗士。这个线索不妨听听梁文道在其<em>一千零一夜</em>里对这部书的讨论。</p>
<h3><span id="第六节东汉士族之风尚">第六节：“东汉士族之风尚”</span></h3><blockquote>
<p>古者刑不上大夫，故贵族阶级相互有隙，不得直于法庭，则以私斗决之。</p>
</blockquote>
<p>大概决斗也是贵族特有的一种形式吧，无论在东方还是西方。</p>
<blockquote>
<p>礼有之：“父母存，不许友以死”</p>
</blockquote>
<p>大意是指父母在的时候，不能为朋友赴死。如《史记》刺客列传里聂政说：“臣所以降志辱身居市井屠者，徒幸以养老母；老母在，政身未敢许人也”。</p>
<p>可见士族风尚学古。</p>
<blockquote>
<p>道德自为人生不可缺少之要素，然亦只是人生中一端。</p>
</blockquote>
<p>文章指出太过注重道德则会导致两个方面弊端：其一，人们争相以道德来分高下，如苏轼所说</p>
<blockquote>
<p>“上以孝取人，则勇者割股，怯者庐墓；上以廉取人,则弊车羸马,恶衣菲食。”</p>
</blockquote>
<p>这句来自苏轼的《<a href="http://www.laomu.cn/wxzp/xiaoshuo/china/Ts8/html04/mydoc04052.htm" target="_blank" rel="noopener">议学校贡举状</a>》，又读到其中有以下议论</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">凡可以中上意，无所不至矣。德行之弊，一至于此乎！自文章而言之，则策论为有用，诗赋为无益；自政事言之，则诗赋、策论均为无用矣。虽知其无用，然自祖宗以来莫之废者，以为设法取士，不过如此也。岂独吾祖宗，自古尧舜亦然。《书》曰：“敷奏以言，明试以功。”自古尧舜以来，进人何尝不以言，试人何尝不以功乎？议者必欲以策论定贤愚、决能否，臣请有以质之。近世士大夫文章华靡者，莫如杨亿。使杨亿尚在，则忠清鲠亮之士也，岂得以华靡少之。通经学古者，莫如孙复、石介，使孙复、石介尚在，则迂阔矫诞之士也，又可施之于政事之间乎？自唐至今，以诗赋为名臣者，不可胜数，何负于天下，而必欲废之！近世士人纂类经史，缀缉时务，谓之策括。待问条目，搜抉略尽，临时剽窃，窜易首尾，以眩有司，有司莫能辨也。且其为文也，无规矩准绳，故学之易成；无声病对偶，故考之难精。以易学之士，付难考之吏，其弊有甚于诗赋者矣。</span><br></pre></td></tr></table></figure>
<p>“古文运动”本在祛除读书人只注重华美的文体而忽略文章的内容的毛病。出发点是好的，但却也容易走向另一个极端，即上面所说的“无规矩准绳”和“无声病对偶”。表面上看这些文章讨论时政，似乎更切合实际，但“易学”、“难精”，没有统一的衡量标准也导致“难考”。正如今天所说的素质教育，较之过去统一的高考，实则有更大弊端。</p>
<p>另一方面，正如苏轼所说，那些文采华美的文章流传自今，有多少出自贤人的手笔？又有多少出自愚者的手笔？两相比较不难看出其正面远大于负面。王国维《人间词话》的论述，诗词更多的是反映作者胸中的大气象，如无大气象又怎能写出这样的文章？正如前文提到中国国运常常跟文化繁荣的程度相呼应，这应该就是内在的一点原因吧。</p>
<p><em>注：上面提到的唐代的”通榜“是一种不糊名的人才选拔机制。</em></p>
<p>太过注重道德的另一个弊端则是</p>
<blockquote>
<p>若做事太看重道德，便流于重形式而忽略了内容的实际。</p>
</blockquote>
<p>文中提到将军在尚未败北时已自杀殉国，只图自己留个好名。又想起所谓“天子守国门”和崇祯煤山自裁（虽然这并非完全归于道德），是不是有点内在联系呢？至少，这在当时直接导致的后果是</p>
<blockquote>
<p>所以名士势力日大，而终不能铲除宦官的恶势力。因东汉人只看重私人和家庭的道德，故王室倾覆后，再不能重建一共戴的中央，而走入魏晋以下之衰运。</p>
</blockquote>
<p>实际上在帝制的作用下，士人已渐渐由国家的创业者变成临时工，所以缺乏积极性也是难免的了。而随着帝制的不断推演，这种现象愈演愈烈，近代乃至当代的一些现象就不难理解了。</p>
<h2><span id="第十一章统一政府之对外">第十一章“统一政府之对外”</span></h2><blockquote>
<p>因此中国史上对外之胜负、强弱，几乎完全视国内政治为转移。</p>
</blockquote>
<p>自秦朝统一到近代以前，这的确是个事实，无怪国人应对列强手足无措了。</p>
<h3><span id="第一节两汉之国力比较">第一节：“两汉之国力比较”</span></h3><blockquote>
<p>西汉的立国姿态，常是协调的、动的、进取的。</p>
</blockquote>
<blockquote>
<p>东汉的立国姿态，可以说常是偏枯的、静的、退守的。</p>
</blockquote>
<p>这是由建都的位置引出的。早先听说过一个观点，即定都在西边的国家常常是强大的，如西汉、唐；定都在东边的常常是羸弱的，如东汉、宋、明。只觉得这里隐隐有一种内在原因，不甚清楚，而这里给出的讨论让人深思。</p>
<p>自古以来，中国东部土地肥沃、气候适宜，因而经济文化要比西部发达；西部生存环境相对恶劣，所以人民尚武而民风彪悍。定都在西部时，由于政治力量推动（这种力量当容易理解），东部繁华的经济文化向西部侵染，而西部磅礴气象也向东部扩散，实际上对双方都是有大好处的。文化离开大气象便成为靡靡之音，而彪悍的民风如没有文化的熏陶也会逐步走向失控和野蛮。这种东西方循环恰如人体的循环系统，隐隐维持和促进着社会经济文化发展。在这种循环过程中，人为因素便是其中的政治力量。定都在东部时，这种政治力量就不再推动大循环，而转为一种单一的、小规模的、不健康的循环。在缺乏政治力量推动的情况下，人民自身不会去弥补这种缺失。</p>
<p>文中列举</p>
<blockquote>
<p>汉诸帝并有陵寝徙民的制度。</p>
</blockquote>
<p>西汉实行将东部人民迁移到西部，这即政治力量的推动。如果没有则</p>
<blockquote>
<p>人情安土重迁，宁就饥饿，犹群羊聚畜，须主者牧养处置。</p>
</blockquote>
<p>东汉在这种维持稳定力量的缺失下，最终</p>
<blockquote>
<p>东方食少而有黄巾，西边多事而又董卓，此诚两汉兴亡一大关键也。</p>
</blockquote>
<p>联想到美国选州府，常常会在一个没听说过的小城市，其目的也是希望能凭借政治力量逐步平衡各地的差距，最终达到稳定国家的目的。虽然一段时间可能会造成一些效率降低，但长远来看正面作用更可观，不得不佩服这种高明的选择。</p>
<p>另一方面，西汉</p>
<blockquote>
<p>大抵是一个杂色的局面。东汉则渐渐从杂色的转变成一色，…</p>
</blockquote>
<p>又联想到一些企业招聘员工的时候常注重一个dynamics，即吸纳不同国家、文化背景下的人群。其基本原理在于不同人对事物的观点常常是不同的，这样的环境更加容易产生优秀的思想。又如美国高校有毕业生不能留在本校任教职。这种种做法都是为了避免一种“近亲繁殖”的问题。</p>
<p>东汉这种按照某种规则给不同人群划分品节的陋习也就随着历史流传给了后面的朝代。</p>
<blockquote>
<p>太宗置官品令，谓房玄龄曰：“朕设此官员，以待贤士。工商杂色之流，假令术逾侪类，止可厚 给财物，必不可超授官秩。</p>
</blockquote>
<p>可见唐朝也袭此流弊。</p>
<h3><span id="第二节西汉与匈奴">第二节：“西汉与匈奴”</span></h3><blockquote>
<p>观去病之将兵，较之项王未多逊。…</p>
</blockquote>
<p>一段注释解释了一个以前困扰我的问题，即为何在《史记》中卫青霍去病合为一列传（111），而独为李将军一列传（109）。原因在于卫青和霍去病同为亲贵，所以与底层豪杰李广恰似两个相对的党派。</p>
<h3><span id="第三节东汉与西羌">第三节：“东汉与西羌”</span></h3><blockquote>
<p>当时士大夫见朝事无可为，唯有拥兵以戮力边檄，尚足为功名一径…</p>
</blockquote>
<p>这也导致了后来三国各地割据的局面。</p>
<h2><span id="第十二章长期分裂之开始">第十二章“长期分裂之开始”</span></h2><h3><span id="第二节旧政权之没落">第二节：“旧政权之没落”</span></h3><blockquote>
<p>散漫的农民在饥饿线上临时结合起来，其力量不够得推翻他。</p>
</blockquote>
<blockquote>
<p>且以中国疆域之展布，纵使大饥荒，亦必夹有丰收的地带，要一般农民一致奋起，事亦不易。于是无可团结的社会，乃借助于“宗教”与“迷信”。农民结合于宗教与迷信的传播之下，而一致奋起，成为东汉末年之黄巾。</p>
</blockquote>
<blockquote>
<p>国家本是精神的产物，把握时代力量的名士大族，他们不忠心要一个统一的国家，试问统一国家何从成立？</p>
</blockquote>
<p>历史上成功的农民起义，往往不真的是农民群体在起决定性作用，而是附庸在这个群体上真正起到决策作用的精英。正如作者所说，农民不具备团结一致的奋斗精神，往往会被一些近期的利益所诱惑，从而从内部分崩离析。看黄巾之乱、太平天国、李自成，再对比刘邦、朱元璋，就能发现其中的区别。精英阶级一旦无法通过合法的晋升阶梯入仕，那么积累的力量就会从别处发泄出来。</p>
<h3><span id="第四节新政权之黑暗">第四节：“新政权之黑暗”</span></h3><blockquote>
<p>自古受命及中兴之君，易尝不得贤人君子与之共治天下者乎？及其得贤也，曾不出阎巷，岂幸相遇哉？上之人不求之耳。今天下尚未定，此特求贤之急时也。“孟公绰为赵、魏老则优，不可以为膝、薛大夫”。若必廉士而后可用，则齐桓其何以霸世！今天下得无有被褐怀玉而钓于渭滨者乎？又得无盗嫂受金而未遇无知者乎？二三子其佐我明扬仄陋，唯才是举，吾得而用之。</p>
</blockquote>
<blockquote>
<p>夫有行之士未必能进取，进取之士未必能有行也。陈平岂笃行，苏秦岂守信邪？而陈平定汉业，苏秦济弱燕。由此观之，士有偏短，庸可废乎！有司明恩此义，则士无遗滞，官无废业矣。</p>
</blockquote>
<blockquote>
<p>昔伊挚、傅说出于贱人，管仲，桓公贼也，皆用之以兴。萧何、曹参，县吏也，韩信、陈平负汗辱之名，有见笑之耻，卒能成就王业，声著千载。吴起贪将，杀妻自信，散金求官，母死不归，然在魏，秦人不敢东向；在楚，则三晋不敢南谋。今天下得无有至德之人，放在民间，及果勇不顾，临敌力战：若文俗之吏，高才异质，或堪为将守；负汗辱之名，见笑之行；或不仁不孝，而有治国用兵之术。其各举所知，勿有所疑。</p>
</blockquote>
<p>魏武三诏令，真前无古人后无来者，霸气侧漏。</p>
<blockquote>
<p>“天下无有孤，不知几人称王，几人称帝？”，此不足为篡窃之正大理由。</p>
</blockquote>
<blockquote>
<p>阴谋不足以镇压反动，必然继之以惨毒的淫威。</p>
</blockquote>
<p>人心是奇怪的东西，一个正大光明的理由能让它平静下来，反之，如果一开始的理由就是不对的，将来总有一天要还清当年欠下的债务。再强大的武力，也只是在一段时间内能镇压，不是长久之计。</p>
<p>正是这种不够光明正大的理由，奠定了魏晋这一历史上较黑暗混乱的时代。</p>
<h3><span id="第五节思想界之无出路">第五节：“思想界之无出路”</span></h3><blockquote>
<p>但要提倡法治，起码的先决条件，在上应有一个较稳定的政权。【注：政权不稳定，法治精神无所倚依而生根。】政权之稳定，亦应依附于此政权者先有一番较正义，至少较不背乎人情的理想或事实。</p>
</blockquote>
<p>人们往往只注意到法治的好处，却忽略这一基本的前提。在政权不稳定的状态下提倡法治，只会使政权更加动荡，导致更糟糕的结果。作者在文字上总有一个“较”字修饰，读起来不禁觉得实在精辟。</p>
<h2><span id="第十三章统一政府之回光返照">第十三章“统一政府之回光返照”</span></h2><h3><span id="第二节西晋王室之弱点">第二节：“西晋王室之弱点”</span></h3><blockquote>
<p>一、没有光明的理想为之指导。<br>二、贵族家庭之腐化。</p>
</blockquote>
<p>西晋处在历史这样一个节点上，贵族尚没有意识到理想、教育的重要性，所以有乘“羊车”、食“肉糜”的奇葩出现，而当代的“新贵族”较以往已经进步很多了。</p>
<h3><span id="第四节怀慜被掳与人心之反映">第四节：“怀慜被掳与人心之反映”</span></h3><p>作者从帝王、皇后、大臣、将军、士族几个方面的讨论，给人一个直观的印象：西晋是一个彻头彻尾无廉耻气节的政权。</p>
<h2><span id="第十五章北方之长期纷乱">第十五章“北方之长期纷乱”</span></h2><h3><span id="第三节五胡十六国大事简表">第三节：“五胡十六国大事简表”</span></h3><blockquote>
<p>盖浅化之民，性情暴戾，处粗野之生活中，尚堪放纵自适。一旦处繁杂之人事，当柔靡之奉养，转使野性无所发抒，冲荡溃决，如得狂疾。</p>
</blockquote>
<p>可笑一些“精英”附庸在这样“粗野”的人身边，以为可以依仗成就一番事业，往往最终难逃悲催的下场，正是由于不懂这样的道理呀！</p>
<h2><span id="第十六章南方王朝之消沉">第十六章“南方王朝之消沉”</span></h2><h3><span id="第二节南朝王室之恶化">第二节：“南朝王室之恶化”</span></h3><blockquote>
<p>南朝的王室，在富贵家庭里成长起来，他们只稍微熏陶到了一些名士派放情恣志的风尚，而没有浸沉到名士们的家教与门风，又没有领略得名士们所研讨的玄言与远致。</p>
</blockquote>
<p>只注意到外在表现而不理解内在机理，今天这样的情况不也大有人在么？一本本成功学书籍畅销，一篇篇心灵鸡汤文在朋友圈流传，一条条形而上的不知所云的分享大都是类似的情况吧。多少人不去多读几本书，多做些思考和研究，不在实践中总结反思，而是随手捡起几个普适的概念大肆宣扬，真是误人误己。</p>
<blockquote>
<p>由名士为之则为雪夜访友，无知识，无修养，则变为达旦捕鼠。由名士为之则为排门看竹，无知识，无修养，则变为往寺庙偷狗吃。</p>
</blockquote>
<p>名士的风尚虽只能独善其身，但总算雅致；皇室以此为精神寄托本就不对，何况画虎类犬，就只能贻笑大方了。后人看着当然觉得好笑，在当时却是整个社会一片黑暗没有出路了。</p>
<h2><span id="第十七章北方政权之新生命">第十七章“北方政权之新生命”</span></h2><h3><span id="第三节魏孝文迁都及北魏之覆灭">第三节：“魏孝文迁都及北魏之覆灭”</span></h3><blockquote>
<p>塞北荒寒，不配做新政治的中心。</p>
</blockquote>
<p>地理决定论自有其内在道理。</p>
<blockquote>
<p>惜乎孝文南迁五年即死。</p>
</blockquote>
<p>历史从来不以人的意志为转移，而这正是所谓的气数已尽吧。</p>
<blockquote>
<p>文治基础尚未稳固，而武臣出路却已断塞。</p>
</blockquote>
<p>改革最忌讳建设尚未完成而已经将原有的关系彻底打破。这样的改革如果顺利则只能说是运气好，否则造成的反弹可能完全推翻改革本来已经带来的正面的效果。</p>
<blockquote>
<p>一个国家，同时摆出两个绝不相同的社会，势必酿乱。</p>
</blockquote>
<p>然而一个国家又非常容易酿成两个绝不相同的社会。比如前面讨论东西汉差异的时候提到的，定都的位置不同，在长安则由政治力量引导产生国内东西大循环；在洛阳则东部南北小循环，使得东西隔绝。如果政治力量无法处理好这种地区间的均衡，则必然酿成祸乱。</p>
<blockquote>
<p>凡历史上有一番改进，往往有一度反动，不能因反动而归咎改进之本身；然亦须在改进中能善处反动方妙。魏孝文卒后，鲜卑并不能继续改进，并急速腐化，岂得以将来之反动，追难孝文！</p>
</blockquote>
<p>鲜卑本北方稍欠文化的部落，一旦处于温柔繁华的环境，腐化堕落的速度更是迅速，这与人成长的环境是紧密相关的。想起游戏《十字军之王2》里的设定：部落虽有较强武力，但在政治落后，容易招致内乱，而战斗士气随战争结束时间增长会迅速下降。这样的设定更加符合真实的情况，对比《三国志》系列喜欢把蛮族势力的武将个个设置成武力一般头脑简单的弱智要高明好多。</p>
<h3><span id="第四节北齐北周文治势力之演进">第四节：“北齐北周文治势力之演进”</span></h3><blockquote>
<p>齐律尤为隋、唐所本。</p>
</blockquote>
<blockquote>
<p>由唐至清，皆本隋律，隋律则本于齐。</p>
</blockquote>
<p>从这种意义上讲，这似乎是上一个时代的终结与下一个时代的开始。高晓松所说中国古代的时代划分，好像也是以这里为分界的。</p>
<blockquote>
<p>治民之本，莫若宰守。治民之体，先当治心。</p>
</blockquote>
<p>这句话的大意是，“地方行政长官是治理人民的根本。要想治理人民，先要治理他们的内心”。这与阳明先生的心学似乎是呼应的。</p>
<blockquote>
<p>于是以前的官吏，为门资所应得；而此后的官吏，则将为民众负责任。</p>
</blockquote>
<p>这样的设定，在建设的同时不至于彻底废除历史的旧习，是一种政治上的妥协，于进步实有利。</p>
<blockquote>
<p>僚吏俊彦，旦理公务，晚就讲习。</p>
</blockquote>
<blockquote>
<p>从学术影响到政治，回头再走上一条合理的路，努力造出一个合理的政府来。</p>
</blockquote>
<p>“从学术影响政治”是钱老支持的主张，从前面的一些讨论中早有明示。衷心希望将来能真的有这么一天。</p>
<h2><span id="第十八章变相的封建势力">第十八章“变相的封建势力”</span></h2><h3><span id="第一节九品中正制与门阀">第一节：“九品中正制与门阀”</span></h3><blockquote>
<p>三国丧乱之际…，一时逆转，而倒退为秦、汉初年之军功得官。</p>
</blockquote>
<p>越是乱世，越崇尚军功，越是崇尚结果导向而不计后果。此消彼长，意味着与军功相对的，较斯文的方式在社会上无法晋升。想到当今各互联网公司提倡的狼性文化、军功导向，不禁觉得离文化真正兴盛还有很远的路要走。</p>
<blockquote>
<p>于是有魏尚书陈群之“九品官人法”。</p>
</blockquote>
<p>九品官人法于州设置大中正，于郡设置小中正，中正负责本地贤良的举荐。中正并非真正的官职，而是由中央官员兼职，因当时处乱世而人才集聚于中央。</p>
<p>与汉代查举相比，九品中正制有两个最大不同：</p>
<ol>
<li>查举人才归地方而中正制归中央；</li>
<li>查举只涉及入仕而中正制是一套完整的官员入仕、考察机制。</li>
</ol>
<p>处于乱世，中央往往急需各地人才，所以这样的设定无可厚非。待乱世已平，人才的流动仍然遵循从地方到中央就不合时宜了。这直接导致了地方人才凋零，而汇聚中央的人才又无处施展自己的能力。</p>
<p>所以当时已有人察觉这样的状态，而有</p>
<blockquote>
<p>今天下复归一统，自当仍将查举权付之地方长官，不必再要一个中正。</p>
</blockquote>
<p>九品中正制还注重一个“品”字。</p>
<blockquote>
<p>“品”者履行，“状”者才能、绩效。</p>
</blockquote>
<p>处乱世时，由于只重视军功，导致为官者品行良莠不齐。而九品中正制正为校正这种过失，而重新强调品的重要性。官员品行好则升迁，品行不好则降级，于是造成一些高品低能的状况。</p>
<p>一种制度往往因当时的社会状态产生。一旦社会状态发生变化，制度需要做相应调整，否则就会不合时宜。但制度形成容易，变化则难，因制度而产生的利益阶层总不会轻易放弃自己的利益。然而，有制度总比没有制度要好。回想起多年前，从小学时候我就有个不解的问题：比如我所居住的县城里，县长这样的官员是如何成长起来的？这个问题实际上我现在也不清楚，仿佛没有固定的方法和评价标准，既不看是否学识出众，也不看是否有良好的品行。想到此，再与上面的状态比较，不难发现现在的政治制度仍然在乱世走向治世的初级阶段而已。</p>
<h3><span id="第二节学校与考试制度之颓废">第二节：“学校与考试制度之颓废”</span></h3><blockquote>
<p>东汉的累世经学，即为造成门阀之一因。但到门阀势力一旦长成，学校与考试制度即不见重要，难于存在。</p>
</blockquote>
<p>联想到今天的两个现象，即所谓素质教育和出国热。这些现象的本质是什么呢？是希望打破以往国家制定的高考制度，而独立出另外的标准。这些标准跟高考制度最大的差别在哪呢？更加考察出身而已。农村的孩子没有机会学习钢琴、舞蹈，没有钱送到国外镀金。想想这些城里的家长，有相当部分实际上是高考制度的受益者。这与书中讨论的问题难道不是一个么？历史总是惊人的相似。</p>
<h3><span id="第五节北方的门第">第五节：“北方的门第”</span></h3><blockquote>
<p>故南士借上以凌下，北族则附下以抗上。</p>
</blockquote>
<p>真正的利害在于存在的合法性。南方士族与皇族是相互依存的，故南士的合法性在于皇族而不在民众；北方士族与异族皇族始终不是一路的，所以其合法性在于能组织民众。联想到军阀的合法性不在自身而在于能否为依附于军阀的下属们谋求利益。在真正的利害关系之前，其它因素如民族大义等，只能是少数人的追求，而从大势上讲是不足道的。</p>
<h2><span id="第十九章变相的封建势力之下之社会形态上">第十九章“变相的封建势力之下之社会形态（上）”</span></h2><h3><span id="第二节农民身份之转变">第二节：“农民身份之转变”</span></h3><blockquote>
<p>李典之众自有武装，故称“部曲”</p>
</blockquote>
<p>部曲在这里指私兵，即归附之前就已经拥有一定武装力量。</p>
<blockquote>
<p>局势逐渐澄清，各地的强宗豪族，逐渐消并其势力于几个大势力之下，再建政府，这便是三国。</p>
</blockquote>
<p>于东汉末年的乱世，由于中央集权的瓦解，地方只能自建势力以在乱世图存，而待大势力兴起则各择归附，于是有所谓“三国”。</p>
<blockquote>
<p>两汉以来的农民，以公民资格自耕其地，而向政府纳租。现在是政府将无主荒田指派兵队耕种，无形中，农田的所有权，又从农民手里转移到政府去。</p>
</blockquote>
<p>读各种历史，容易受到情感影响而迷失本质，往往纠结于正义和邪恶。实际上，真正应该关注的是内里本质的东西，只有拨开表面上的掩饰才能看到事情的真相。土地的所有权在谁手里，谁的社会地位才能有一定保障，否则无论以任何借口，都无法掩盖其暴乱的事实。</p>
<p>无论何种正义的理由，都不能剥夺私有财产。</p>
<h3><span id="第三节西晋之户调制度与官品占田制">第三节：“西晋之户调制度与官品占田制”</span></h3><blockquote>
<p>这一个制度的用意，并不是授予强宗豪族以私占的特权，乃是要把当时强宗豪族先已私占的户口及田亩括归公有，而许他们一个最高限度的私占权。</p>
</blockquote>
<p>政治的艺术在于和平演变。在当时的政治环境下，从强宗豪族手里拿回户口和土地的确难以办到，但其中的政治智慧却不容忽视。在实力欠缺的情况下，勉强坚持一些不切实际却看似政治正确的主张是没有意义的，反而容易招到反噬的效果。所以不如以量化的方式先妥协，待实力发生变化后再逐步达到目的。历史上因为校真一两个口号或主义，没有推动历史进步，反而造成短暂倒退的例子比比皆是。而那些明知这样的后果，仍然煽动无知人群的背后的人，实际唯恐天下不乱而无法造就个人英雄，其心可诛。</p>
<h3><span id="第五节兵士的身份及待遇">第五节：“兵士的身份及待遇”</span></h3><blockquote>
<p>其先入士籍者得优廪，又可免役，其时则兵胜于民。渐次军旅之事，不为时重，则士伍唯以供役，又廪给日薄，其时则农胜于兵。</p>
</blockquote>
<p>识时务者为俊杰。</p>
<blockquote>
<p>要为军人谋出身，势必与贵族特权实力相冲突，如战国吴起在楚、商鞅在秦之事。</p>
</blockquote>
<blockquote>
<p>军人的地位，只与奴隶、罪犯相等，从军只是当苦役。</p>
</blockquote>
<p>战国为用兵之际，所以自然有人站出来提高军人的社会地位，而在相对和平的时代，不会有这样的事情。此外，看既得利益集团的人在什么行业就能看出利益分配的大头所在。</p>
<blockquote>
<p>军人的地位如此，如何可以为国宣劳，担负光复中原的重任？</p>
</blockquote>
<p>实则社会利益之分配必须与目标一致，否则要么无法达成目标，要么演变成无法控制的结果。</p>
<h2><span id="第二十章变相的封建势力之下之社会形态下">第二十章“变相的封建势力之下之社会形态（下）”</span></h2><h3><span id="第二节北魏均田制">第二节：“北魏均田制”</span></h3><blockquote>
<p>此制用意并不在求田亩之绝对均给，只求富贵者稍有一限度，贫者亦有一最低之水平。</p>
</blockquote>
<blockquote>
<p>…然此等皆不足为此制深病，治史者当就大体着眼也。</p>
</blockquote>
<p>仍然体现着政治之循序渐进的思想。</p>
<blockquote>
<p>尤要者则在绝其荫冒，使租收尽归公上。</p>
</blockquote>
<p>“荫”则为逃避劳役而多户假作一户，“冒”则为丧乱中无主的土地被冒领。实际上，这两者都是针对豪强而言，普通人没有能力去荫冒。均田制使得“多户多得”，所以没有人再愿意附属在豪强上，从而独立出来。</p>
<blockquote>
<p>正租入中央国库，义租纳郡县，备水旱灾。</p>
</blockquote>
<p>那时已经有建立地方粮食储备以应对水旱灾害，实历史进步也。</p>
<blockquote>
<p>不教民战，是谓弃之。临时抽丁，皆弃之也。</p>
</blockquote>
<p>临时抓壮丁，又没有经过军事训练，实际上就是放弃他们呀！这样的情况下，军队又怎么能有战斗力呢？</p>
<h3><span id="第三节西魏的府兵制">第三节：“西魏的府兵制”</span></h3><blockquote>
<p>府兵制长处，只在有挑选、有教训；而更重要的，在对兵士有善意，有较优的待遇。将此等兵队与临时的发奴为兵、谪役为兵，以及抽丁为兵相敌，自然可得胜利。</p>
</blockquote>
<p>“仁者无敌”。</p>
<blockquote>
<p>所以自行“均田”，而经济上贵族与庶民的不平等取消；自行”府兵“，而种族上胡人与汉人的隔阂取消。</p>
</blockquote>
<p>能看到社会上的主要矛盾，而实施缓和的政治手段逐步消除这种矛盾，才是为政者需要不断思考的问题。</p>
<blockquote>
<p>古之帝王所以建诸侯、立百官，非欲富贵其身而尊荣之，盖以天下至广，非一人所能独治，是以博访贤才，助己为治。若知其贤，则以礼命之。其人闻命之日，则惨然曰：“凡受人之事，任人之劳，何舍己而从人？”又自勉曰：“天生儁士，所以利时。彼人主欲与我共为治，安可苟辞？”于是降心受命。其居官也，不惶恤其私而忧其家。故妻子或有饥寒之弊而不顾。于是人主赐以俸禄、尊以轩冕而不以为患，贤臣受之亦不以为德。为君者诚能以此道授官，为臣者诚能以此情受位，则天下之大，可不言而治。后世衰微，以官职为私恩，爵禄为荣惠。君之命官，亲则授之，爱则任之。臣之受位，可以尊身而润屋者，则迂道而求之。至公之道没，而奸诈之萌生。天下不治，正为此矣。<br>今圣上中兴，思去浇伪．在朝之士，当念战事之艰难。才堪者审己而当，不堪者收短而避。使天官不妄加，王爵不虚受，则淳素之风庶几可返。</p>
</blockquote>
<p>这段话源于《周书·文帝纪下》，虽过于理想，没有真正给出实现的步骤，但仍然值得称赞。常常见到今天的创业者，仅有一点点成绩便招聘大量的员工，动则以手下的人数作为人生成功的衡量，实在好笑。</p>

      
    </div>
    <footer class="entry-meta entry-footer">
      
	<span class="ico-folder"></span>
    <a class="article-category-link" href="/blog/categories/Book-Reading/">Book Reading</a>

      
  <span class="ico-tags"></span>
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/blog/tags/国史大纲/">国史大纲</a></li></ul>

      
    </footer>
    <hr class="entry-footer-hr">
  </div>
  
</article>

<!-- Table of Contents -->

  
    <article id="post-git-precommit-hook"  class="article article-type-post" itemscope itemprop="blogPost" >
  <div id="articleInner" class="clearfix post-1016 post type-post status-publish format-standard has-post-thumbnail hentry category-template-2 category-uncategorized tag-codex tag-edge-case tag-featured-image tag-image tag-template">
    
    
      <header class="article-header">
        
  
    <h1 class="thumb" itemprop="name">
      <a class="article-title" href="/blog/git-precommit-hook/">PHP项目的Git pre-commit hook</a>
    </h1>
  

      </header>
    
    <div class="article-meta">
      
	<a href="/blog/git-precommit-hook/" class="article-date">
	  <time datetime="2016-01-26T06:20:00.000Z" itemprop="datePublished">January 26, 2016</time>
	</a>

      
	<span class="ico-folder"></span>
    <a class="article-category-link" href="/blog/categories/Tech/">Tech</a>
 
      
    </div>
    <div class="article-entry" itemprop="articleBody">
      
        <p>将此脚本放在.git/hook/pre-commit就行。实际上git支持多种<a href="https://git-scm.com/book/uz/v2/Customizing-Git-Git-Hooks" target="_blank" rel="noopener">hooks</a>，根据需要可以在各个阶段自动完成一些任务。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line">#!/bin/bash</span><br><span class="line"># Author: Remigijus Jarmalavičius &lt;remigijus@jarmalavicius.lt&gt; </span><br><span class="line"># Author: Vytautas Povilaitis &lt;php-checker@vytux.lt&gt;</span><br><span class="line">#</span><br><span class="line"># XDebug check added by William Clemens &lt;http://github.com/wesclemens&gt;</span><br><span class="line"></span><br><span class="line">ROOT_DIR=&quot;$(pwd)/&quot;</span><br><span class="line">LIST=$(git diff-index --cached --name-only --diff-filter=ACMR HEAD)</span><br><span class="line">ERRORS_BUFFER=&quot;&quot;</span><br><span class="line">for file in $LIST</span><br><span class="line">do</span><br><span class="line">    EXTENSION=$(echo &quot;$file&quot; | grep &quot;.php$&quot;)</span><br><span class="line">    if [ &quot;$EXTENSION&quot; != &quot;&quot; ]; then</span><br><span class="line">        ERRORS=$(php -l $ROOT_DIR$file 2&gt;&amp;1 | grep &quot;Parse error&quot;)</span><br><span class="line">        if [ &quot;$ERRORS&quot; != &quot;&quot; ]; then</span><br><span class="line">            if [ &quot;$ERRORS_BUFFER&quot; != &quot;&quot; ]; then</span><br><span class="line">                ERRORS_BUFFER=&quot;$ERRORS_BUFFER\n$ERRORS&quot;</span><br><span class="line">            else</span><br><span class="line">                ERRORS_BUFFER=&quot;$ERRORS&quot;</span><br><span class="line">            fi</span><br><span class="line">            echo &quot;Syntax errors found in file: $file &quot;</span><br><span class="line">        fi</span><br><span class="line"></span><br><span class="line">        # Check for xdebug statments</span><br><span class="line">        ERRORS=$(grep -nH xdebug_ $ROOT_DIR$file | \</span><br><span class="line">                 sed -e &apos;s/^/Found XDebug Statment : /&apos;)</span><br><span class="line">        if [ &quot;$ERRORS&quot; != &quot;&quot; ]; then</span><br><span class="line">            if [ &quot;$ERRORS_BUFFER&quot; != &quot;&quot; ]; then</span><br><span class="line">                ERRORS_BUFFER=&quot;$ERRORS_BUFFER\n$ERRORS&quot;</span><br><span class="line">            else</span><br><span class="line">                ERRORS_BUFFER=&quot;$ERRORS&quot;</span><br><span class="line">            fi</span><br><span class="line">        fi</span><br><span class="line">    fi</span><br><span class="line">done</span><br><span class="line">if [ &quot;$ERRORS_BUFFER&quot; != &quot;&quot; ]; then</span><br><span class="line">    echo </span><br><span class="line">    echo &quot;Found PHP parse errors: &quot;</span><br><span class="line">    echo -e $ERRORS_BUFFER</span><br><span class="line">    echo </span><br><span class="line">    echo &quot;PHP parse errors found. Fix errors and commit again.&quot;</span><br><span class="line">    exit 1</span><br><span class="line">else</span><br><span class="line">    echo &quot;No PHP parse errors found. Committed successfully.&quot;</span><br><span class="line">fi</span><br></pre></td></tr></table></figure>

      
    </div>
    <footer class="entry-meta entry-footer">
      
	<span class="ico-folder"></span>
    <a class="article-category-link" href="/blog/categories/Tech/">Tech</a>

      
  <span class="ico-tags"></span>
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/blog/tags/git/">git</a></li></ul>

      
    </footer>
    <hr class="entry-footer-hr">
  </div>
  
</article>

<!-- Table of Contents -->

  
    <article id="post-useful-links"  class="article article-type-post" itemscope itemprop="blogPost" >
  <div id="articleInner" class="clearfix post-1016 post type-post status-publish format-standard has-post-thumbnail hentry category-template-2 category-uncategorized tag-codex tag-edge-case tag-featured-image tag-image tag-template">
    
    
      <header class="article-header">
        
  
    <h1 class="thumb" itemprop="name">
      <a class="article-title" href="/blog/useful-links/">Useful Links</a>
    </h1>
  

      </header>
    
    <div class="article-meta">
      
	<a href="/blog/useful-links/" class="article-date">
	  <time datetime="2016-01-26T02:55:00.000Z" itemprop="datePublished">January 26, 2016</time>
	</a>

      
	<span class="ico-folder"></span>
    <a class="article-category-link" href="/blog/categories/Tech/">Tech</a>
 
      
    </div>
    <div class="article-entry" itemprop="articleBody">
      
        <p>下面按照分类列举一些非常有用的信息。</p>
<!--break-->
<h2><span id="php相关">PHP相关</span></h2><ul>
<li><a href="http://codular.com/curl-with-php" target="_blank" rel="noopener">PHP curl的使用</a>。</li>
<li><a href="http://chrsm.org/2013/05/05/static-analysis-tools-for-php/" target="_blank" rel="noopener">PHP代码静态分析工具讨论</a>。</li>
</ul>
<h2><span id="算法相关">算法相关</span></h2><ul>
<li><a href="http://csclab.murraystate.edu/bob.pilgrim/445/munkres.html" target="_blank" rel="noopener">任务分配算法Munkres’s Algorithm</a>。</li>
</ul>
<h2><span id="jekyll相关">Jekyll相关</span></h2><ul>
<li><a href="http://ask.xmodulo.com/upgrade-ruby-centos.html" target="_blank" rel="noopener">CentOS上升级Ruby</a>。</li>
</ul>
<h2><span id="git相关">Git相关</span></h2><ul>
<li><a href="http://tecadmin.net/how-to-upgrade-git-version-1-7-10-on-centos-6/" target="_blank" rel="noopener">CentOS上升级Git</a>。</li>
<li><a href="https://www.atlassian.com/git/tutorials/setting-up-a-repository" target="_blank" rel="noopener">tlassian给出的非常好的Git入门文档</a>。</li>
</ul>
<h2><span id="分布式系统">分布式系统</span></h2><ul>
<li><a href="https://engineering.linkedin.com/distributed-systems/log-what-every-software-engineer-should-know-about-real-time-datas-unifying" target="_blank" rel="noopener">有关Log基本原理的经典好文，理解Kafka必读</a>。</li>
</ul>
<h2><span id="计算机网络">计算机网络</span></h2><ul>
<li><a href="http://www.cse.wustl.edu/~jain/videos.htm" target="_blank" rel="noopener">Raj Jain的视频资源</a></li>
</ul>

      
    </div>
    <footer class="entry-meta entry-footer">
      
	<span class="ico-folder"></span>
    <a class="article-category-link" href="/blog/categories/Tech/">Tech</a>

      
  <span class="ico-tags"></span>
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/blog/tags/links/">links</a></li></ul>

      
    </footer>
    <hr class="entry-footer-hr">
  </div>
  
</article>

<!-- Table of Contents -->

  
    <article id="post-git-recipe"  class="article article-type-post" itemscope itemprop="blogPost" >
  <div id="articleInner" class="clearfix post-1016 post type-post status-publish format-standard has-post-thumbnail hentry category-template-2 category-uncategorized tag-codex tag-edge-case tag-featured-image tag-image tag-template">
    
    
      <header class="article-header">
        
  
    <h1 class="thumb" itemprop="name">
      <a class="article-title" href="/blog/git-recipe/">有用的Git相关汇总</a>
    </h1>
  

      </header>
    
    <div class="article-meta">
      
	<a href="/blog/git-recipe/" class="article-date">
	  <time datetime="2016-01-22T02:55:00.000Z" itemprop="datePublished">January 22, 2016</time>
	</a>

      
	<span class="ico-folder"></span>
    <a class="article-category-link" href="/blog/categories/Tech/">Tech</a>
 
      
    </div>
    <div class="article-entry" itemprop="articleBody">
      
        <h4><span id="平时收集的一些有用的git命令持续更新">平时收集的一些有用的git命令（持续更新）：</span></h4><ul>
<li>git reset –hard: 去掉所有改动，比如某些文件被改动了，用这招可以将它们都干掉，主要用于处理刚刚接手的杂乱版本，后面跟上commit号就会跳到对应的版本。</li>
<li>git diff –diff-filter=D –name-only -z &brvbar; xargs -0 git rm 批量删除所有被delete的文件</li>
<li>git branch –merged master &brvbar; grep -v master &brvbar; xargs git branch -d 删除所有已经与master合并的分支，用于清理中间的一个本地git库<!--break--></li>
<li>git clean -fd: 干掉所有untracked file and folder，上面这招不会去掉新添加的文件或文件夹，靠这招更加彻底清除。</li>
<li>git branch -D: 干掉一个分支，主要用于去掉那些已经没有意义的分支，如fix某个bug的分支。</li>
<li>git checkout – <filename>：去掉被add了的文件，用.表示去掉所有被add的文件。</filename></li>
<li>git checkout -b <branchname>: 从当前分支分出一个新分支，主要用于创建一个feature或bug分支。</branchname></li>
<li>git diff &lt;commit id1/reflog id&gt; &lt;commit id2/reflog id&gt; <filename>: 查看某个文件两个不同版本间的差别。</filename></li>
<li>git log <filename>：查看某个文件的历史记录，如果没<filename>则表示整个branch的历史记录，加–color表示生成一个树状图，-p表示查看修改详情。</filename></filename></li>
<li>git fetch会同步git库和本地库的版本信息，而不会真正下载代码。</li>
<li>git checkout version_number /path/to/file 将某个文件切换到指定的版本。</li>
<li>git stash用于将当前修改缓存下来，方便切到其它分支工作；完成工作后切回来用git stash pop。</li>
<li>git 回滚远程代码库</li>
</ul>
<blockquote>
<p><strong>步骤一</strong>：本地先回滚到正确的版本。用git reset –hard version_number version_number可以是commit号或reflog编号。</p>
</blockquote>
<blockquote>
<p><strong>步骤二</strong>：将本地版本强制推送到远端，覆盖远程版本。用git push origin master -f</p>
</blockquote>
<blockquote>
<p><strong>步骤三</strong>：将线上服务器同步到git代码库。直接用git pull origin master是不行的，因为这时候往往线上服务器比代码库更新。所以需要执行下面的命令来强制同步：<br></p>
<ol>
<li>git fetch –all <br></li>
<li>git reset –hard origin/master <br><br>这样就同步好了。基本原理可以参考<a href="http://stackoverflow.com/questions/1125968/force-git-to-overwrite-local-files-on-pull。这样做比直接删代码风险要小一些。" target="_blank" rel="noopener">http://stackoverflow.com/questions/1125968/force-git-to-overwrite-local-files-on-pull。这样做比直接删代码风险要小一些。</a> </li>
</ol>
</blockquote>
<ul>
<li>git log -p –name-only 其中的–name-only是个非常好用的参数，可以用来只显示改动的文件，可以与其它很多命令搭配起来用。</li>
<li>git init –bare用于在server端新建一个repo，随后在本地代码文件夹下git init再git add remote对应的地址就可以将本地与server关联上了。</li>
<li>git checkout -b –orphan branchname 从当前分支产生一个无历史的新分支，可以用来分享代码。</li>
<li>git config –global push.default current 设置全局push默认的分支为当前分支，执行后可以通过git push来推送当前分支，而不需要显式写出分知名。</li>
<li>git reflog 查看本地的git命令执行历史。</li>
<li>git fetch 同步本地和远程的分支信息，尤其可以消除“Your branch is ahead of ‘origin/master’ by 1 commit.”这样的提醒。</li>
<li>git mv old_name new_name 用于重命名一个文件。免去rm+add的重复劳动。</li>
<li>git branch -a 查看远程分支。</li>
<li>git push origin –delete branch_name 根据分支名删除远程分支。</li>
<li>git push origin –delete tag tag_name 根据tag删除远程分支。</li>
<li>git checkout mybranch; git rebase origin 把自己的分支以patch的形式加到origin分支上，与pull或merge产生的效果类似，但“看起来“历史不同，参考<a href="http://gitbook.liuhui998.com/4_2.html。" target="_blank" rel="noopener">http://gitbook.liuhui998.com/4_2.html。</a></li>
</ul>

      
    </div>
    <footer class="entry-meta entry-footer">
      
	<span class="ico-folder"></span>
    <a class="article-category-link" href="/blog/categories/Tech/">Tech</a>

      
  <span class="ico-tags"></span>
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/blog/tags/git/">git</a></li></ul>

      
    </footer>
    <hr class="entry-footer-hr">
  </div>
  
</article>

<!-- Table of Contents -->

  
    <article id="post-mysql-deployment"  class="article article-type-post" itemscope itemprop="blogPost" >
  <div id="articleInner" class="clearfix post-1016 post type-post status-publish format-standard has-post-thumbnail hentry category-template-2 category-uncategorized tag-codex tag-edge-case tag-featured-image tag-image tag-template">
    
    
      <header class="article-header">
        
  
    <h1 class="thumb" itemprop="name">
      <a class="article-title" href="/blog/mysql-deployment/">MySQL安装部署</a>
    </h1>
  

      </header>
    
    <div class="article-meta">
      
	<a href="/blog/mysql-deployment/" class="article-date">
	  <time datetime="2015-10-14T23:52:21.000Z" itemprop="datePublished">October 15, 2015</time>
	</a>

      
	<span class="ico-folder"></span>
    <a class="article-category-link" href="/blog/categories/Tech/">Tech</a>
 
      
    </div>
    <div class="article-entry" itemprop="articleBody">
      
        <p>参考<a href="http://dev.mysql.com/doc/refman/5.6/en/installing-source-distribution.html。" target="_blank" rel="noopener">http://dev.mysql.com/doc/refman/5.6/en/installing-source-distribution.html。</a></p>
<ul>
<li>安装前配置<pre class="lang:default decode:true ">
groupadd mysql
useradd -r -g mysql mysql
yum install cmake
</pre></li>
<li>安装<br><pre class="lang:default decode:true "><br>tar zxvf mysql-VERSION.tar.gz<br>cd mysql-VERSION<br>cmake .<br>make<br>make install<br></pre><!--break--></li>
<li>安装后配置</li>
</ul>
<pre class="lang:default decode:true ">cd /usr/local/mysql
chown -R mysql .
chgrp -R mysql .
# df -ha 用于查看各个分区的使用率，在处理之前确保有足够存储空间
bin/mysql_install_db --datadir=/var/lib/mysql --user=mysql
chown -R root .
chown -R mysql data
bin/mysqld_safe --user=mysql &amp;
mysqladmin -u root -h host_name password newpassword
# 启动服务
/usr/local/mysql/bin/mysqld_safe --user=mysql &;
# my.cnf在/etc目录下</pre> 


<ul>
<li>设置用户<br><pre class="lang:default decode:true "><br>#创建一个新用户，host可以用%替换，表示从任意ip地址登陆<br>CREATE USER ‘username‘@’host’ IDENTIFIED BY ‘password’;</pre></li>
</ul>
<p>#查看用户信息<br>SELECT user, host, password FROM user WHERE user=’username’;</p>
<p>#分配权限，primitive包括select, insert, update, delete, create, drop, index, alter, grant, reference, reload, shutdown, process, file共14个权限<br>GRANT primitive1, primitive2, …, primitiven ON db.table TO username@host IDENTIFIED BY password</p>
<p>#删除用户<br>DROP USER username;</p>
<p>#取消用户授权<br>REVOKE primitive ON db.table FROM username@host;<br></p>
<ul>
<li>备份<br>下面的命令里都省略了-u和-p，在实际操作时须补全。<br><strong>关于bin log的部分，文档《binlog基本认识》有非常详尽的介绍。</strong><br><pre class="lang:default decode:true "><h1><span id="开启binlog">开启binlog</span></h1>编辑my.cnf文件，在[mysqld]区块中加入log-bin=mysql-bin，重启服务即生效<br>执行show variables like ‘log_%’;来确认已经打开bin log</pre></li>
</ul>
<h1><span id="常用的bin-log操作">常用的bin log操作</span></h1><p>show master logs; # 查看所有bin log日志列表<br>show master status; # 查看最新一个bin log日志编号名称，以及最后一个操作事件结束点<br>flush logs; # 刷新日志，产生一个新的bin log日志文件<br>reset master; # 清空所有bin log日志</p>
<h1><span id="查看bin-log">查看bin log</span></h1><p>mysqlbinlog mysql-bin.000013 #打开一个bin log文件<br>show binlog events [IN log_name] [FROM pos] [LIMIT [offset,] row_count]<br>例如指定查询 mysql-bin.000021 这个文件，从pos点:8224开始查起，偏移2行，查询10条<br>    show binlog events in ‘mysql-bin.000021’ from 8224 limit 2,10\G;</p>
<h1><span id="利用bin-log恢复数据">利用bin log恢复数据</span></h1><p>mysqlbinlog mysql-bin.0000xx | mysql </p>
<h1><span id="备份整个数据库备份前需要获取全局读锁因此必须在traffic较低的时候进行">备份整个数据库，备份前需要获取全局读锁，因此必须在traffic较低的时候进行</span></h1><p>mysqldump –single-transaction –all-databases &gt; backup_yy_mm_dd_hh_mm_ss.sql<br>mysql &lt; backup_yy_mm_dd_hh_mm_ss.sql<br></p>
<ul>
<li>主从同步<br>  完整的说明在这里：<a href="http://dev.mysql.com/doc/refman/5.6/en/replication-howto.html。" target="_blank" rel="noopener">http://dev.mysql.com/doc/refman/5.6/en/replication-howto.html。</a><br>  另一篇文章是个不错的简化版，并且更加实用“<a href="http://plusbryan.com/mysql-replication-without-downtime" target="_blank" rel="noopener">Setting up MySQL replication without the downtime</a>”。</li>
</ul>
<pre class="lang:default decode:true ">
    ## 设置主服务器
    # 确保master已经通过log-bin来开启bin log
    # 确保每个host对应的server-id是不同的
        [mysqld]
        log-bin=mysql-bin
        server-id=1
        innodb_flush_log_at_trx_commit=1
        sync_binlog=1
    # 为slave创建专门的用户名
    create user 'repl'@'%.mydomain.com' identified by 'slavepass';
    grant replication slave on *.* to 'repl'@'%.mydomain.com';

    ## 设置从服务器
    # 确保slave的server-id与其它服务器不同
        [mysqld]
        server-id=2

    ## 获取master的同步位置
    # 执行flush操作，开启一个client session，执行下面语句后保持不退出
    flush tables with read lock;
    # 在另一个client session执行，记录File、Position对应的值
    show master status;
    +------------------+----------+--------------+------------------+
    | File             | Position | Binlog_Do_DB | Binlog_Ignore_DB |
    +------------------+----------+--------------+------------------+
    | mysql-bin.000003 | 73       | test         | manual,mysql     |
    +------------------+----------+--------------+------------------+
    # 回到锁住的session执行
    unlock tables;

    ## 创建master的镜像
    mysqldump --all-database --master-data > dbdump.db
    # 如果需要选择性同步，需要在slave上配置--replicate-ignore-db=db_name来完成，详细使用方法参考官方文档

    ## 在slave导入镜像
    #带--skip-slave-start选项启动slave上的mysql
    #导入dump文件
    mysql < dbdump.db
    #在slave执行change master to指令
    CHANGE MASTER TO
         MASTER_HOST='master_host_name',
         MASTER_USER='replication_user_name',
         MASTER_PASSWORD='replication_password',
         MASTER_LOG_FILE='recorded_log_file_name',
         MASTER_LOG_POS=recorded_log_position;
    start slave;
</pre>

<ul>
<li>配置实例<br>  <strong>注意：配置MySQL的目的不是有什么秘诀，关键在于根据系统本身的配置高低和处理的业务类型来调整各种资源配置</strong><ul>
<li>这里有根据不同业务量级给出的实例，<a href="https://github.com/onddo/mysql_tuning-cookbook。" target="_blank" rel="noopener">https://github.com/onddo/mysql_tuning-cookbook。</a></li>
<li>可以从这里出发，按照步骤来配置<a href="https://tools.percona.com/wizard" target="_blank" rel="noopener">https://tools.percona.com/wizard</a></li>
<li>执行一下这个工具来获得优化建议<a href="https://github.com/major/MySQLTuner-perl" target="_blank" rel="noopener">https://github.com/major/MySQLTuner-perl</a></li>
</ul>
</li>
</ul>

      
    </div>
    <footer class="entry-meta entry-footer">
      
	<span class="ico-folder"></span>
    <a class="article-category-link" href="/blog/categories/Tech/">Tech</a>

      
  <span class="ico-tags"></span>
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/blog/tags/mysql/">mysql</a></li></ul>

      
    </footer>
    <hr class="entry-footer-hr">
  </div>
  
</article>

<!-- Table of Contents -->

  
    <article id="post-php-deployment"  class="article article-type-post" itemscope itemprop="blogPost" >
  <div id="articleInner" class="clearfix post-1016 post type-post status-publish format-standard has-post-thumbnail hentry category-template-2 category-uncategorized tag-codex tag-edge-case tag-featured-image tag-image tag-template">
    
    
      <header class="article-header">
        
  
    <h1 class="thumb" itemprop="name">
      <a class="article-title" href="/blog/php-deployment/">Nginx+PHP安装部署</a>
    </h1>
  

      </header>
    
    <div class="article-meta">
      
	<a href="/blog/php-deployment/" class="article-date">
	  <time datetime="2015-10-13T23:52:21.000Z" itemprop="datePublished">October 14, 2015</time>
	</a>

      
	<span class="ico-folder"></span>
    <a class="article-category-link" href="/blog/categories/Tech/">Tech</a>
 
      
    </div>
    <div class="article-entry" itemprop="articleBody">
      
        <p>这里记录安装部署Nginx+PHP相关的一些东西。<br><!--break--></p>
<h2><span id="环境依赖">环境+依赖</span></h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"># 基本编译环境</span><br><span class="line">yum -y install gcc automake autoconf libtool make gcc-c++ glibc</span><br><span class="line"># PHP依赖</span><br><span class="line">yum -y install libmcrypt-devel mhash-devel libxslt-devel libjpeg \</span><br><span class="line">libjpeg-devel libpng libpng-devel freetype freetype-devel libxml2 \</span><br><span class="line">libxml2-devel zlib zlib-devel glibc glibc-devel glib2 glib2-devel \</span><br><span class="line">bzip2 bzip2-devel ncurses ncurses-devel curl curl-devel e2fsprogs \</span><br><span class="line">e2fsprogs-devel krb5 krb5-devel libidn libidn-devel openssl openssl-devel</span><br><span class="line"># 安装pcre:</span><br><span class="line">cd /usr/local/src</span><br><span class="line">wget ftp://ftp.csx.cam.ac.uk/pub/software/programming/pcre/pcre-xx.xx.tar.gz </span><br><span class="line">tar -zxvf pcre-xx.xx.tar.gz</span><br><span class="line">cd pcre-xx.xx</span><br><span class="line">./configure</span><br><span class="line">make</span><br><span class="line">make install</span><br><span class="line"># 安装zlib:</span><br><span class="line">cd /usr/local/src</span><br><span class="line">wget http://zlib.net/zlib-x.x.x.tar.gz</span><br><span class="line">tar -zxvf zlib-x.x.x.tar.gz</span><br><span class="line">cd zlib-x.x.x</span><br><span class="line">./configure</span><br><span class="line">make</span><br><span class="line">make install</span><br><span class="line"># 安装ssl:</span><br><span class="line">cd /usr/local/src</span><br><span class="line">wget http://www.openssl.org/source/openssl-x.x.x.tar.gz</span><br><span class="line">tar -zxvf openssl-x.x.x.tar.gz</span><br></pre></td></tr></table></figure>
<h2><span id="安装php">安装PHP</span></h2><h3><span id="安装">安装</span></h3><p>这里可能遇到各种缺少依赖的错误，遇到什么就安装什么就行，可以参考文章“20+ common PHP compilation errors and fix”。这里的配置项比较多，也很难对每一项都非常了解，所以其实可以设置少一些选项，然后等真的需要的时候再重新编译。这其实非常容易，重新安装一遍后重启php-fpm就可以了</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line">wget http://cn2.php.net/distributions/php-xx.xx.xx.tar.gz</span><br><span class="line">tar zvxf php-xx.xx.xx.tar.gz</span><br><span class="line">cd php-xx.xx.xx.tar.gz</span><br><span class="line">./configure </span><br><span class="line">--prefix=/usr/local/php  \</span><br><span class="line">--enable-fpm \</span><br><span class="line">--with-fpm-user=www-data \</span><br><span class="line">--with-fpm-group=www-data \</span><br><span class="line">--with-mcrypt \</span><br><span class="line">--enable-mbstring \ </span><br><span class="line">--disable-pdo \</span><br><span class="line">--with-curl \</span><br><span class="line">--disable-debug \</span><br><span class="line">--disable-rpath \</span><br><span class="line">--enable-inline-optimization \</span><br><span class="line">--with-bz2 \</span><br><span class="line">--with-zlib \</span><br><span class="line">--enable-sockets \</span><br><span class="line">--enable-sysvsem \</span><br><span class="line">--enable-sysvshm \</span><br><span class="line">--enable-sysvmsg \</span><br><span class="line">--enable-pcntl \</span><br><span class="line">--enable-mbregex \ </span><br><span class="line">--with-mhash \</span><br><span class="line">--enable-zip \</span><br><span class="line">--with-pcre-regex \</span><br><span class="line">--with-mysql \</span><br><span class="line">--with-mysqli \</span><br><span class="line">--with-gd \</span><br><span class="line">--with-jpeg-dir \</span><br><span class="line">--with-openssl \</span><br><span class="line">--enable-pdo \</span><br><span class="line">--with-pdo-mysql \</span><br><span class="line">--with-mysql-sock=/var/lib/mysql/mysql.sock \</span><br><span class="line">--with-config-file-path=/usr/local/php/etc</span><br><span class="line"></span><br><span class="line">make all install </span><br><span class="line"># 把php.ini放到指定的位置</span><br><span class="line">cp php.ini-development（根据需要换成其它） /usr/local/php/etc/php.ini</span><br><span class="line"># 配置php.ini中的timezone参数为Asia/Shanghai</span><br></pre></td></tr></table></figure>
<h3><span id="配置">配置</span></h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">cd /usr/local/php</span><br><span class="line">cp etc/php-fpm.conf.defautl etc/php-fpm.conf</span><br><span class="line">vi etc/php-fpm.conf</span><br><span class="line"># 修改</span><br><span class="line">user = www-data</span><br><span class="line">group = www-data</span><br><span class="line"># 如果www-data用户不存在则添加www-data用户：</span><br><span class="line">groupadd www-data &amp;&amp; useradd -g www-data www-data</span><br><span class="line"># 添加php到环境变量</span><br><span class="line">vi /etc/profile</span><br><span class="line"># 在底部增加一行export PATH=/usr/local/php/bin:$PATH</span><br><span class="line">source /etc/profile</span><br><span class="line"># 检查php cli配置文件</span><br><span class="line">php --ini 若输出路径与--with-config-file-path对应的路径不同，需要建一个软链</span><br></pre></td></tr></table></figure>
<h3><span id="启动重启">启动/重启</span></h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">#启动：/usr/local/php/sbin/php-fpm</span><br><span class="line">#关闭：kill -INT pid</span><br><span class="line">#重启：kill -USR2 pid</span><br></pre></td></tr></table></figure>
<h3><span id="phpini的问题">php.ini的问题</span></h3><p>偶然发现一个问题，phpinfo()里输出的配置文件路径与php –ini的路径不同。而实际上在编译PHP的时候明确设定了–with-config-file-path参数，设置与phpinfo()输出相同，与php –ini不同。这与<a href="http://php.net/manual/en/configuration.file.php" target="_blank" rel="noopener">文档</a>中描述的有点不一致。</p>
<p>搜索了一把，发现phpinfo()实际对应php/bin/php-cgi，而运行php –ini的时候对应的是php/bin/php，因而两者调用的实际上是不同的可执行文件。只能理解，在我使用的版本里，cli对应的php.ini与cgi的不同。解决方法最简单的则是在php –ini里显示的配置文件路径上放一个php.ini软链，这就好了。</p>
<h3><span id="composer的应用">Composer的应用</span></h3><p>Composer对于框架的各个组件来说，就好像Container对于各种类一样。如果用一句话来概括Composer的作用，那应该是：</p>
<blockquote>
<p>Composer is a tool for dependency management in PHP. </p>
</blockquote>
<p>从实际应用的角度，Composer的作用体现在两个方面：</p>
<ol>
<li>安装和维护项目依赖的第三方库</li>
<li>支持项目内部autoload</li>
</ol>
<h4><span id="用composer安装第三方库">用Composer安装第三方库</span></h4><p>在Composer的支持下，安装和使用第三方库非常方便。大概步骤包括（1）更改composer.json；（2）执行composer install下载和安装库；（3）在项目的入口中引用vendor目录下的autoload.php。一个最简单的composer.json看起来是这样的：</p>
<p><pre class="lang:default decode:true ">{<br>    “require”: {<br>        “monolog/monolog”: “1.0.*”<br>    }<br>}</pre><br>它定义了项目依赖的第三方库。</p>
<h4><span id="用composer支持autoload">用Composer支持autoload</span></h4><p>虽然autoload.php位于vendor目录下，但它实际上也支持项目自身的autoload。Composer支持4种autoload方式，分别是psr-0、psr-4、classmap和files。其中psr-0/psr-4属于按规则autoload，而classmap和files则属于按配置autoload。所谓“按规则”是指：只要文件命名、文件路径、类命名符合一定规则，autoloader就能根据类的命名空间和类名加载对应的文件。先举个psr-4的例子：</p>
<p><pre class="lang:default decode:true "><br>$obj = new App\MyLib\TestComposer();<br></pre><br>假设composer.json像下面这样：</p>
<p><pre class="lang:default decode:true "><br>{<br>    “autoload”: {<br>        “psr-4”: {<br>            “App\“: “src/“,<br>        }<br>    }<br>}<br></pre><br>那么对应的文件将是src/MyLib/TestComposer.php里的TestComposer类。如果上面的规则是psr-0，那么对应的文件则是src/App/MyLib/TestComposer.php。可以看到两者的差别其实很小，psr-4里是把左边（App\）替换成右边（src/）。psr-0则是把左边连接到右边后面。因此，psr-4的一个主要目的是简化项目的目录结构。</p>
<p>另外两种方式classmap和files比较容易理解，如下面的例子：</p>
<p><pre class="lang:default decode:true "><br>{<br>    “autoload”: {<br>        “classmap”: [“src/MyLib/“, “TestComposer.php”],<br>        “files”: [“src/MyLib/functions.php”]<br>    }<br>}<br></pre><br>classmap针对文件里定义的class，可以配置整个目录或某个文件。files则用于加载非class的内容，例如函数实现。</p>
<p>最后，增加了新的文件或修改了composer.json还需要执行</p>
<p><pre class="lang:default decode:true "><br>composer dump-autoload<br></pre><br>来重新生成autoload逻辑。对于psr-0/psr-4的还可以加-o来优化autoload速度。</p>
<h2><span id="安装nginx">安装Nginx</span></h2><h3><span id="安装">安装</span></h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">cd /usr/local/src</span><br><span class="line">wget http://nginx.org/download/nginx-x.x.x.tar.gz</span><br><span class="line">tar -zxvf nginx-x.x.x.tar.gz</span><br><span class="line">cd nginx-x.x.x</span><br><span class="line">./configure --sbin-path=/usr/local/nginx/nginx \</span><br><span class="line">--conf-path=/usr/local/nginx/nginx.conf \</span><br><span class="line">--pid-path=/usr/local/nginx/nginx.pid --with-http_ssl_module \</span><br><span class="line">--with-pcre=/usr/local/src/pcre-xx.xx --with-zlib=/usr/local/src/zlib-x.x.x \</span><br><span class="line">--with-openssl=/usr/local/src/openssl-x.x.x</span><br><span class="line">make</span><br><span class="line">make install</span><br></pre></td></tr></table></figure>
<h3><span id="启动">启动</span></h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo /usr/local/nginx/nginx</span><br></pre></td></tr></table></figure>
<h3><span id="配置实例">配置实例</span></h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br></pre></td><td class="code"><pre><span class="line">user  www-data;</span><br><span class="line">worker_processes  1;</span><br><span class="line">pid        logs/nginx.pid;</span><br><span class="line"></span><br><span class="line">events &#123;</span><br><span class="line">    worker_connections  1024;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">http &#123;</span><br><span class="line">    include       mime.types;</span><br><span class="line">    default_type  application/octet-stream;</span><br><span class="line"></span><br><span class="line">    log_format  main  &apos;$remote_addr - $remote_user [$time_local] &quot;$request&quot; &apos;</span><br><span class="line">                      &apos;$status $body_bytes_sent &quot;$http_referer&quot; &apos;</span><br><span class="line">                      &apos;&quot;$http_user_agent&quot; &quot;$http_x_forwarded_for&quot; &quot;$request_time&quot;&apos;;</span><br><span class="line">    #[important] need to specify the index</span><br><span class="line">    index  index.php index.html index.htm;</span><br><span class="line"></span><br><span class="line">    access_log  logs/access.log  main;</span><br><span class="line">    error_log  logs/error.log;</span><br><span class="line"></span><br><span class="line">    sendfile        on;</span><br><span class="line">    tcp_nopush     on;</span><br><span class="line">    keepalive_timeout  65;</span><br><span class="line"></span><br><span class="line">    #若有多个server，建议分为多个文件，每个包含一个server模块，用include包含</span><br><span class="line">    server &#123;</span><br><span class="line">        listen       80;</span><br><span class="line">        server_name  example.com;</span><br><span class="line"></span><br><span class="line">        #access_log  logs/host.access.log  main;</span><br><span class="line"></span><br><span class="line">        #[important] need to make sure each subpath in the root have +x permission</span><br><span class="line">        root   /home/work/laravel/public;</span><br><span class="line"></span><br><span class="line">        #[important] need to do the rewrite here</span><br><span class="line">        location / &#123;</span><br><span class="line">            try_files  $uri $uri/ /index.php?$query_string;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        #error_page  404              /404.html;</span><br><span class="line"></span><br><span class="line">        # redirect server error pages to the static page /50x.html</span><br><span class="line">        #</span><br><span class="line">        error_page   500 502 503 504  /50x.html;</span><br><span class="line">            location = /50x.html &#123;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        # pass the PHP scripts to FastCGI server listening on 127.0.0.1:9000</span><br><span class="line">        #</span><br><span class="line">        #[important] need to have the * below</span><br><span class="line">        location ~* \.php$ &#123;</span><br><span class="line">            fastcgi_pass   127.0.0.1:9000;</span><br><span class="line">            fastcgi_index  index.php;</span><br><span class="line">            fastcgi_param  SCRIPT_FILENAME  $document_root$fastcgi_script_name;</span><br><span class="line">            include        fastcgi_params;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        # deny access to .htaccess files, if Apache&apos;s document root</span><br><span class="line">        # concurs with nginx&apos;s one</span><br><span class="line">        #</span><br><span class="line">        location ~ /\.ht &#123;</span><br><span class="line">            deny  all;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3><span id="维护">维护</span></h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"># 把下面的命令放在脚本里用于备份配置文件</span><br><span class="line">cp /etc/nginx/nginx.conf /etc/nginx/nginx.conf.$(date &quot;+%b_%d_%Y_%H.%M.%S&quot;)</span><br><span class="line">#重新加载conf：</span><br><span class="line">#测试：sudo /usr/local/nginx/nginx -t</span><br><span class="line">#重载：sudo /usr/local/nginx/nginx -s reload</span><br></pre></td></tr></table></figure>
      
    </div>
    <footer class="entry-meta entry-footer">
      
	<span class="ico-folder"></span>
    <a class="article-category-link" href="/blog/categories/Tech/">Tech</a>

      
  <span class="ico-tags"></span>
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/blog/tags/nginx/">nginx</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/blog/tags/php/">php</a></li></ul>

      
    </footer>
    <hr class="entry-footer-hr">
  </div>
  
</article>

<!-- Table of Contents -->

  
    <article id="post-imu"  class="article article-type-post" itemscope itemprop="blogPost" >
  <div id="articleInner" class="clearfix post-1016 post type-post status-publish format-standard has-post-thumbnail hentry category-template-2 category-uncategorized tag-codex tag-edge-case tag-featured-image tag-image tag-template">
    
    
      <header class="article-header">
        
  
    <h1 class="thumb" itemprop="name">
      <a class="article-title" href="/blog/imu/">基于惯性传感器的姿态恢复</a>
    </h1>
  

      </header>
    
    <div class="article-meta">
      
	<a href="/blog/imu/" class="article-date">
	  <time datetime="2015-09-22T23:52:21.000Z" itemprop="datePublished">September 23, 2015</time>
	</a>

      
	<span class="ico-folder"></span>
    <a class="article-category-link" href="/blog/categories/Tech/">Tech</a>
 
      
    </div>
    <div class="article-entry" itemprop="articleBody">
      
        <p>一个物体在空间中的存在可以从两个维度描述：一方面是在什么位置，这可以由其所在坐标$${x,y,z}$$来描述；另一方面是处于什么姿态（orientation)，例如它是倾斜的还是正的。要知道一个物体在空间的位置是困难的，需要借助外在测量系统，例如GPS利用24颗卫星定位一个物体在地球上的经纬度和海拔。即便有GPS，要知道物体在室内的位置还是不行，需要相应的室内定位技术。扯远了，室内定位以后再说。要知道一个物体的姿态，相对容易一些，这可以借助惯性传感器（inertial sensor）。<br><!--break--></p>
<p>惯性传感器通常指代下面三个具体的传感器：</p>
<ul>
<li>加速度计（accelerometer）：测量三轴加速度，单位$$m/s^2$$；</li>
<li>陀螺仪 （gyroscope）：测量绕三轴旋转的角速度，单位是$$degree/s$$；</li>
<li>磁力计（magnetometer）：测量三轴磁力的大小，单位是$$tesla$$；</li>
</ul>
<p>惯性传感器的应用非常广泛，几乎遍及所有的智能硬件设备（如手机、手环等）。它能用于姿势识别，如apple watch自动识别用户是否正在看表；zepp捕捉网球、棒球姿势辅助训练；手环识别走路、跑步、骑车等等。这些看似神奇的应用都基于惯性传感器，以后有机会再深入讨论这些算法。</p>
<p>怎么才能测量一个物体的姿态呢？首先我们必须假定该物体与惯性传感器之间是刚体连接的，这样通过读取惯性传感器的值就能推测物体的姿态。加速度计可以用来测量物体的倾斜。如果物体处于静止状态，因为我们知道重力的方向总是向下的，这是非常容易做到的。如果物体静止，测量到的加速度方向就是重力的方向。此外，陀螺仪也可以用来计算物体的姿态。假定已知物体的初始姿态，那么我们将物体沿三轴旋转的角速度积分，就知道物体的姿态了。</p>
<p><img src="/blog/assets/imu_sensor.png" alt="IMU sensor"></p>
<p>但实际情况比这复杂。物体可能处于运动状态，而陀螺仪读数有严重的漂移，使得姿态估计并不容易。现有的主流思路是结合加速度计和陀螺仪，根据两者的读数分别估算物体姿态，然后依据某种方法将两方面融合起来。其中的算法细节，没有比这篇文章讲得更清楚的了，感兴趣的话可以好好读一遍（<a href="http://blog.tkjelectronics.dk/2012/09/a-practical-approach-to-kalman-filter-and-how-to-implement-it/" target="_blank" rel="noopener">A practical approach to Kalman filter and how to implement it</a>），<a href="!--￼0--&gt;/assets/kalman.pdf">中文翻译</a>）。</p>
<p>Demo采用<a href="http://www.arduino.cc" target="_blank" rel="noopener">Arduino</a>和<a href="https://www.sparkfun.com/products/10724" target="_blank" rel="noopener">SparkFun 9Dof Sensor Stick</a>。连接和代码借鉴<a href="http://robotosh.blogspot.nl/2012/03/sparkfun-9dof-imu-sensor-stick.html" target="_blank" rel="noopener">这篇文章</a>，讲得比较详细，照着做一遍就行了，代码参考<a href="https://github.com/liqul/imu-demo/blob/master/arduino-9dof-sensor-stick.c" target="_blank" rel="noopener">这里</a>。在上面代码的accelerometer_norm和gyro_comp需要用到两个数组，需要在校准中获得。</p>
<p><img src="/blog/assets/arduino-spark.png" alt="arduino+spark"></p>
<p>传感器得到的原始读数无法直接使用。例如加速度计在水平静止时的读数可能是$$ x=0, y=0, z=-211$$，这里的211其实是g的大小，而我们需要把这个值与g对应起来。对应上面的代码，accelerometer_norm[2]就应该是211。同理，需要找到x轴、y轴与g的对应关系。将传感器的x轴、y轴与水平面垂直静止放置（即分别使x轴、y轴朝上），得到的读数分别对应accelerometer_norm[0]和accelerometer_norm[1]。陀螺仪的校准与加速度计不同。陀螺仪的问题在于即使处于静止状态，各个轴角速度一般都不为0，这是明显错误的。所以简单的做法是把传感器静止放置，记录陀螺仪各个轴角速度测量值，例如$$ x=5, y=30, z=-10$$，那么对应的gyro_comp[3] = {-5, -30, 10}。需要注意的是，这里的校准是非常粗糙的，也并不能完全消除误差，而实际的误差模型非常复杂，如果需要得到更加精确的测量结果还需要更加复杂的校准过程。</p>
<p>姿态恢复采用<a href="https://github.com/xioTechnologies/Open-Source-AHRS-With-x-IMU" target="_blank" rel="noopener">开源项目</a>。这个项目本来是针对xio自产的传感器设备，为了接入自己的设备需要做一些修改。只需要修改<a href="https://github.com/liqul/imu-demo/blob/master/main.cs" target="_blank" rel="noopener">program.cs</a>。</p>
<p>建议安装Arduino IDE则不需要安装额外的驱动了。</p>
<p>改变传感器的姿态可以从Visual Studio执行的项目中看到下面的画面：</p>
<p><img src="/blog/assets/imu-demo.png" alt="IMU sensor"></p>

      
    </div>
    <footer class="entry-meta entry-footer">
      
	<span class="ico-folder"></span>
    <a class="article-category-link" href="/blog/categories/Tech/">Tech</a>

      
  <span class="ico-tags"></span>
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/blog/tags/IMU/">IMU</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/blog/tags/accelerometer/">accelerometer</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/blog/tags/compass/">compass</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/blog/tags/gyroscope/">gyroscope</a></li></ul>

      
    </footer>
    <hr class="entry-footer-hr">
  </div>
  
</article>

<!-- Table of Contents -->

  
    <article id="post-rabbitmq-error1"  class="article article-type-post" itemscope itemprop="blogPost" >
  <div id="articleInner" class="clearfix post-1016 post type-post status-publish format-standard has-post-thumbnail hentry category-template-2 category-uncategorized tag-codex tag-edge-case tag-featured-image tag-image tag-template">
    
    
      <header class="article-header">
        
  
    <h1 class="thumb" itemprop="name">
      <a class="article-title" href="/blog/rabbitmq-error1/">RabbitMQ报错[ERROR: node with name &#39;rabbit&#39; already running on &#39;localhost&#39;]</a>
    </h1>
  

      </header>
    
    <div class="article-meta">
      
	<a href="/blog/rabbitmq-error1/" class="article-date">
	  <time datetime="2015-09-07T10:52:21.000Z" itemprop="datePublished">September 7, 2015</time>
	</a>

      
	<span class="ico-folder"></span>
    <a class="article-category-link" href="/blog/categories/Tech/">Tech</a>
 
      
    </div>
    <div class="article-entry" itemprop="articleBody">
      
        <p>这个报错是在执行./rabbitmq-server -detached的时候报出来的，除了这句以外没有任何信息。这个报错的本意是rabbit@localhost已经在运行了，不允许再启动一个实例。于是尝试干掉已有的进程：<br><!--break--></p>
<p><pre class="lang:default decode:true ">ps aux | grep rabbit</pre><br>执行后发现没有任何进程。尝试Google类似的问题，找了很久终于发现一个可能的<a href="http://stackoverflow.com/questions/8737754/node-with-name-rabbit-already-running-but-also-unable-to-connect-to-node" target="_blank" rel="noopener">问题</a>——/etc/hosts文件可能被改出问题了。</p>
<p>这要回到RabbitMQ的一个基本认识上，它是通过hostname来唯一确定本机的，甚至包括队列存储都与hostname直接对应，如果hostname被改了，意味着实例本身都变化了。于是执行</p>
<p><pre class="lang:default decode:true ">hostname -s</pre><br>发现居然没问题，还是localhost。所以，的确感觉非常奇怪。</p>
<p>进一步检查/etc/hosts文件，发现无意间把localhost指向了局域网内的另一台机器：</p>
<p><pre class="lang:default decode:true ">192.168.1.56 localhost</pre><br>于是终于找到原因了，RabbitMQ启动时检查localhost，发现上面已经启动了一个RabbitMQ实例，于是报了最前面的错误。只需要去掉hosts文件里的配置就好了。</p>
<p>上面说的是主要原因，另一个意外操作导致这个错误的原因是erlang的守护进程被其它用户启动了，这可以通过：</p>
<p><pre class="lang:default decode:true ">ps aux | grep epmd</pre><br>检查。需要干掉这个进程才能顺利把RabbitMQ启动起来。</p>

      
    </div>
    <footer class="entry-meta entry-footer">
      
	<span class="ico-folder"></span>
    <a class="article-category-link" href="/blog/categories/Tech/">Tech</a>

      
  <span class="ico-tags"></span>
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/blog/tags/rabbitmq/">rabbitmq</a></li></ul>

      
    </footer>
    <hr class="entry-footer-hr">
  </div>
  
</article>

<!-- Table of Contents -->

  
    <article id="post-dependency-injection"  class="article article-type-post" itemscope itemprop="blogPost" >
  <div id="articleInner" class="clearfix post-1016 post type-post status-publish format-standard has-post-thumbnail hentry category-template-2 category-uncategorized tag-codex tag-edge-case tag-featured-image tag-image tag-template">
    
    
      <header class="article-header">
        
  
    <h1 class="thumb" itemprop="name">
      <a class="article-title" href="/blog/dependency-injection/">Dependency Injection</a>
    </h1>
  

      </header>
    
    <div class="article-meta">
      
	<a href="/blog/dependency-injection/" class="article-date">
	  <time datetime="2015-08-17T23:52:21.000Z" itemprop="datePublished">August 18, 2015</time>
	</a>

      
	<span class="ico-folder"></span>
    <a class="article-category-link" href="/blog/categories/Tech/">Tech</a>
 
      
    </div>
    <div class="article-entry" itemprop="articleBody">
      
        <p>面向对象的一条准则就是将类与类之间的依赖关系解耦，这并不是什么新概念。Dependency Injection（DI）的目的也是一样，引用《implementing laravel》的一句原文：</p>
<blockquote>
<p>Dependency Injection is the act of adding (injecting) any dependencies into a class, rather than instantiating them somewhere within the class code itself. </p>
</blockquote>
<p>举一个例子来区分这两种情况：</p>
<pre class="lang:php decode:true ">class NoDI 
{
    function __construct()
    {
        $this->inner_class = new InnerClass();
    }
}</pre> 

<p><pre class="lang:php decode:true ">class DI<br>{<br>    function __construct(SomeInterface $implementation)<br>    {<br>        $this-&gt;inner_class = $implementation;<br>    }<br>}</pre><br>上面前一种情况下，如果inner_class的实现发生变化，例如需要重写一个NewInnerClass()，那么需要在NoDI中修改这行代码。而后一种情况下，由于inner_class是从外部传入的，所以DI类本身不需要发生任何变化。</p>
<p>这个道理并不新颖，所以乍一眼看来这没有什么有意思的东西。如果无论什么情况都需要为类额外写一个interface，反倒是一种负担。另外，如果类之间的依赖关系比较复杂，使用起来也不方便，例如：类A依赖类B，类B又依赖类C，那么如果要获取一个A的对象，需要先得到B的对象，进一步递推到C的对象。</p>
<p>为了减少这种重复的实例化过程，Laravel提供了Container。实际上一个Laravel的APP对象本身就继承自Container。还是以A、B、C之间的依赖关系为例：</p>
<p><pre class="lang:php decode:true "><br>interface B_Interface {}<br>interface C_Interface {}</pre></p>
<p>class A {<br>    function __construct(B_Interface $b){}<br>}</p>
<p>class B implements B_Interface {<br>    function __construct(C_Interface $c){}<br>}</p>
<p>class C implements C_Interface {<br>    function __construct(){}<br>}<br><br>在没有Container的情况下，会像下面一样来实例化A对象：</p>
<p><pre class="lang:php decode:true "><br>$c = new C();<br>$b = new B($c);<br>$a = new A($b);<br></pre><br>试想我们每次获取A对象都需要写这样的3行代码。在面向对象的开发中，类之间的依赖关系是非常复杂的，这使得这样实例化变得不可行。这或许是许多人更加倾向于面向过程来开发（即使他们的代码里也充满了类定义）。</p>
<p>有了Container以后这样的情况得到了很大的改善。如下面所示：</p>
<p><pre class="lang:php decode:true "><br>APP::bind(‘B_Interface’, ‘B’);</pre></p>
<p>APP::bind(‘C_Interface’, function(){<br>    return new C();<br>});</p>
<p>$a = APP::make(‘A’);<br><br>在Laravel中，上面的代码会这样执行：</p>
<p><ol><br>    <li>尝试实例化类A，发现其依赖B_Interface</li><br>    <li>尝试找到实现B_Interface的类，发现已注册的B_Interface指向B类</li><br>    <li>尝试实例化类B，发现其依赖C_Interface</li><br>    <li>尝试找到实现C_Interface的类，发现已注册的C_Interface执行一个closure，返回一个C类对象</li><br>    <li>按照上面相反的顺序依次获得C、B、A对象</li><br></ol><br>Laravel自动完成上面这样的递归式实例化过程。在PHP中，只要利用反射就能做到这一点。也许有人会说，上面这样的代码岂止3行，比前面的实现更加麻烦了。但是，在真实的场景下，两个bind语句是由服务提供方来实现的，而且只要做一次，在全局都能使用。所以，其实只需要最后一句话就够了。</p>
<p>上面的例子里，生成实现B_Interface的类的时候用的是：</p>
<p><pre class="lang:php decode:true "><br>APP::bind(‘B_Interface’, ‘B’);<br></pre><br>但对于C_Interface，用的是closure。这样做是由于B依赖于C_Interface，如果也用closure的话就不方便写了。</p>
<p>Container在Laravel处于绝对核心地位。可以说所有类实例化都是经过Container来完成的，上面举的例子其实只是一种用法而已，在使用Laravel的过程中，由于Container的存在还有非常多技巧。</p>

      
    </div>
    <footer class="entry-meta entry-footer">
      
	<span class="ico-folder"></span>
    <a class="article-category-link" href="/blog/categories/Tech/">Tech</a>

      
  <span class="ico-tags"></span>
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/blog/tags/php/">php</a></li></ul>

      
    </footer>
    <hr class="entry-footer-hr">
  </div>
  
</article>

<!-- Table of Contents -->

  
    <article id="post-rabbitmq-load-balancing"  class="article article-type-post" itemscope itemprop="blogPost" >
  <div id="articleInner" class="clearfix post-1016 post type-post status-publish format-standard has-post-thumbnail hentry category-template-2 category-uncategorized tag-codex tag-edge-case tag-featured-image tag-image tag-template">
    
    
      <header class="article-header">
        
  
    <h1 class="thumb" itemprop="name">
      <a class="article-title" href="/blog/rabbitmq-load-balancing/">RabbitMQ负载均衡</a>
    </h1>
  

      </header>
    
    <div class="article-meta">
      
	<a href="/blog/rabbitmq-load-balancing/" class="article-date">
	  <time datetime="2015-08-15T10:52:21.000Z" itemprop="datePublished">August 15, 2015</time>
	</a>

      
	<span class="ico-folder"></span>
    <a class="article-category-link" href="/blog/categories/Tech/">Tech</a>
 
      
    </div>
    <div class="article-entry" itemprop="articleBody">
      
        <p>读RabbitMQ文档的时候奇怪为什么它不支持负载均衡。后来看过别人写的Haproxy+RabbitMQ实现负载均衡，觉得似乎这样做就完美了，直到读到这篇文章《<a href="http://insidethecpu.com/2014/11/17/load-balancing-a-rabbitmq-cluster/" target="_blank" rel="noopener">Load Balancing a RabbitMQ Cluster</a>》。<br><!--break--></p>
<p>这篇文章里介绍了RabbitMQ在队列备份时的一些细节：假设一个cluster里有两个实例，记作rabbitA和rabbitB。如果某个队列在rabbitA上创建，随后在rabbitB上镜像备份，那么rabbitA上的队列称为该队列的<strong>主队列</strong>（master queue），其它备份均为<strong>从队列</strong>。接下来，无论client访问rabbitA或rabbitB，最终消费的队列都是主队列。换句话说，即使在连接时主动连接rabbitB，RabbitMQ的cluster会自动把连接转向rabbitA。当且仅当rabbitA服务down掉以后，在剩余的从队列中再选举一个作为继任的主队列。</p>
<p>如果这种机制是真的，那么负载均衡就不能简单随机化连接就能做到了。需要满足下面的条件：</p>
<ol>
<li>队列本身的建立需要随机化，即将队列分布于各个服务器；</li>
<li>client访问需要知道每个队列的主队列保存在哪个服务器；</li>
<li>如果某个服务器down了，需要知道哪个从队列被选择成为继任的主队列。<br>于是，Load Balancing a RabbitMQ Cluster的作者给出了下图的结构。</li>
</ol>
<p><img src="/blog/assets/rabbitmq-cluster-with-monitor-service.png" alt="负载均衡架构"></p>
<p>这还是颇有点复杂的。首先，在建立一个新队列的时候，Randomiser会随机选择一个服务器，这样能够保证队列均匀分散在各个服务器（这里暂且不考虑负载）。建立队列后需要在Meta data里记录这个队列对应的服务器；另外，Monitor Service是关键，它用于处理某个服务器down掉的情况。一旦发生down机，它需要为之前主队列在该服务器的队列重新建立起与服务器的映射关系。</p>
<p>这里会遇到一个问题，即怎么判断某个队列的主队列呢？一个方法是通过rabbitmqctl，如下面的例子：</p>
<pre class="toolbar:2 lang:default decode:true ">./rabbitmqctl -p production list_queues pid slave_pids
registration-email-queue        &lt;rabbit@mq01.2.1076.0&gt;       [&lt;rabbit@mq00.1.285.0&gt;]
registration-sms-queue  &lt;rabbit@mq01.2.1067.0&gt;       [&lt;rabbit@mq00.1.281.0&gt;]</pre> 

<p>可以看到pid和slave_pids分别对应主队列所在的服务器和从服务器（可能有多个）。利用这个命令就可以了解每个队列所在的主服务器了。</p>

      
    </div>
    <footer class="entry-meta entry-footer">
      
	<span class="ico-folder"></span>
    <a class="article-category-link" href="/blog/categories/Tech/">Tech</a>

      
  <span class="ico-tags"></span>
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/blog/tags/rabbitmq/">rabbitmq</a></li></ul>

      
    </footer>
    <hr class="entry-footer-hr">
  </div>
  
</article>

<!-- Table of Contents -->

  


  <nav id="page-nav">
    
    <a class="extend prev" rel="prev" href="/blog/page/4/">Prev</a><a class="page-number" href="/blog/">1</a><span class="space">&hellip;</span><a class="page-number" href="/blog/page/3/">3</a><a class="page-number" href="/blog/page/4/">4</a><span class="page-number current">5</span><a class="page-number" href="/blog/page/6/">6</a><a class="extend next" rel="next" href="/blog/page/6/">Next</a>
  </nav>

</section>
          <aside id="sidebar">
  
    <div style="margin: 20px 0;">
	<div id="search-form-wrap">

    <form class="search-form">
        <label style="width: 72%;">
            <span class="screen-reader-text">Search for:</span>
            <input type="search" class="search-field" style="height: 36px; width: 100%;" placeholder=" Search…" value="" name="s" title="Search for:">
        </label>
        <input type="submit" class="search-form-submit" value="Search">
    </form>
    <div class="ins-search">
    <div class="ins-search-mask"></div>
    <div class="ins-search-container">
        <div class="ins-input-wrapper">
            <input type="text" class="ins-search-input" placeholder="Type something..."/>
            <span class="ins-close ins-selectable"><i class="fa fa-times-circle"></i></span>
        </div>
        <div class="ins-section-wrapper">
            <div class="ins-section-container"></div>
        </div>
    </div>
</div>
<script>
(function (window) {
    var INSIGHT_CONFIG = {
        TRANSLATION: {
            POSTS: 'Posts',
            PAGES: 'Pages',
            CATEGORIES: 'Categories',
            TAGS: 'Tags',
            UNTITLED: '(Untitled)',
        },
        ROOT_URL: '/blog/',
        CONTENT_URL: '/blog/content.json',
    };
    window.INSIGHT_CONFIG = INSIGHT_CONFIG;
})(window);
</script>
<script src="/blog/js/insight.js"></script>

</div>
</div>
  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Connect With Us</h3>
    <div class="widget widget_athemes_social_icons">

    	<ul class="clearfix widget-social-icons">   
    	
   			<li><a href="https://www.linkedin.com/in/liqunli/" title="Linkedin"><i class="fa fa-linkedin" aria-hidden="true"></i></a></li> 

   		
   			<li><a href="https://scholar.google.com/citations?user=icgetesAAAAJ&amp;hl=en" title="Google Scholar"><i class="fa fa-google scholar" aria-hidden="true"></i></a></li> 

   		
   			<li><a href="https://500px.com/liqul" title="500Px"><i class="fa fa-500px" aria-hidden="true"></i></a></li> 

   		
   		</ul>


   		<!--
   		<ul class="clearfix widget-social-icons">   		
   		<li class="widget-si-twitter"><a href="http://twitter.com" title="Twitter"><i class="ico-twitter"></i></a></li> 
		<li class="widget-si-facebook"><a href="http://facebook.com" title="Facebook"><i class="ico-facebook"></i></a></li>
			<li class="widget-si-gplus"><a href="http://plus.google.com" title="Google+"><i class="ico-gplus"></i></a></li>
			<li class="widget-si-pinterest"><a href="http://pinterest.com" title="Pinterest"><i class="ico-pinterest"></i></a></li>
			<li class="widget-si-flickr"><a href="http://flickr.com" title="Flickr"><i class="ico-flickr"></i></a></li>
			<li class="widget-si-instagram"><a href="http://instagram.com" title="Instagram"><i class="ico-instagram"></i></a></li>
		</ul> -->

    </div>
  </div>


  
    
  <div class="widget_athemes_tabs">
    <ul id="widget-tab" class="clearfix widget-tab-nav">
      <li class="active"><a>Recent Posts</a></li>
    </ul>
    <div class="widget">
      <ul>
        
          <li class="clearfix">

            
              <div class="widget-entry-summary" style="margin: 0;">
            

              <h6 style="margin: 0;"><a href="/blog/currency-depreciation/">金融概念整理——货币贬值</a></h6>
              <span>March 8, 2019</span>
            </div>

          </li>
        
          <li class="clearfix">

            
              <div class="widget-entry-summary" style="margin: 0;">
            

              <h6 style="margin: 0;"><a href="/blog/linux-delete-file/">Linux下文件删除的规则</a></h6>
              <span>March 8, 2019</span>
            </div>

          </li>
        
          <li class="clearfix">

            
              <div class="widget-entry-summary" style="margin: 0;">
            

              <h6 style="margin: 0;"><a href="/blog/housing-price-as-indicator/">金融概念整理——房价指标</a></h6>
              <span>March 7, 2019</span>
            </div>

          </li>
        
          <li class="clearfix">

            
              <div class="widget-entry-summary" style="margin: 0;">
            

              <h6 style="margin: 0;"><a href="/blog/credit-spread/">金融概念整理——信用利差（credit spread）</a></h6>
              <span>March 6, 2019</span>
            </div>

          </li>
        
          <li class="clearfix">

            
              <div class="widget-entry-summary" style="margin: 0;">
            

              <h6 style="margin: 0;"><a href="/blog/news/">新闻纪录</a></h6>
              <span>January 3, 2019</span>
            </div>

          </li>
        
          <li class="clearfix">

            
              <div class="widget-entry-summary" style="margin: 0;">
            

              <h6 style="margin: 0;"><a href="/blog/etcd_raft_4/">Raft协议实现学习之—写入过程</a></h6>
              <span>November 23, 2018</span>
            </div>

          </li>
        
      </ul>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Categories</h3>
    <div class="widget">
      <ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/blog/categories/Book-Reading/">Book Reading</a><span class="category-list-count">3</span></li><li class="category-list-item"><a class="category-list-link" href="/blog/categories/Finance/">Finance</a><span class="category-list-count">4</span></li><li class="category-list-item"><a class="category-list-link" href="/blog/categories/Photography/">Photography</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/blog/categories/Reading/">Reading</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/blog/categories/Tech/">Tech</a><span class="category-list-count">39</span></li><li class="category-list-item"><a class="category-list-link" href="/blog/categories/Thinking/">Thinking</a><span class="category-list-count">3</span></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Tag Cloud</h3>
    <div class="widget tagcloud">
      <a href="/blog/tags/AI/" style="font-size: 10px;">AI</a> <a href="/blog/tags/Consensus/" style="font-size: 10px;">Consensus</a> <a href="/blog/tags/Copycat/" style="font-size: 10px;">Copycat</a> <a href="/blog/tags/Deadlock/" style="font-size: 10px;">Deadlock</a> <a href="/blog/tags/Finance/" style="font-size: 10px;">Finance</a> <a href="/blog/tags/HBase/" style="font-size: 10px;">HBase</a> <a href="/blog/tags/Housing/" style="font-size: 10px;">Housing</a> <a href="/blog/tags/IMU/" style="font-size: 10px;">IMU</a> <a href="/blog/tags/Learning/" style="font-size: 10px;">Learning</a> <a href="/blog/tags/Linux/" style="font-size: 10px;">Linux</a> <a href="/blog/tags/MVCC/" style="font-size: 10px;">MVCC</a> <a href="/blog/tags/Mapreduce/" style="font-size: 10px;">Mapreduce</a> <a href="/blog/tags/Mysql/" style="font-size: 10px;">Mysql</a> <a href="/blog/tags/OOM/" style="font-size: 10px;">OOM</a> <a href="/blog/tags/Raft/" style="font-size: 18px;">Raft</a> <a href="/blog/tags/Uniqueness/" style="font-size: 10px;">Uniqueness</a> <a href="/blog/tags/accelerometer/" style="font-size: 10px;">accelerometer</a> <a href="/blog/tags/admission-control/" style="font-size: 10px;">admission control</a> <a href="/blog/tags/amazon-aurora/" style="font-size: 10px;">amazon aurora</a> <a href="/blog/tags/big-data/" style="font-size: 20px;">big data</a> <a href="/blog/tags/compaction/" style="font-size: 10px;">compaction</a> <a href="/blog/tags/compass/" style="font-size: 10px;">compass</a> <a href="/blog/tags/consistency/" style="font-size: 12px;">consistency</a> <a href="/blog/tags/credit-spread/" style="font-size: 10px;">credit spread</a> <a href="/blog/tags/currency/" style="font-size: 10px;">currency</a> <a href="/blog/tags/distributed/" style="font-size: 12px;">distributed</a> <a href="/blog/tags/elasticsearch/" style="font-size: 10px;">elasticsearch</a> <a href="/blog/tags/flink/" style="font-size: 10px;">flink</a> <a href="/blog/tags/git/" style="font-size: 12px;">git</a> <a href="/blog/tags/gyroscope/" style="font-size: 10px;">gyroscope</a> <a href="/blog/tags/hbase/" style="font-size: 10px;">hbase</a> <a href="/blog/tags/investment/" style="font-size: 12px;">investment</a> <a href="/blog/tags/links/" style="font-size: 10px;">links</a> <a href="/blog/tags/lock/" style="font-size: 14px;">lock</a> <a href="/blog/tags/mapreduce/" style="font-size: 12px;">mapreduce</a> <a href="/blog/tags/mysql/" style="font-size: 10px;">mysql</a> <a href="/blog/tags/nginx/" style="font-size: 10px;">nginx</a> <a href="/blog/tags/non-blocking/" style="font-size: 10px;">non-blocking</a> <a href="/blog/tags/octave/" style="font-size: 10px;">octave</a> <a href="/blog/tags/openstack/" style="font-size: 10px;">openstack</a> <a href="/blog/tags/photography/" style="font-size: 10px;">photography</a> <a href="/blog/tags/php/" style="font-size: 12px;">php</a> <a href="/blog/tags/quorum/" style="font-size: 10px;">quorum</a> <a href="/blog/tags/rabbitmq/" style="font-size: 16px;">rabbitmq</a> <a href="/blog/tags/replication/" style="font-size: 10px;">replication</a> <a href="/blog/tags/sbt/" style="font-size: 10px;">sbt</a> <a href="/blog/tags/scala/" style="font-size: 10px;">scala</a> <a href="/blog/tags/spark/" style="font-size: 10px;">spark</a> <a href="/blog/tags/ssd/" style="font-size: 10px;">ssd</a> <a href="/blog/tags/storage/" style="font-size: 10px;">storage</a> <a href="/blog/tags/swift/" style="font-size: 10px;">swift</a> <a href="/blog/tags/tool-collection/" style="font-size: 10px;">tool collection</a> <a href="/blog/tags/transaction/" style="font-size: 10px;">transaction</a> <a href="/blog/tags/国史大纲/" style="font-size: 10px;">国史大纲</a> <a href="/blog/tags/洪业/" style="font-size: 10px;">洪业</a> <a href="/blog/tags/认知/" style="font-size: 10px;">认知</a>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Archives</h3>

    <div class="widget">
      <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/blog/archives/2019/03/">March 2019</a><span class="archive-list-count">4</span></li><li class="archive-list-item"><a class="archive-list-link" href="/blog/archives/2019/01/">January 2019</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/blog/archives/2018/11/">November 2018</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="/blog/archives/2018/09/">September 2018</a><span class="archive-list-count">5</span></li><li class="archive-list-item"><a class="archive-list-link" href="/blog/archives/2018/04/">April 2018</a><span class="archive-list-count">3</span></li><li class="archive-list-item"><a class="archive-list-link" href="/blog/archives/2018/03/">March 2018</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/blog/archives/2018/02/">February 2018</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/blog/archives/2017/12/">December 2017</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/blog/archives/2017/10/">October 2017</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="/blog/archives/2017/08/">August 2017</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/blog/archives/2017/07/">July 2017</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="/blog/archives/2017/06/">June 2017</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/blog/archives/2017/05/">May 2017</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/blog/archives/2017/04/">April 2017</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/blog/archives/2017/03/">March 2017</a><span class="archive-list-count">6</span></li><li class="archive-list-item"><a class="archive-list-link" href="/blog/archives/2017/02/">February 2017</a><span class="archive-list-count">4</span></li><li class="archive-list-item"><a class="archive-list-link" href="/blog/archives/2016/12/">December 2016</a><span class="archive-list-count">5</span></li><li class="archive-list-item"><a class="archive-list-link" href="/blog/archives/2016/01/">January 2016</a><span class="archive-list-count">3</span></li><li class="archive-list-item"><a class="archive-list-link" href="/blog/archives/2015/10/">October 2015</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="/blog/archives/2015/09/">September 2015</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="/blog/archives/2015/08/">August 2015</a><span class="archive-list-count">3</span></li><li class="archive-list-item"><a class="archive-list-link" href="/blog/archives/2015/07/">July 2015</a><span class="archive-list-count">1</span></li></ul>
    </div>
  </div>


  
</aside>
        
      </div>

    </div>
    <!-- <nav id="mobile-nav">
  
    <a href="/blog/" class="mobile-nav-link">Home</a>
  
    <a href="/blog/archives" class="mobile-nav-link">Archives</a>
  
    <a href="/blog/categories" class="mobile-nav-link">Categories</a>
  
    <a href="/blog/tags" class="mobile-nav-link">Tags</a>
  
    <a href="/blog/about" class="mobile-nav-link">About</a>
  
</nav> -->
    <footer id="footer" class="site-footer">
  

  <div class="clearfix container">
      <div class="site-info">
	      &copy; 2019 Bucket &amp; Hammer All Rights Reserved.
        
            <span id="busuanzi_container_site_uv">
              本站访客数<span id="busuanzi_value_site_uv"></span>人次  
              本站总访问量<span id="busuanzi_value_site_pv"></span>次
            </span>
          
      </div>
      <div class="site-credit">
        Theme by <a href="https://github.com/iTimeTraveler/hexo-theme-hipaper" target="_blank">hipaper</a>
      </div>
  </div>
</footer>


<!-- min height -->

<script>
    var wrapdiv = document.getElementById("wrap");
    var contentdiv = document.getElementById("content");

    wrapdiv.style.minHeight = document.body.offsetHeight - document.getElementById("allheader").offsetHeight - document.getElementById("footer").offsetHeight + "px";
    contentdiv.style.minHeight = document.body.offsetHeight - document.getElementById("allheader").offsetHeight - document.getElementById("footer").offsetHeight + "px";


    <!-- headerblur min height -->
    
    
</script>
    
<div style="display: none;">
  <script src="https://s11.cnzz.com/z_stat.php?id=1260716016&web_id=1260716016" language="JavaScript"></script>
</div>

<!-- mathjax config similar to math.stackexchange -->

<script type="text/x-mathjax-config">
  MathJax.Hub.Config({
    tex2jax: {
      inlineMath: [ ['$','$'], ["\\(","\\)"] ],
      processEscapes: true
    }
  });
</script>

<script type="text/x-mathjax-config">
    MathJax.Hub.Config({
      tex2jax: {
        skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code']
      }
    });
</script>

<script type="text/x-mathjax-config">
    MathJax.Hub.Queue(function() {
        var all = MathJax.Hub.getAllJax(), i;
        for(i=0; i < all.length; i += 1) {
            all[i].SourceElement().parentNode.className += ' has-jax';
        }
    });
</script>

<script type="text/javascript" src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML">
</script>


  <link rel="stylesheet" href="/blog/fancybox/jquery.fancybox.css">
  <script src="/blog/fancybox/jquery.fancybox.pack.js"></script>


<script src="/blog/js/script.js"></script>
<script src="/blog/js/bootstrap.js"></script>
<script src="/blog/js/main.js"></script>








	<script async src="//dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js">
	</script>






  </div>

  <a id="rocket" href="#top" class=""></a>
  <script type="text/javascript" src="/js/totop.js" async=""></script>
</body>
</html>
